<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Recipes with Angular.js</title>
<link href="stylesheet.css" type="text/css" rel="stylesheet" />
</head>
<body>
<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<ul class='toc no-parts'>
  <li>
    <a href='#preface'>Preface</a>
    <ul>
      <li>
        <a href='#introduction'>Introduction</a>
      </li>
      <li>
        <a href='#code-examples'>Code Examples</a>
      </li>
      <li>
        <a href='#how-to-contact-me'>How to contact me</a>
      </li>
      <li>
        <a href='#acknowledgements'>Acknowledgements</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#an-introduction-to-angularjs'>An Introduction to Angular.js</a>
    <ul>
      <li>
        <a href='#including-the-angularjs-library-code-in-an-html-page'>Including the Angular.js Library Code in an HTML Page</a>
      </li>
      <li>
        <a href='#binding-a-text-input-to-an-expression'>Binding a Text Input to an Expression</a>
      </li>
      <li>
        <a href='#responding-to-click-events-using-controllers'>Responding to Click Events using Controllers</a>
      </li>
      <li>
        <a href='#converting-expression-output-with-filters'>Converting Expression Output with Filters</a>
      </li>
      <li>
        <a href='#creating-custom-html-elements-with-directives'>Creating Custom HTML Elements with Directives</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#controllers'>Controllers</a>
    <ul>
      <li>
        <a href='#assigning-a-default-value-to-a-model'>Assigning a Default Value to a Model</a>
      </li>
      <li>
        <a href='#changing-a-model-value-with-a-controller-function'>Changing a Model Value with a Controller Function</a>
      </li>
      <li>
        <a href='#encapsulating-a-model-value-with-a-controller-function'>Encapsulating a Model Value with a Controller Function</a>
      </li>
      <li>
        <a href='#responding-to-scope-changes'>Responding to Scope Changes</a>
      </li>
      <li>
        <a href='#sharing-models-between-nested-controllers'>Sharing Models Between Nested Controllers</a>
      </li>
      <li>
        <a href='#sharing-code-between-controllers-using-services'>Sharing Code Between Controllers using Services</a>
      </li>
      <li>
        <a href='#testing-controllers'>Testing Controllers</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#directives'>Directives</a>
    <ul>
      <li>
        <a href='#enablingdisabling-dom-elements-conditionally'>Enabling/Disabling DOM Elements Conditionally</a>
      </li>
      <li>
        <a href='#changing-the-dom-in-response-to-user-actions'>Changing the DOM in Response to User Actions</a>
      </li>
      <li>
        <a href='#rendering-an-html-snippet-in-a-directive'>Rendering an HTML Snippet in a Directive</a>
      </li>
      <li>
        <a href='#rendering-a-directives-dom-node-children'>Rendering a Directive&#x2019;s DOM Node Children</a>
      </li>
      <li>
        <a href='#passing-configuration-params-using-html-attributes'>Passing Configuration Params Using HTML Attributes</a>
      </li>
      <li>
        <a href='#repeatedly-rendering-directives-dom-node-children'>Repeatedly Rendering Directive&#x2019;s DOM Node Children</a>
      </li>
      <li>
        <a href='#directive-to-directive-communication'>Directive-to-Directive Communication</a>
      </li>
      <li>
        <a href='#testing-directives'>Testing Directives</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#filters'>Filters</a>
    <ul>
      <li>
        <a href='#formatting-a-string-with-a-currency-filter'>Formatting a String With a Currency Filter</a>
      </li>
      <li>
        <a href='#implementing-a-custom-filter-to-reverse-an-input-string'>Implementing a Custom Filter to Reverse an Input String</a>
      </li>
      <li>
        <a href='#passing-configuration-params-to-filters'>Passing Configuration Params to Filters</a>
      </li>
      <li>
        <a href='#filtering-a-list-of-dom-nodes'>Filtering a List of DOM Nodes</a>
      </li>
      <li>
        <a href='#chaining-filters-together'>Chaining Filters together</a>
      </li>
      <li>
        <a href='#testing-filters'>Testing Filters</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#consuming-externals-services'>Consuming Externals Services</a>
    <ul>
      <li>
        <a href='#requesting-json-data-with-ajax'>Requesting JSON Data with AJAX</a>
      </li>
      <li>
        <a href='#consuming-restful-apis'>Consuming RESTful APIs</a>
      </li>
      <li>
        <a href='#consuming-jsonp-apis'>Consuming JSONP APIs</a>
      </li>
      <li>
        <a href='#deferred-and-promise'>Deferred and Promise</a>
      </li>
      <li>
        <a href='#testing-services'>Testing Services</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#urls-routing-and-partials'>URLs, Routing and Partials</a>
    <ul>
      <li>
        <a href='#client-side-routing-with-hashbang-urls'>Client-Side Routing with Hashbang URLs</a>
      </li>
      <li>
        <a href='#using-regular-urls-with-the-html5-history-api'>Using Regular URLs with the HTML5 History API</a>
      </li>
      <li>
        <a href='#using-route-location-to-implement-a-navigation-menu'>Using Route Location to Implement a Navigation Menu</a>
      </li>
      <li>
        <a href='#listening-on-route-changes-to-implement-a-login-mechanism'>Listening on Route Changes to Implement a Login Mechanism</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#using-forms'>Using Forms</a>
    <ul>
      <li>
        <a href='#implementing-a-basic-form'>Implementing a Basic Form</a>
      </li>
      <li>
        <a href='#validating-a-form-model-client-side'>Validating a Form Model Client-Side</a>
      </li>
      <li>
        <a href='#displaying-form-validation-errors'>Displaying Form Validation Errors</a>
      </li>
      <li>
        <a href='#displaying-form-validation-errors-with-the-twitter-bootstrap-framework'>Displaying Form Validation Errors with the Twitter Bootstrap framework</a>
      </li>
      <li>
        <a href='#only-enabling-the-submit-button-if-the-form-is-valid'>Only Enabling the Submit Button if the Form is Valid</a>
      </li>
      <li>
        <a href='#implementing-custom-validations'>Implementing Custom Validations</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#common-user-interface-patterns'>Common User Interface Patterns</a>
    <ul>
      <li>
        <a href='#filtering-and-sorting-a-list'>Filtering and Sorting a List</a>
      </li>
      <li>
        <a href='#paginating-through-client-side-data'>Paginating Through Client-Side Data</a>
      </li>
      <li>
        <a href='#paginating-through-server-side-data'>Paginating Through Server-Side Data</a>
      </li>
      <li>
        <a href='#paginating-using-infinite-results'>Paginating Using Infinite Results</a>
      </li>
      <li>
        <a href='#displaying-a-flash-noticefailure-message'>Displaying a Flash Notice/Failure Message</a>
      </li>
      <li>
        <a href='#editing-text-in-place-using-html5-contenteditable'>Editing Text In-Place using HTML5 ContentEditable</a>
      </li>
      <li>
        <a href='#displaying-a-modal-dialog'>Displaying a Modal Dialog</a>
      </li>
      <li>
        <a href='#displaying-a-loading-spinner'>Displaying a Loading Spinner</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#backend-integration-with-ruby-on-rails'>Backend Integration with Ruby on Rails</a>
    <ul>
      <li>
        <a href='#consuming-rest-apis'>Consuming REST APIs</a>
      </li>
      <li>
        <a href='#implementing-client-side-routing'>Implementing Client-Side Routing</a>
      </li>
      <li>
        <a href='#validating-forms-server-side'>Validating Forms Server-Side</a>
      </li>
    </ul>
  </li>
  <li>
    <a href='#backend-integration-with-node-express'>Backend Integration with Node Express</a>
    <ul>
      <li>
        <a href='#consuming-rest-apis-1'>Consuming REST APIs</a>
      </li>
      <li>
        <a href='#implementing-client-side-routing-1'>Implementing Client-Side Routing</a>
      </li>
    </ul>
  </li>
</ul>

</ol>
</div>
<div id="leanpub-main">
<h2 id="preface">Preface</h2>

<h3 id="introduction">Introduction</h3>
<p>Angular.js is an open-source Javascript MVC (Model-View-Controller) framework developed by Google. It gives Javascript developers a highly structured approach to developing rich browser-based applications which, leads to very high productivity.</p>

<p>If you are using Angular.js, or considering it, this cookbook provides easy-to-follow recipes for issues you are likely to face. Each recipe solves a specific problem and provides a solution and in-depth discussion of it.</p>

<h3 id="code-examples">Code Examples</h3>
<p>All code examples in this book can be found on <a href="http://github.com/fdietz/recipes-with-angular-js-examples">Github</a>.</p>

<h3 id="how-to-contact-me">How to contact me</h3>
<p>If you have questions or comments please get in touch with:</p>

<p>Frederik Dietz (fdietz@gmail.com)</p>

<h3 id="acknowledgements">Acknowledgements</h3>
<p>Special thanks go to my english editor and friend Robert William Smales!</p>

<p>Thanks go to John Lindquist for his excellent screencast project <a href="http://egghead.io/">Egghead IO</a>, Lukas Ruebbelke for his awesome <a href="http://www.youtube.com/user/simpulton/videos?flow=grid&amp;view=0">videos</a>, Matias Niemela for his great <a href="http://www.yearofmoo.com/">blog</a>. And of course the whole development team behind Angular.js!</p>

<h2 id="an-introduction-to-angularjs">An Introduction to Angular.js</h2>

<h3 id="including-the-angularjs-library-code-in-an-html-page">Including the Angular.js Library Code in an HTML Page</h3>

<h4 id="problem">Problem</h4>
<p>You wish to use Angular.js on a web page.</p>

<h4 id="solution">Solution</h4>
<p>In order to get your first Angular.js app up and running you need to include the Angular Javascript file via <code>script</code> tag and make use of the <code>ng-app</code> directive.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;html&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;head&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;script</code> <code class="na">src=</code><code class="s">"http://ajax.googleapis.com/ajax/libs/</code>
<code class="lineno"> 4</code> <code class="s">      angularjs/1.0.4/angular.js"</code><code class="nt">&gt;</code>
<code class="lineno"> 5</code>     <code class="nt">&lt;/script&gt;</code>
<code class="lineno"> 6</code>   <code class="nt">&lt;/head&gt;</code>
<code class="lineno"> 7</code>   <code class="nt">&lt;body</code> <code class="err">ng-app</code><code class="nt">&gt;</code>
<code class="lineno"> 8</code>     <code class="nt">&lt;p&gt;</code>This is your first angular expression: {{ 1 + 2 }}<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 9</code>   <code class="nt">&lt;/body&gt;</code>
<code class="lineno">10</code> <code class="nt">&lt;/html&gt;</code>
</pre></div>

</div>

<table class="tip sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="images/leanpub_tip.png" alt="tip">
</td>
    <td>
      <p>Tip: You can check out a complete example on <a href="http://github.com/fdietz/recipes-with-angular-js-examples/chapter1/recipe1">github</a>.</p>

    </td>
  </tr></tbody></table>
<h4 id="discussion">Discussion</h4>
<p>Adding the <code>ng-app</code> directive tells Angular to kick in its magic. The expression <code>{{ 1 + 2 }}</code> is evaluated by Angular and the result <code>3</code> is rendered. Note that removing <code>ng-app</code> will result in the browser rendering the expression as is instead of evaluating it. Play around with the expression! You can, for instance, concatenate Strings and invert or combine Boolean values.</p>

<p>For reasons of brevity we will skip the boilerplate code in the following recipes.</p>

<h3 id="binding-a-text-input-to-an-expression">Binding a Text Input to an Expression</h3>

<h4 id="problem-1">Problem</h4>
<p>You want user input to be used in another part of your HTML page.</p>

<h4 id="solution-1">Solution</h4>
<p>Use Angulars <code>ng-model</code> directive to bind the text input to the expression.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">Enter</code> <code class="nx">your</code> <code class="nb">name</code><code class="p">:</code> <code class="o">&lt;</code><code class="nb">input</code> <code class="k">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="nx">ng</code><code class="na">-model</code><code class="o">=</code><code class="s2">"name"</code><code class="o">&gt;&lt;/</code><code class="nb">input</code><code class="o">&gt;</code>
<code class="lineno">2</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Hello</code> <code class="p">{{</code><code class="nb">name</code><code class="p">}}</code><code class="o">!&lt;/</code><code class="nx">p</code><code class="o">&gt;</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter1/recipe2">github</a>.</p>

<h4 id="discussion-1">Discussion</h4>
<p>Assigning &ldquo;name&rdquo; to the <code>ng-model</code> attribute and using the name variable in an expression will keep both in sync automatically. Typing in the text input will automatically reflect these changes in the paragraph element below.</p>

<p>Consider how you would implement this traditionally using jQuery:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;html&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;head&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;script</code> <code class="na">src=</code><code class="s">"http://code.jquery.com/jquery.min.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="lineno"> 4</code>   <code class="nt">&lt;/head&gt;</code>
<code class="lineno"> 5</code>   <code class="nt">&lt;body&gt;</code>
<code class="lineno"> 6</code>     Enter your name: <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code><code class="nt">&gt;&lt;/input&gt;</code>
<code class="lineno"> 7</code>     <code class="nt">&lt;p</code> <code class="na">id=</code><code class="s">"name"</code><code class="nt">&gt;&lt;/p&gt;</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>     <code class="nt">&lt;script&gt;</code>
<code class="lineno">10</code>       $(document).ready(function() {
<code class="lineno">11</code>         $("input").keypress(function() {
<code class="lineno">12</code>           $("#name").text($(this).val());
<code class="lineno">13</code>         });
<code class="lineno">14</code>       });
<code class="lineno">15</code>     <code class="nt">&lt;/script&gt;</code>
<code class="lineno">16</code> 
<code class="lineno">17</code>   <code class="nt">&lt;/body&gt;</code>
<code class="lineno">18</code> <code class="nt">&lt;/html&gt;</code>
</pre></div>

</div>

<p>On document ready we bind to the keypress event in the text input and replace the text in the paragraph in the callback function. Using jQuery you need to deal with document ready callbacks, element selection, event binding and the context of this. Quite a lot of concepts to swallow and lines of code to maintain!</p>

<h3 id="responding-to-click-events-using-controllers">Responding to Click Events using Controllers</h3>

<h4 id="problem-2">Problem</h4>
<p>You wish to hide an HTML element on button click.</p>

<h4 id="solution-2">Solution</h4>
<p>Use the <code>ng-hide</code> directive in conjunction with a controller to change the visibility status on button click.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;html&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;head&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;script</code> <code class="na">src=</code><code class="s">"js/angular.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="lineno"> 4</code>     <code class="nt">&lt;script</code> <code class="na">src=</code><code class="s">"js/app.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="lineno"> 5</code>     <code class="nt">&lt;link</code> <code class="na">rel=</code><code class="s">"stylesheet"</code> <code class="na">href=</code><code class="s">"css/bootstrap.css"</code><code class="nt">&gt;</code>
<code class="lineno"> 6</code>   <code class="nt">&lt;/head&gt;</code>
<code class="lineno"> 7</code>   <code class="nt">&lt;body</code> <code class="err">ng-app</code><code class="nt">&gt;</code>
<code class="lineno"> 8</code>     <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 9</code>       <code class="nt">&lt;button</code> <code class="na">ng-click=</code><code class="s">"toggle()"</code><code class="nt">&gt;</code>Toggle<code class="nt">&lt;/button&gt;</code>
<code class="lineno">10</code>       <code class="nt">&lt;p</code> <code class="na">ng-show=</code><code class="s">"visible"</code><code class="nt">&gt;</code>Hello World!<code class="nt">&lt;/p&gt;</code>
<code class="lineno">11</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">12</code>   <code class="nt">&lt;/body&gt;</code>
<code class="lineno">13</code> <code class="nt">&lt;/html&gt;</code>
</pre></div>

</div>

<p>And the controller in <code>js/app.js</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">function</code> <code class="nx">MyCtrl</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">visible</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno">3</code> 
<code class="lineno">4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">toggle</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">5</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">visible</code> <code class="o">=</code> <code class="o">!</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">visible</code><code class="p">;</code>
<code class="lineno">6</code>   <code class="p">};</code>
<code class="lineno">7</code> <code class="p">}</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter1/recipe3">github</a>.</p>

<p>When toggling the button the &ldquo;Hello World&rdquo; paragraph will change its visibility.</p>

<h4 id="discussion-2">Discussion</h4>
<p>Using the <code>ng-controller</code> directive, we bind the <code>div</code> element including its children to the context of the <code>MyCtrl</code> controller. The <code>ng-click</code> directive will call the <code>toggle()</code> function of our controller on button click. Note that the <code>ng-show</code> directive is bound to the <code>visible</code> scope variable and will toggle the paragraph&rsquo;s visibility accordingly.</p>

<p>The controller implementation defaults the <code>visible</code> attribute to true and toggles its Boolean state in the <code>toggle</code> function. Both the <code>visible</code> variable and the <code>toggle</code> function are defined on the <code>$scope</code> service which is passed to all controller functions automatically via dependency injection.</p>

<p>The next chapter will go into all the details of controllers in Angular. For now let us quickly discuss the MVVM (Model-View-ViewModel) pattern as used by Angular. In the MVVM pattern the model is plain Javascript, the view is the HTML template and the ViewModel is the glue between the template and the model. The ViewModel makes Angular&rsquo;s two-way binding possible where changes in the model or the template are in sync automatically.</p>

<p>In our example, the <code>visible</code> attribute is the model, but it could of course be much more complex , when for example retrieving data from a backend service. The controller is used to define the scope which represents the ViewModel. It interacts with the HTML template by binding the scope variable <code>visible</code> and the function <code>toggle()</code> to it.</p>

<h3 id="converting-expression-output-with-filters">Converting Expression Output with Filters</h3>

<h4 id="problem-3">Problem</h4>
<p>When presenting data to the user, you might need to convert the data to a more user-friendly format. In our case we want to uppercase the <code>name</code> value from the previous recipe in the expression.</p>

<h4 id="solution-3">Solution</h4>
<p>Use the <code>uppercase</code> Angular filter.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">Enter</code> <code class="nx">your</code> <code class="nb">name</code><code class="p">:</code> <code class="o">&lt;</code><code class="nb">input</code> <code class="k">type</code><code class="o">=</code><code class="s2">"text"</code> <code class="nx">ng</code><code class="na">-model</code><code class="o">=</code><code class="s2">"name"</code><code class="o">&gt;&lt;/</code><code class="nb">input</code><code class="o">&gt;</code>
<code class="lineno">2</code> <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;</code><code class="nx">Hello</code> <code class="p">{{</code><code class="nb">name</code> <code class="o">|</code> <code class="nb">uppercase</code> <code class="p">}}</code><code class="o">!&lt;/</code><code class="nx">p</code><code class="o">&gt;</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter1/recipe4">github</a>.</p>

<h4 id="discussion-3">Discussion</h4>
<p>Angular uses the <code>|</code> (pipe) character to combine filters with variables in expressions. When evaluating the expression, the name variable is passed to the uppercase filter. This is similar to working with the Unix bash pipe symbol where an input can be transformed by another program. Also try the <code>lowercase</code> filter!</p>

<h3 id="creating-custom-html-elements-with-directives">Creating Custom HTML Elements with Directives</h3>

<h4 id="problem-4">Problem</h4>
<p>You wish to render an HTML snippet but hide it conditionally.</p>

<h4 id="solution-4">Solution</h4>
<p>Create a custom directive which renders your Hello World snippet.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;label</code> <code class="na">for=</code><code class="s">"checkbox"</code><code class="nt">&gt;</code>
<code class="lineno">3</code>     <code class="nt">&lt;input</code> <code class="na">id=</code><code class="s">"checkbox"</code> <code class="na">type=</code><code class="s">"checkbox"</code> <code class="na">ng-model=</code><code class="s">"visible"</code><code class="nt">&gt;</code>Toggle me
<code class="lineno">4</code>   <code class="nt">&lt;/label&gt;</code>
<code class="lineno">5</code>   <code class="nt">&lt;div</code> <code class="na">show=</code><code class="s">"visible"</code><code class="nt">&gt;</code>
<code class="lineno">6</code>     <code class="nt">&lt;p&gt;</code>Hello World<code class="nt">&lt;/p&gt;</code>
<code class="lineno">7</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">8</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>The <code>show</code> attribute is our directive, with the following implementation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">directive</code><code class="p">(</code><code class="s2">"show"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="nx">link</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">scope</code><code class="p">,</code> <code class="nx">element</code><code class="p">,</code> <code class="nx">attributes</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>       <code class="nx">scope</code><code class="p">.</code><code class="nx">$watch</code><code class="p">(</code><code class="nx">attributes</code><code class="p">.</code><code class="nx">show</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">value</code><code class="p">){</code>
<code class="lineno"> 7</code>         <code class="nx">element</code><code class="p">.</code><code class="nx">css</code><code class="p">(</code><code class="s1">'display'</code><code class="p">,</code> <code class="nx">value</code> <code class="o">?</code> <code class="s1">''</code> <code class="o">:</code> <code class="s1">'none'</code><code class="p">);</code>
<code class="lineno"> 8</code>       <code class="p">});</code>
<code class="lineno"> 9</code>     <code class="p">}</code>
<code class="lineno">10</code>   <code class="p">};</code>
<code class="lineno">11</code> <code class="p">});</code>
</pre></div>

</div>

<p>The browser will only show the &ldquo;Hello World&rdquo; paragraph if the checkbox is checked and will hide it otherwise.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter1/recipe5">github</a>.</p>

<h4 id="discussion-4">Discussion</h4>
<p>Let us ignore the <code>app</code> module creation for now and look into it in more depth in a later chapter. In our example it is just the means to create a directive. Note that the <code>show</code> String is name of the directive which corresponds to the <code>show</code> HTML attribute used in the template.</p>

<p>The directive implementation returns a <code>link</code> function which defines the directive&rsquo;s behavior. It gets passed the <code>scope</code>, the HTML <code>element</code> and the HTML <code>attributes</code>. Since we passed the <code>visible</code> variable as an attribute to our <code>show</code> directive, we can access it directly via <code>attributes.show</code>. But, since we want to respond to <code>visible</code> variable changes automatically we have to use the <code>$watch</code> service, which provides us with a function callback whenever the value changes. In this callback we change the CSS <code>display</code> property to either blank or <code>none</code> to hide the HTML element.</p>

<p>This was just a small glimpse of what can be achieved with directives and there is a whole chapter dedicated to them that goes into much more detail.</p>

<h2 id="controllers">Controllers</h2>
<p>Controllers in Angular provide the business logic to handle view behavior, for example responding to a user clicking a button or entering some text in a form. Additionally, controllers prepare the model for the view template.</p>

<p>As a general rule, a controller should not reference or manipulate the DOM directly. This has the benefit of simplifying unit testing controllers.</p>

<h3 id="assigning-a-default-value-to-a-model">Assigning a Default Value to a Model</h3>

<h4 id="problem-5">Problem</h4>
<p>You wish to assign a default value to the scope in the controller&rsquo;s context.</p>

<h4 id="solution-5">Solution</h4>
<p>Use the <code>ng-controller</code> directive in your template:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;p&gt;</code>{{value}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">3</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>Next, define the scope variable in your controller function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">MyCtrl</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="s2">"some value"</code><code class="p">;</code>
<code class="lineno">3</code> <code class="p">};</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter2/recipe1">github</a>.</p>

<h4 id="discussion-5">Discussion</h4>
<p>Depending on where you use the ng-controller directive, you define its assigned scope. The scope is hierarchical and follows the DOM node hierarchy. In our example, the value expression is correctly evaluated to <code>some value</code>, since value is set in the <code>MyCtrl</code> controller. Note that this would not work if the value expression were moved outside the controllers scope:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;p&gt;</code>{{value}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">2</code> 
<code class="lineno">3</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">4</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>In this case <code>{{value}}</code> will simply be not rendered at all due to the fact that expression evaluation in Angular.js is forgiving for <code>undefined</code> and <code>null</code> values.</p>

<h3 id="changing-a-model-value-with-a-controller-function">Changing a Model Value with a Controller Function</h3>

<h4 id="problem-6">Problem</h4>
<p>You wish to increment a model value by 1 using a controller function.</p>

<h4 id="solution-6">Solution</h4>
<p>Implement an increment function that changes the scope.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">function</code> <code class="nx">MyCtrl</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
<code class="lineno">3</code> 
<code class="lineno">4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">incrementValue</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">increment</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">5</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">value</code> <code class="o">+=</code> <code class="nx">increment</code><code class="p">;</code>
<code class="lineno">6</code>   <code class="p">};</code>
<code class="lineno">7</code> <code class="p">}</code>
</pre></div>

</div>

<p>This function can be directly called in an expression, in our example we use <code>ng-init</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;p</code> <code class="na">ng-init=</code><code class="s">"incrementValue(1)"</code><code class="nt">&gt;</code>{{value}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">3</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter2/recipe2">github</a>.</p>

<h4 id="discussion-6">Discussion</h4>
<p>The <code>ng-init</code> directive is executed on page load and calls the function <code>incrementValue</code> defined in <code>MyCtrl</code>. Functions are defined on the scope very similar to values but must be called with the familiar parenthesis syntax.</p>

<p>Of course, it would have been possible to increment the value right inside of the expression with <code>value = value +1</code> but imagine the function being much more complex! Moving this function into a controller separates our business logic from our declarative view template and we can easily write unit tests for it.</p>

<h3 id="encapsulating-a-model-value-with-a-controller-function">Encapsulating a Model Value with a Controller Function</h3>

<h4 id="problem-7">Problem</h4>
<p>You wish to retrieve a model via function (instead of directly accessing the scope from the template) that encapsulates the model value.</p>

<h4 id="solution-7">Solution</h4>
<p>Define a getter function that returns the model value.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">function</code> <code class="nx">MyCtrl</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">value</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
<code class="lineno">3</code> 
<code class="lineno">4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">getIncrementedValue</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">5</code>     <code class="k">return</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">value</code> <code class="o">+</code> <code class="mi">1</code><code class="p">;</code>
<code class="lineno">6</code>   <code class="p">};</code>
<code class="lineno">7</code> <code class="p">}</code>
</pre></div>

</div>

<p>Then in the template we use an expression to call it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;p&gt;</code>{{getIncrementedValue()}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">3</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter2/recipe3">github</a>.</p>

<h4 id="discussion-7">Discussion</h4>
<p><code>MyCtrl</code> defines the <code>getIncrementedValue</code> function, which uses the current value and returns it incremented by one. One could argue that depending on the use case it would make more sense to use a filter. But there are use cases specific to the controllers behavior where a generic filter is not required.</p>

<h3 id="responding-to-scope-changes">Responding to Scope Changes</h3>

<h4 id="problem-8">Problem</h4>
<p>You wish to react on a model change to trigger some further actions. In our example we simple want to set another model value depending on the value we are listening to.</p>

<h4 id="solution-8">Solution</h4>
<p>Use the <code>$watch</code> function in your controller.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">function</code> <code class="nx">MyCtrl</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">name</code> <code class="o">=</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">3</code> 
<code class="lineno">4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">$watch</code><code class="p">(</code><code class="s2">"name"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">newValue</code><code class="p">,</code> <code class="nx">oldValue</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">5</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">name</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">6</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">greeting</code> <code class="o">=</code> <code class="s2">"Greetings "</code> <code class="o">+</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>
<code class="lineno">7</code>     <code class="p">}</code>
<code class="lineno">8</code>   <code class="p">});</code>
<code class="lineno">9</code> <code class="p">}</code>
</pre></div>

</div>

<p>In our example we use the text input value to print a friendly greeting.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"name"</code> <code class="na">placeholder=</code><code class="s">"Enter your name"</code><code class="nt">&gt;</code>
<code class="lineno">3</code>   <code class="nt">&lt;p&gt;</code>{{greeting}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">4</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>The value <code>greeting</code> will be changed whenever there&rsquo;s a change to the <code>name</code> model and the value is not blank.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter2/recipe4">github</a>.</p>

<h4 id="discussion-8">Discussion</h4>
<p>The first argument <code>name</code> of the <code>$watch</code> function is actually an Angular expression, so you can use more complex expressions (for example: <code>[value1, value2] | json</code>) or even a Javascript function. In this case you need to return a string in the watcher function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">$watch</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="k">return</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>
<code class="lineno">3</code> <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">newValue</code><code class="p">,</code> <code class="nx">oldValue</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">4</code>   <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"change detected: "</code> <code class="o">+</code> <code class="nx">newValue</code><code class="p">)</code>
<code class="lineno">5</code> <code class="p">});</code>
</pre></div>

</div>

<p>The second argument is a function which gets called whenever the expression evaluation returns a different value. The first parameter is the new value and the second parameter the old value. Internally, this uses <code>angular.equals</code> to determine equality which means both objects or values pass the <code>===</code> comparison.</p>

<h3 id="sharing-models-between-nested-controllers">Sharing Models Between Nested Controllers</h3>

<h4 id="problem-9">Problem</h4>
<p>You wish to share a model between a nested hierarchy of controllers.</p>

<h4 id="solution-9">Solution</h4>
<p>Use Javascript objects instead of primitives or direct <code>$parent</code> scope references.</p>

<p>Our example template uses a controller <code>MyCtrl</code> and a nested controller <code>MyNestedCtrl</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;label&gt;</code>Primitive<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 4</code>     <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"name"</code><code class="nt">&gt;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>     <code class="nt">&lt;label&gt;</code>Object<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 7</code>     <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.name"</code><code class="nt">&gt;</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"nested"</code> <code class="na">ng-controller=</code><code class="s">"MyNestedCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">10</code>       <code class="nt">&lt;label&gt;</code>Primitive<code class="nt">&lt;/label&gt;</code>
<code class="lineno">11</code>       <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"name"</code><code class="nt">&gt;</code>
<code class="lineno">12</code> 
<code class="lineno">13</code>       <code class="nt">&lt;label&gt;</code>Primitive with explicit $parent reference<code class="nt">&lt;/label&gt;</code>
<code class="lineno">14</code>       <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"$parent.name"</code><code class="nt">&gt;</code>
<code class="lineno">15</code> 
<code class="lineno">16</code>       <code class="nt">&lt;label&gt;</code>Object<code class="nt">&lt;/label&gt;</code>
<code class="lineno">17</code>       <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.name"</code><code class="nt">&gt;</code>
<code class="lineno">18</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">19</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">20</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>The <code>app.js</code> file contains the controller definition and initializes the scope with some defaults:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"MyCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">name</code> <code class="o">=</code> <code class="s2">"Peter"</code><code class="p">;</code>
<code class="lineno"> 5</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">user</code> <code class="o">=</code> <code class="p">{</code>
<code class="lineno"> 6</code>     <code class="nx">name</code><code class="o">:</code> <code class="s2">"Parker"</code>
<code class="lineno"> 7</code>   <code class="p">};</code>
<code class="lineno"> 8</code> <code class="p">});</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"MyNestedCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">11</code> <code class="p">});</code>
</pre></div>

</div>

<p>Play around with the various input fields and see how changes affect each other.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter2/recipe5">github</a>.</p>

<h4 id="discussion-9">Discussion</h4>
<p>All the default values are defined in <code>MyCtrl</code> which is the parent of <code>MyNestedCtrl</code>. When making changes in the first input field, the changes will be in sync with the other input fields bound to the <code>name</code> variable. They all share the same scope variable as long as they only read from the variable. If you change the nested value, a copy in the scope of the <code>MyNestedCtrl</code> will be created. From now on, changing the first input field will only change the nested input field which explicitly references the parent scope via <code>$parent.name</code> expression.</p>

<p>The object-based value behaves differently in this regard. Whether you change the nested or the <code>MyCtrl</code> scopes input fields, the changes will stay in sync. In Angular, a scope prototypically inherits properties from a parent scope. Objects are therefore references and kept in sync. Whereas primitive types are only in sync as long they are not changed in the child scope.</p>

<p>Generally I tend to not use <code>$parent.name</code> and instead always use objects to share model properties. If you use <code>$parent.name</code> the <code>MyNestedCtrl</code> not only requires certain model attributes but also a correct scope hierarchy to work with.</p>

<table class="tip sidebarish"><tbody><tr>
<td class="sidebar-icon">
      <img class="sidebar-image" src="images/leanpub_tip.png" alt="tip">
</td>
    <td>
      <p>Tip: The Chrome plugin <a href="https://github.com/angular/angularjs-batarang">Batarang</a> simplifies debugging the scope hierarchy by showing you a tree of the nested scopes. It is awesome!</p>

    </td>
  </tr></tbody></table>
<h3 id="sharing-code-between-controllers-using-services">Sharing Code Between Controllers using Services</h3>

<h4 id="problem-10">Problem</h4>
<p>You wish to share business logic between controllers.</p>

<h4 id="solution-10">Solution</h4>
<p>Utilise a <a href="http://docs.angularjs.org/guide/dev_guide.services">Service</a> to implement your business logic and use dependency injection to use this service in your controllers.</p>

<p>The template shows access to a list of users from two controllers:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;ul</code> <code class="na">ng-repeat=</code><code class="s">"user in users"</code><code class="nt">&gt;</code>
<code class="lineno">3</code>     <code class="nt">&lt;li&gt;</code>{{user}}<code class="nt">&lt;/li&gt;</code>
<code class="lineno">4</code>   <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">5</code>   <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"nested"</code> <code class="na">ng-controller=</code><code class="s">"AnotherCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">6</code>     First user: {{firstUser}}
<code class="lineno">7</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">8</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>The service and controller implementation in <code>app.js</code> implements a user service and the controllers set the scope initially:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s2">"UserService"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="kd">var</code> <code class="nx">users</code> <code class="o">=</code> <code class="cp">[</code><code class="s2">"Peter"</code><code class="p">,</code> <code class="s2">"Daniel"</code><code class="p">,</code> <code class="s2">"Nina"</code><code class="cp">]</code><code class="p">;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno"> 7</code>     <code class="nx">all</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="k">return</code> <code class="nx">users</code><code class="p">;</code>
<code class="lineno"> 9</code>     <code class="p">},</code>
<code class="lineno">10</code>     <code class="nx">first</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">11</code>       <code class="k">return</code> <code class="nx">users</code><code class="cp">[</code><code class="mi">0</code><code class="cp">]</code><code class="p">;</code>
<code class="lineno">12</code>     <code class="p">}</code>
<code class="lineno">13</code>   <code class="p">};</code>
<code class="lineno">14</code> <code class="p">});</code>
<code class="lineno">15</code> 
<code class="lineno">16</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"MyCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">UserService</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">17</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">users</code> <code class="o">=</code> <code class="nx">UserService</code><code class="p">.</code><code class="nx">all</code><code class="p">();</code>
<code class="lineno">18</code> <code class="p">});</code>
<code class="lineno">19</code> 
<code class="lineno">20</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"AnotherCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">UserService</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">21</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">firstUser</code> <code class="o">=</code> <code class="nx">UserService</code><code class="p">.</code><code class="nx">first</code><code class="p">();</code>
<code class="lineno">22</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter2/recipe6">github</a>.</p>

<h4 id="discussion-10">Discussion</h4>
<p>The <code>factory</code> method creates a singleton <code>UserService</code>, that returns two functions for retrieving all users and the first user only. The controllers get the <code>UserService</code> injected by adding it to the <code>controller</code> function as params.</p>

<p>Using dependency injection here is quite nice for testing your controllers, since you can easily inject a <code>UserService</code> stub. The only downside is that you can&rsquo;t minify the code from above without breaking it, since the injection mechanism relies on the exact string representation of <code>UserService</code>. It is therefore recommended to define dependencies using inline annotations, which keeps working even when minified:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"AnotherCtrl"</code><code class="p">,</code> <code class="cp">[</code><code class="s2">"$scope"</code><code class="p">,</code> <code class="s2">"UserService"</code><code class="p">,</code>
<code class="lineno">2</code>   <code class="nx">function</code><code class="p">(</code><code class="nv">$scope</code><code class="p">,</code> <code class="nx">UserService</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nv">$scope.firstUser</code> <code class="o">=</code> <code class="nx">UserService.first</code><code class="p">();</code>
<code class="lineno">4</code>   <code class="p">}</code>
<code class="lineno">5</code> <code class="cp">]</code><code class="p">);</code>
</pre></div>

</div>

<p>The syntax looks a bit funny, but since strings in arrays are not changed during the minification process it solves our problem. Note that you could change the parameter names of the function, since the injection mechanism relies on the order of the array definition only.</p>

<p>Another way to achieve the same is using the <code>$inject</code> annotation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">anotherCtrl</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">UserService</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">firstUser</code> <code class="o">=</code> <code class="nx">UserService</code><code class="p">.</code><code class="nx">first</code><code class="p">();</code>
<code class="lineno">3</code> <code class="p">};</code>
<code class="lineno">4</code> 
<code class="lineno">5</code> <code class="nx">anotherCtrl</code><code class="p">.</code><code class="nx">$inject</code> <code class="o">=</code> <code class="cp">[</code><code class="s2">"$scope"</code><code class="p">,</code> <code class="s2">"UserService"</code><code class="cp">]</code><code class="p">;</code>
</pre></div>

</div>

<p>This requires you to use a temporary variable to call the <code>$inject</code> service. Again, you could change the function parameter names. You will most probably see both versions applied in apps using Angular.</p>

<h3 id="testing-controllers">Testing Controllers</h3>

<h4 id="problem-11">Problem</h4>
<p>You wish to unit test your business logic.</p>

<h4 id="solution-11">Solution</h4>
<p>Implement a unit test using <a href="http://pivotal.github.com/jasmine/">Jasmine</a> and the <a href="https://github.com/angular/angular-seed">angular-seed</a> project. Following our previous <code>$watch</code> recipe, this is how our spec would look.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">describe</code><code class="p">(</code><code class="s1">'MyCtrl'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">scope</code><code class="p">,</code> <code class="nx">ctrl</code><code class="p">;</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>   <code class="nx">beforeEach</code><code class="p">(</code><code class="nx">inject</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">$controller</code><code class="p">,</code> <code class="nx">$rootScope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="nx">scope</code> <code class="o">=</code> <code class="nx">$rootScope</code><code class="p">.</code><code class="nx">$new</code><code class="p">();</code>
<code class="lineno"> 6</code>     <code class="nx">ctrl</code> <code class="o">=</code> <code class="nx">$controller</code><code class="p">(</code><code class="nx">MyCtrl</code><code class="p">,</code> <code class="p">{</code> <code class="nx">$scope</code><code class="o">:</code> <code class="nx">scope</code> <code class="p">});</code>
<code class="lineno"> 7</code>   <code class="p">}));</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'should change greeting value if name value is changed'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">10</code>     <code class="nx">scope</code><code class="p">.</code><code class="nx">name</code> <code class="o">=</code> <code class="s2">"Frederik"</code><code class="p">;</code>
<code class="lineno">11</code>     <code class="nx">scope</code><code class="p">.</code><code class="nx">$digest</code><code class="p">();</code>
<code class="lineno">12</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">scope</code><code class="p">.</code><code class="nx">greeting</code><code class="p">).</code><code class="nx">toBe</code><code class="p">(</code><code class="s2">"Greetings Frederik"</code><code class="p">);</code>
<code class="lineno">13</code>   <code class="p">});</code>
<code class="lineno">14</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter2/recipe7">github</a>.</p>

<h4 id="discussion-11">Discussion</h4>
<p>Jasmine specs use <code>describe</code> and <code>it</code> functions to group specs and <code>beforeEach</code> and <code>afterEach</code> to setup and teardown code. The actual expectation compares the greeting from the scope with our expectation <code>Greetings Frederik</code>.</p>

<p>The scope and controller initialization is a bit more involved. We use <code>inject</code> to initialize the scope and controller as closely as possible to how our code would behave at runtime too. We can&rsquo;t just initialize the scope as a Javascript object <code>{}</code> since we would then not be able to call <code>$watch</code> on it. Instead <code>$rootScope.$new()</code> will do the trick. Note that the <code>$controller</code> service requires <code>MyCtrl</code> to be available and uses an object notation to pass in dependencies.</p>

<p>The <code>$digest</code> call is required in order to trigger a watch execution after we have changed the scope. We need to call <code>$digest</code> manually in our spec whereas at runtime Angular will do this for us automatically.</p>

<h2 id="directives">Directives</h2>
<p>Directives are one of the most powerful concepts in Angular since they let you invent new HTML elements specific to your application. This allows you to create reusable components which encapsulate complex DOM structures, stylesheets and even behavior.</p>

<h3 id="enablingdisabling-dom-elements-conditionally">Enabling/Disabling DOM Elements Conditionally</h3>

<h4 id="problem-12">Problem</h4>
<p>You wish to disable a button depending on a checkbox state.</p>

<h4 id="solution-12">Solution</h4>
<p>Use the <code>ng-disabled</code> directive and bind its condition to the checkbox state.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;body</code> <code class="err">ng-app</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;label&gt;&lt;input</code> <code class="na">type=</code><code class="s">"checkbox"</code> <code class="na">ng-model=</code><code class="s">"checked"</code><code class="nt">/&gt;</code>Toggle Button<code class="nt">&lt;/label&gt;</code>
<code class="lineno">3</code>   <code class="nt">&lt;button</code> <code class="na">ng-disabled=</code><code class="s">"checked"</code><code class="nt">&gt;</code>Press me<code class="nt">&lt;/button&gt;</code>
<code class="lineno">4</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter3/recipe1">github</a>.</p>

<h4 id="discussion-12">Discussion</h4>
<p>The <code>ng-disabled</code> directive is a direct translation from the disabled HTML attribute, without you needing to worry about browser incompatibilities. It is bound to the <code>checked</code> model using an attribute value as is the checkbox using the <code>ng-model</code> directive. In fact the <code>checked</code> attribute value is again an Angular expression. You could for example invert the logic and use <code>!checked</code> instead.</p>

<p>This is just one example of a directive shipped with Angular. There are many others like for example <code>ng-hide</code>, <code>ng-checked</code> or <code>ng-mouseenter</code> and I encourage you go through the <a href="http://docs.angularjs.org/api">API Reference</a> and explore all the directives Angular has to offer.</p>

<p>In the next recipes we will focus on implementing directives.</p>

<h3 id="changing-the-dom-in-response-to-user-actions">Changing the DOM in Response to User Actions</h3>

<h4 id="problem-13">Problem</h4>
<p>You wish to change the CSS of an HTML element on a mouse click and encapsulate this behavior in a reusable component.</p>

<h4 id="solution-13">Solution</h4>
<p>Implement a directive <code>my-widget</code> that contains an example paragraph of text we want to style.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;my-widget&gt;</code>
<code class="lineno">3</code>     <code class="nt">&lt;p&gt;</code>Hello World<code class="nt">&lt;/p&gt;</code>
<code class="lineno">4</code>   <code class="nt">&lt;/my-widget&gt;</code>
<code class="lineno">5</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>We use a link function in our directive implementation to change the CSS of the paragraph.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">directive</code><code class="p">(</code><code class="s2">"myWidget"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="kd">var</code> <code class="nx">linkFunction</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">scope</code><code class="p">,</code> <code class="nx">element</code><code class="p">,</code> <code class="nx">attributes</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="kd">var</code> <code class="nx">paragraph</code> <code class="o">=</code> <code class="nx">element</code><code class="p">.</code><code class="nx">children</code><code class="p">()</code><code class="cp">[</code><code class="mi">0</code><code class="cp">]</code><code class="p">;</code>
<code class="lineno"> 6</code>     <code class="nx">$</code><code class="p">(</code><code class="nx">paragraph</code><code class="p">).</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 7</code>       <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">css</code><code class="p">({</code> <code class="s2">"background-color"</code><code class="o">:</code> <code class="s2">"red"</code> <code class="p">});</code>
<code class="lineno"> 8</code>     <code class="p">});</code>
<code class="lineno"> 9</code>   <code class="p">};</code>
<code class="lineno">10</code> 
<code class="lineno">11</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno">12</code>     <code class="nx">restrict</code><code class="o">:</code> <code class="s2">"E"</code><code class="p">,</code>
<code class="lineno">13</code>     <code class="nx">link</code><code class="o">:</code> <code class="nx">linkFunction</code>
<code class="lineno">14</code>   <code class="p">};</code>
<code class="lineno">15</code> <code class="p">});</code>
</pre></div>

</div>

<p>When clicking on the paragraph the background color changes to red.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter3/recipe2">github</a>.</p>

<h4 id="discussion-13">Discussion</h4>
<p>In the HTML document we use the new directive as an HTML element <code>my-widget</code>, which can be found in the Javascript code as <code>myWidget</code> again. The directive function returns a restriction and a link function.</p>

<p>The restriction means that this directive can only be used as an HTML element and not for example an HTML attribute. If you want to use it as an HTML attribute, change the <code>restrict</code> to return <code>A</code> instead. The usage would then have to be adapted to:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;div</code> <code class="err">my-widget</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;p&gt;</code>Hello World<code class="nt">&lt;/p&gt;</code>
<code class="lineno">3</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>Whether you use the attribute or element mechanism will depend on your use case. Generally speaking one would use the element mechanism to define a custom reusable component. The attribute mechanism would be used whenever you want to &ldquo;configure&rdquo; some element or enhance it with more behavior. Other available options are using the directive as a class attribute or a comment.</p>

<p>The <code>directive</code> method expects a function that can be used for initialization and injection of dependencies.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">directive</code><code class="p">(</code><code class="s2">"myWidget"</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">factory</code><code class="p">(</code><code class="nx">injectables</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="c1">// ...</code>
<code class="lineno">3</code> <code class="p">}</code>
</pre></div>

</div>

<p>The link function is much more interesting since it defines the actual behavior. The scope, the actual HTML element <code>my-widget</code> and the HTML attributes are passed as params. Note that this has nothing to do with Angular&rsquo;s dependency injection mechanism. Ordering of the parameters is important!</p>

<p>Firstly we select the paragraph element, which is a child of the <code>my-widget</code> element using Angular&rsquo;s <code>children()</code> function as defined by element. In the second step we use jQuery to bind to the click event and modify the css property on click. This is of particular interest since we have a mixture of Angular element functions and jQuery here. In fact under the hood Angular will use jQuery in the <code>children()</code> function if it is defined and will fall back to jqLite (shipped with Angular) otherwise. You can find all supported methods in the <a href="http://docs.angularjs.org/api/angular.element">API Reference of element</a>.</p>

<p>Following a slightly altered version of the code using jQuery only:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">element</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s2">"click"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">css</code><code class="p">({</code> <code class="s2">"background-color"</code><code class="o">:</code> <code class="s2">"red"</code> <code class="p">});</code>
<code class="lineno">3</code> <code class="p">});</code>
</pre></div>

</div>

<p>In this case <code>element</code> is alreay a jQuery element and we can directly use the <code>on</code> function.</p>

<h3 id="rendering-an-html-snippet-in-a-directive">Rendering an HTML Snippet in a Directive</h3>

<h4 id="problem-14">Problem</h4>
<p>You wish to render an HTML snippet as a reusable component.</p>

<h4 id="solution-14">Solution</h4>
<p>Implement a directive and use the <code>template</code> attribute to define the HTML.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;my-widget/&gt;</code>
<code class="lineno"> 3</code> <code class="nt">&lt;/body&gt;</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> app.directive("myWidget", function() {
<code class="lineno"> 8</code>   return {
<code class="lineno"> 9</code>     restrict: "E",
<code class="lineno">10</code>     template: "<code class="nt">&lt;p&gt;</code>Hello World<code class="nt">&lt;/p&gt;</code>"
<code class="lineno">11</code>   };
<code class="lineno">12</code> });
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter3/recipe3">github</a>.</p>

<h4 id="discussion-14">Discussion</h4>
<p>This will render the Hello World paragraph as a child node of your <code>my-widget</code> element. If you want to replace the element entirely with the paragraph you will also have to return the <code>replace</code> attribute:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app.directive</code><code class="p">(</code><code class="s2">"myWidget"</code><code class="p">,</code> <code class="nx">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">restrict</code><code class="p">:</code> <code class="s2">"E"</code><code class="p">,</code>
<code class="lineno">4</code>     <code class="nb">replace</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">5</code>     <code class="nx">template</code><code class="p">:</code> <code class="s2">"&lt;p&gt;Hello World&lt;/p&gt;"</code>
<code class="lineno">6</code>   <code class="p">};</code>
<code class="lineno">7</code> <code class="p">});</code>
</pre></div>

</div>

<p>Another option would be to use a file for the HTML snippet. In this case you will need to use the <code>templateUrl</code> attribute, for example as follows:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">directive</code><code class="p">(</code><code class="s2">"myWidget"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">restrict</code><code class="o">:</code> <code class="s2">"E"</code><code class="p">,</code>
<code class="lineno">4</code>     <code class="nx">replace</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno">5</code>     <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"widget.html"</code>
<code class="lineno">6</code>   <code class="p">};</code>
<code class="lineno">7</code> <code class="p">});</code>
</pre></div>

</div>

<p>The <code>widget.html</code> should reside in the same directory as the <code>index.html</code> file. This will only work if you use a web server to host the file. The example on Github uses angular-seed as bootstrap again.</p>

<h3 id="rendering-a-directives-dom-node-children">Rendering a Directive&rsquo;s DOM Node Children</h3>

<h4 id="problem-15">Problem</h4>
<p>Your widget uses the child nodes of the directive element to create a combined rendering.</p>

<h4 id="solution-15">Solution</h4>
<p>Use the <code>transclude</code> attribute together with the <code>ng-transclude</code> directive.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;my-widget&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;p&gt;</code>This is my paragraph text.<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 3</code> <code class="nt">&lt;/my-widget&gt;</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> app.directive("myWidget", function() {
<code class="lineno"> 8</code>   return {
<code class="lineno"> 9</code>     restrict: "E",
<code class="lineno">10</code>     transclude: true,
<code class="lineno">11</code>     template: "<code class="nt">&lt;div</code> <code class="err">ng-transclude</code><code class="nt">&gt;&lt;h3&gt;</code>Heading<code class="nt">&lt;/h3&gt;&lt;/div&gt;</code>"
<code class="lineno">12</code>   };
<code class="lineno">13</code> });
</pre></div>

</div>

<p>This will render a <code>div</code> element containing an <code>h3</code> element and append the directive&rsquo;s child node with the paragraph element below.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter3/recipe4">github</a>.</p>

<h4 id="discussion-15">Discussion</h4>
<p>In this context, transclusion refers to the inclusion of a part of a document into another document by reference. The <code>ng-transclude</code> attribute should be positioned depending on where you want your child nodes to be appended.</p>

<h3 id="passing-configuration-params-using-html-attributes">Passing Configuration Params Using HTML Attributes</h3>

<h4 id="problem-16">Problem</h4>
<p>You wish to pass a configuration param to change the rendered output.</p>

<h4 id="solution-16">Solution</h4>
<p>Use the attribute-based directive and pass an attribute value for the configuration. The attribute is passed as a parameter to the link function.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;div</code> <code class="na">my-widget=</code><code class="s">"Hello World"</code><code class="nt">&gt;&lt;/div&gt;</code>
<code class="lineno"> 3</code> <code class="nt">&lt;/body&gt;</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> app.directive("myWidget", function() {
<code class="lineno"> 8</code>   var linkFunction = function(scope, element, attributes) {
<code class="lineno"> 9</code>     scope.text = attributes<code class="cp">[</code><code class="s2">"myWidget"</code><code class="cp">]</code>;
<code class="lineno">10</code>   };
<code class="lineno">11</code> 
<code class="lineno">12</code>   return {
<code class="lineno">13</code>     restrict: "A",
<code class="lineno">14</code>     template: "<code class="nt">&lt;p&gt;</code>{{text}}<code class="nt">&lt;/p&gt;</code>",
<code class="lineno">15</code>     link: linkFunction
<code class="lineno">16</code>   };
<code class="lineno">17</code> });
</pre></div>

</div>

<p>This renders a paragraph with the text passed as the param.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter3/recipe5">github</a>.</p>

<h4 id="discussion-16">Discussion</h4>
<p>The link function has access to the element and its attributes. It is therefore straightforward to set the scope to the text passed as the attributes value and use this in the template evaluation.</p>

<p>The scope context is important though. The <code>text</code> model we changed might already be defined in the parent scope and used in another part of your app. In order to isolate the context and thereby use it only locally inside your directive, we have to return an additional scope attribute.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="k">return</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">restrict</code><code class="p">:</code> <code class="s2">"A"</code><code class="p">,</code>
<code class="lineno">3</code>   <code class="nx">template</code><code class="p">:</code> <code class="s2">"&lt;p&gt;{{text}}&lt;/p&gt;"</code><code class="p">,</code>
<code class="lineno">4</code>   <code class="k">link</code><code class="p">:</code> <code class="nx">linkFunction</code><code class="p">,</code>
<code class="lineno">5</code>   <code class="nx">scope</code><code class="p">:</code> <code class="p">{}</code>
<code class="lineno">6</code> <code class="p">};</code>
</pre></div>

</div>

<p>In Angular this is called an isolate scope. It does not prototypically inherit from the parent scope and is especially useful when creating reusable components.</p>

<p>Let&rsquo;s look into another way of passing params to the directive. This time we will define an HTML element <code>my-widget2</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;my-widget2</code> <code class="na">text=</code><code class="s">"Hello World"</code><code class="nt">&gt;&lt;/my-widget2&gt;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> app.directive("myWidget2", function() {
<code class="lineno"> 4</code>   return {
<code class="lineno"> 5</code>     restrict: "E",
<code class="lineno"> 6</code>     template: "<code class="nt">&lt;p&gt;</code>{{text}}<code class="nt">&lt;/p&gt;</code>",
<code class="lineno"> 7</code>     scope: {
<code class="lineno"> 8</code>       text: "@text"
<code class="lineno"> 9</code>     }
<code class="lineno">10</code>   };
<code class="lineno">11</code> });
</pre></div>

</div>

<p>The scope definition using <code>@text</code> is binding the text model to the directive&rsquo;s attribute. Note that any changes to the parent scope <code>text</code> will change the local scope <code>text</code>, but not the other way around.</p>

<p>If you want instead to have a bi-directional binding between the parent scope and the local scope, you should use the <code>=</code> equality character:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nl">scope:</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nl">text:</code> <code class="s">"=text"</code>
<code class="lineno">3</code> <code class="p">}</code>
</pre></div>

</div>

<p>Changes to the local scope will also change the parent scope.</p>

<p>Another option would be to pass an expression as a function to the directive using the <code>&amp;</code> character.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;my-widget-expr</code> <code class="na">fn=</code><code class="s">"count = count + 1"</code><code class="nt">&gt;&lt;/my-widget-expr&gt;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> app.directive("myWidgetExpr", function() {
<code class="lineno"> 4</code>   var linkFunction = function(scope, element, attributes) {
<code class="lineno"> 5</code>     scope.text = scope.fn({ count: 5 });
<code class="lineno"> 6</code>   };
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code>   return {
<code class="lineno"> 9</code>     restrict: "E",
<code class="lineno">10</code>     template: "<code class="nt">&lt;p&gt;</code>{{text}}<code class="nt">&lt;/p&gt;</code>",
<code class="lineno">11</code>     link: linkFunction,
<code class="lineno">12</code>     scope: {
<code class="lineno">13</code>       fn: "<code class="err">&amp;</code>fn"
<code class="lineno">14</code>     }
<code class="lineno">15</code>   };
<code class="lineno">16</code> });
</pre></div>

</div>

<p>We pass the attribute <code>fn</code> to the directive and since the local scope defines <code>fn</code> accordingly we can call the function in the <code>linkFunction</code> and pass in the expression arguments as a hash.</p>

<h3 id="repeatedly-rendering-directives-dom-node-children">Repeatedly Rendering Directive&rsquo;s DOM Node Children</h3>

<h4 id="problem-17">Problem</h4>
<p>You wish to render an HTML snippet repeatedly using the directive&rsquo;s child nodes as the &ldquo;stamp&rdquo; content.</p>

<h4 id="solution-17">Solution</h4>
<p>Implement a compile function in your directive.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;repeat-ntimes</code> <code class="na">repeat=</code><code class="s">"10"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;h1&gt;</code>Header 1<code class="nt">&lt;/h1&gt;</code>
<code class="lineno"> 3</code>   <code class="nt">&lt;p&gt;</code>This is the paragraph.<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 4</code> <code class="nt">&lt;/repeat-n-times&gt;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code> app.directive("repeatNtimes", function() {
<code class="lineno"> 9</code>   return {
<code class="lineno">10</code>     restrict: "E",
<code class="lineno">11</code>     compile: function(tElement, attrs) {
<code class="lineno">12</code>       var content = tElement.children();
<code class="lineno">13</code>       for (var i=1; i<code class="nt">&lt;attrs.repeat</code><code class="err">;</code> <code class="err">i++)</code> <code class="err">{</code>
<code class="lineno">14</code>         <code class="err">tElement.append(content.clone());</code>
<code class="lineno">15</code>       <code class="err">}</code>
<code class="lineno">16</code>     <code class="err">}</code>
<code class="lineno">17</code>   <code class="err">};</code>
<code class="lineno">18</code> <code class="err">});</code>
</pre></div>

</div>

<p>This will render the header and paragraph 10 times.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter3/recipe6">github</a>.</p>

<h4 id="discussion-17">Discussion</h4>
<p>The directive repeats the child nodes as often as configured in the <code>repeat</code> attribute. It works similarly to the <a href="http://docs.angularjs.org/api/ng.directive:ngRepeat">ng-repeat</a> directive. The implementation uses Angular&rsquo;s element methods to append the child nodes in a for loop.</p>

<p>Note that the compile method only has access to the templates element <code>tElement</code> and template attributes. It has no access to the scope and you therefore can&rsquo;t use <code>$watch</code> to add behavior either. This is in comparison to the link function that has access to the DOM &ldquo;instance&rdquo; (after the compile phase) and has access to the scope to add behavior.</p>

<p>Use the compile function for template DOM manipulation only. Use the link function whenever you want to add behavior.</p>

<p>Note that you can use both compile and link function combined. In this case the compile function must return the link function. As an example you want to react to a click on the header:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="n">compile</code><code class="o">:</code> <code class="kd">function</code><code class="o">(</code><code class="n">tElement</code><code class="o">,</code> <code class="n">attrs</code><code class="o">)</code> <code class="o">{</code>
<code class="lineno"> 2</code>   <code class="n">var</code> <code class="n">content</code> <code class="o">=</code> <code class="n">tElement</code><code class="o">.</code><code class="na">children</code><code class="o">();</code>
<code class="lineno"> 3</code>   <code class="k">for</code> <code class="o">(</code><code class="n">var</code> <code class="n">i</code><code class="o">=</code><code class="mi">1</code><code class="o">;</code> <code class="n">i</code><code class="o">&lt;</code><code class="n">attrs</code><code class="o">.</code><code class="na">repeat</code><code class="o">;</code> <code class="n">i</code><code class="o">++)</code> <code class="o">{</code>
<code class="lineno"> 4</code>     <code class="n">tElement</code><code class="o">.</code><code class="na">append</code><code class="o">(</code><code class="n">content</code><code class="o">.</code><code class="na">clone</code><code class="o">());</code>
<code class="lineno"> 5</code>   <code class="o">}</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code>   <code class="k">return</code> <code class="kd">function</code> <code class="o">(</code><code class="n">scope</code><code class="o">,</code> <code class="n">element</code><code class="o">,</code> <code class="n">attrs</code><code class="o">)</code> <code class="o">{</code>
<code class="lineno"> 8</code>     <code class="n">element</code><code class="o">.</code><code class="na">on</code><code class="o">(</code><code class="s2">"click"</code><code class="o">,</code> <code class="s2">"h1"</code><code class="o">,</code> <code class="kd">function</code><code class="o">()</code> <code class="o">{</code>
<code class="lineno"> 9</code>       <code class="n">$</code><code class="o">(</code><code class="k">this</code><code class="o">).</code><code class="n">css</code><code class="o">({</code> <code class="s2">"background-color"</code><code class="o">:</code> <code class="s2">"red"</code> <code class="o">});</code>
<code class="lineno">10</code>     <code class="o">});</code>
<code class="lineno">11</code>   <code class="o">};</code>
<code class="lineno">12</code> <code class="o">}</code>
</pre></div>

</div>

<p>Clicking the header will change the background color to red.</p>

<h3 id="directive-to-directive-communication">Directive-to-Directive Communication</h3>

<h4 id="problem-18">Problem</h4>
<p>You wish a directive to communicate with another directive and augment each other&rsquo;s behavior using a well-defined interface (API).</p>

<h4 id="solution-18">Solution</h4>
<p>We implement a directive <code>basket</code> with a controller function and two other directive <code>orange</code> and <code>apple</code> which &ldquo;require&rdquo; this controller. Our example starts with an <code>apple</code> and <code>orange</code> directive used as attributes.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;basket</code> <code class="err">apple</code> <code class="err">orange</code><code class="nt">&gt;</code>Roll over me and check the console!<code class="nt">&lt;/basket&gt;</code>
<code class="lineno">3</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>The <code>basket</code> directive manages an array to which one can add apples and oranges!</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">directive</code><code class="p">(</code><code class="s2">"basket"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="nx">restrict</code><code class="o">:</code> <code class="s2">"E"</code><code class="p">,</code>
<code class="lineno"> 6</code>     <code class="nx">controller</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">$element</code><code class="p">,</code> <code class="nx">$attrs</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">content</code> <code class="o">=</code> <code class="cp">[]</code><code class="p">;</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>       <code class="k">this</code><code class="p">.</code><code class="nx">addApple</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">10</code>         <code class="nx">$scope</code><code class="p">.</code><code class="nx">content</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="s2">"apple"</code><code class="p">);</code>
<code class="lineno">11</code>       <code class="p">};</code>
<code class="lineno">12</code> 
<code class="lineno">13</code>       <code class="k">this</code><code class="p">.</code><code class="nx">addOrange</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">14</code>         <code class="nx">$scope</code><code class="p">.</code><code class="nx">content</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="s2">"orange"</code><code class="p">);</code>
<code class="lineno">15</code>       <code class="p">};</code>
<code class="lineno">16</code>     <code class="p">},</code>
<code class="lineno">17</code>     <code class="nx">link</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">scope</code><code class="p">,</code> <code class="nx">element</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">18</code>       <code class="nx">element</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="s2">"mouseenter"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">19</code>         <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">scope</code><code class="p">.</code><code class="nx">content</code><code class="p">);</code>
<code class="lineno">20</code>       <code class="p">});</code>
<code class="lineno">21</code>     <code class="p">}</code>
<code class="lineno">22</code>   <code class="p">};</code>
<code class="lineno">23</code> <code class="p">});</code>
</pre></div>

</div>

<p>And finally the apple and orange directives, which add themselves to the basket using the basket&rsquo;s controller.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">directive</code><code class="p">(</code><code class="s2">"apple"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">require</code><code class="o">:</code> <code class="s2">"basket"</code><code class="p">,</code>
<code class="lineno"> 4</code>     <code class="nx">link</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">scope</code><code class="p">,</code> <code class="nx">element</code><code class="p">,</code> <code class="nx">attrs</code><code class="p">,</code> <code class="nx">basketCtrl</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>       <code class="nx">basketCtrl</code><code class="p">.</code><code class="nx">addApple</code><code class="p">();</code>
<code class="lineno"> 6</code>     <code class="p">}</code>
<code class="lineno"> 7</code>   <code class="p">};</code>
<code class="lineno"> 8</code> <code class="p">});</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code> <code class="nx">app</code><code class="p">.</code><code class="nx">directive</code><code class="p">(</code><code class="s2">"orange"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">11</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno">12</code>     <code class="nx">require</code><code class="o">:</code> <code class="s2">"basket"</code><code class="p">,</code>
<code class="lineno">13</code>     <code class="nx">link</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">scope</code><code class="p">,</code> <code class="nx">element</code><code class="p">,</code> <code class="nx">attrs</code><code class="p">,</code> <code class="nx">basketCtrl</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">14</code>       <code class="nx">basketCtrl</code><code class="p">.</code><code class="nx">addOrange</code><code class="p">();</code>
<code class="lineno">15</code>     <code class="p">}</code>
<code class="lineno">16</code>   <code class="p">};</code>
<code class="lineno">17</code> <code class="p">});</code>
</pre></div>

</div>

<p>If you hover with the mouse over the rendered text the console should print and the basket&rsquo;s content.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter3/recipe7">github</a>.</p>

<h4 id="discussion-18">Discussion</h4>
<p><code>Basket</code> is the example directive that demonstrates an API using the controller function, whereas the <code>apple</code> and <code>orange</code> directives augment the <code>basket</code> directive. They both define a dependency to the <code>basket</code> controller with the <code>require</code> attribute. The <code>link</code> function then gets <code>basketCtrl</code> injected.</p>

<p>Note how the <code>basket</code> directive is defined as an HTML element and the <code>apple</code> and <code>orange</code> directives are defined as HTML attributes (the default for directives). This demonstrates the typical use case of a reusable component augmented by other directives.</p>

<p>Now there might be other ways of passing data back and forth between directives - we have seen the different semantics of using the (isolated) context in directives in previous recipes - but what&rsquo;s especially great about the controller is the clear API contract it lets you define.</p>

<h3 id="testing-directives">Testing Directives</h3>

<h4 id="problem-19">Problem</h4>
<p>You wish to test your directive with a unit test. As an example we will use a tab component directive implementation, which can easily be used in your HTML document.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;tabs&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;pane</code> <code class="na">title=</code><code class="s">"First Tab"</code><code class="nt">&gt;</code>First pane.<code class="nt">&lt;/pane&gt;</code>
<code class="lineno">3</code>   <code class="nt">&lt;pane</code> <code class="na">title=</code><code class="s">"Second Tab"</code><code class="nt">&gt;</code>Second pane.<code class="nt">&lt;/pane&gt;</code>
<code class="lineno">4</code> <code class="nt">&lt;/tabs&gt;</code>
</pre></div>

</div>

<p>The directive implementation is split into the tabs and the pane directive. Let us start with the tabs directive.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app.directive</code><code class="p">(</code><code class="s2">"tabs"</code><code class="p">,</code> <code class="nx">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">restrict</code><code class="p">:</code> <code class="s2">"E"</code><code class="p">,</code>
<code class="lineno"> 4</code>     <code class="nx">transclude</code><code class="p">:</code> <code class="kc">true</code><code class="p">,</code>
<code class="lineno"> 5</code>     <code class="nx">scope</code><code class="p">:</code> <code class="p">{},</code>
<code class="lineno"> 6</code>     <code class="nx">controller</code><code class="p">:</code> <code class="nx">function</code><code class="p">(</code><code class="nv">$scope</code><code class="p">,</code> <code class="nv">$element</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7</code>       <code class="kd">var</code> <code class="n">panes</code> <code class="o">=</code> <code class="nv">$scope.panes</code> <code class="o">=</code> <code class="err">[</code><code class="cp">]</code>;
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>       $scope.select = function(pane) {
<code class="lineno">10</code>         angular.forEach(panes, function(pane) {
<code class="lineno">11</code>           pane.selected = false;
<code class="lineno">12</code>         });
<code class="lineno">13</code>         pane.selected = true;
<code class="lineno">14</code>         console.log("selected pane: ", pane.title);
<code class="lineno">15</code>       };
<code class="lineno">16</code> 
<code class="lineno">17</code>       this.addPane = function(pane) {
<code class="lineno">18</code>         if (!panes.length) $scope.select(pane);
<code class="lineno">19</code>         panes.push(pane);
<code class="lineno">20</code>       };
<code class="lineno">21</code>     },
<code class="lineno">22</code>     template:
<code class="lineno">23</code>       '<code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"tabbable"</code><code class="nt">&gt;</code>' +
<code class="lineno">24</code>         '<code class="nt">&lt;ul</code> <code class="na">class=</code><code class="s">"nav nav-tabs"</code><code class="nt">&gt;</code>' +
<code class="lineno">25</code>           '<code class="nt">&lt;li</code> <code class="na">ng-repeat=</code><code class="s">"pane in panes"</code><code class="err">'</code> <code class="err">+</code>
<code class="lineno">26</code>               <code class="err">'</code><code class="na">ng-class=</code><code class="s">"{active:pane.selected}"</code><code class="nt">&gt;</code>'+
<code class="lineno">27</code>             '<code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">""</code> <code class="na">ng-click=</code><code class="s">"select(pane)"</code><code class="nt">&gt;</code>{{pane.title}}<code class="nt">&lt;/a&gt;</code>' +
<code class="lineno">28</code>           '<code class="nt">&lt;/li&gt;</code>' +
<code class="lineno">29</code>         '<code class="nt">&lt;/ul&gt;</code>' +
<code class="lineno">30</code>         '<code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"tab-content"</code> <code class="err">ng-transclude</code><code class="nt">&gt;&lt;/div&gt;</code>' +
<code class="lineno">31</code>       '<code class="nt">&lt;/div&gt;</code>',
<code class="lineno">32</code>     replace: true
<code class="lineno">33</code>   };
<code class="lineno">34</code> });
</pre></div>

</div>

<p>It manages a list of <code>panes</code> and the selected state of the <code>panes</code>. The template definition makes use of the selection to change the class and responds on the click event to change the selection.</p>

<p>The <code>pane</code> directive depends on the <code>tabs</code> directive to add itself to it.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="n">app</code><code class="p">.</code><code class="n">directive</code><code class="p">(</code><code class="s">"pane"</code><code class="p">,</code> <code class="n">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nl">require:</code> <code class="s">"^tabs"</code><code class="p">,</code>
<code class="lineno"> 4</code>     <code class="nl">restrict:</code> <code class="s">"E"</code><code class="p">,</code>
<code class="lineno"> 5</code>     <code class="nl">transclude:</code> <code class="nb">true</code><code class="p">,</code>
<code class="lineno"> 6</code>     <code class="nl">scope:</code> <code class="p">{</code>
<code class="lineno"> 7</code>       <code class="nl">title:</code> <code class="s">"@"</code>
<code class="lineno"> 8</code>     <code class="p">},</code>
<code class="lineno"> 9</code>     <code class="nl">link:</code> <code class="n">function</code><code class="p">(</code><code class="n">scope</code><code class="p">,</code> <code class="n">element</code><code class="p">,</code> <code class="n">attrs</code><code class="p">,</code> <code class="n">tabsCtrl</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">10</code>       <code class="n">tabsCtrl</code><code class="p">.</code><code class="n">addPane</code><code class="p">(</code><code class="n">scope</code><code class="p">);</code>
<code class="lineno">11</code>     <code class="p">},</code>
<code class="lineno">12</code>     <code class="nl">template:</code>
<code class="lineno">13</code>       <code class="err">'</code><code class="o">&lt;</code><code class="n">div</code> <code class="n">class</code><code class="o">=</code><code class="s">"tab-pane"</code> <code class="n">ng</code><code class="o">-</code><code class="n">class</code><code class="o">=</code><code class="s">"{active: selected}"</code><code class="err">'</code> <code class="o">+</code>
<code class="lineno">14</code>         <code class="err">'</code><code class="n">ng</code><code class="o">-</code><code class="n">transclude</code><code class="o">&gt;&lt;/</code><code class="n">div</code><code class="o">&gt;</code><code class="err">'</code><code class="p">,</code>
<code class="lineno">15</code>     <code class="nl">replace:</code> <code class="nb">true</code>
<code class="lineno">16</code>   <code class="p">};</code>
<code class="lineno">17</code> <code class="p">});</code>
</pre></div>

</div>

<h4 id="solution-19">Solution</h4>
<p>Using the angular-seed in combination with jasmine and jasmine-jquery, you can implement a unit test.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nb">describe</code><code class="p">(</code><code class="s1">'MyApp Tabs'</code><code class="p">,</code> <code class="nx">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">elm</code><code class="p">,</code> <code class="nx">scope</code><code class="p">;</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>   <code class="nx">beforeEach</code><code class="p">(</code><code class="nx">module</code><code class="p">(</code><code class="s1">'MyApp'</code><code class="p">));</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>   <code class="nx">beforeEach</code><code class="p">(</code><code class="nx">inject</code><code class="p">(</code><code class="nx">function</code><code class="p">(</code><code class="nv">$rootScope</code><code class="p">,</code> <code class="nv">$compile</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7</code>     <code class="n">elm</code> <code class="o">=</code> <code class="nx">angular.element</code><code class="p">(</code>
<code class="lineno"> 8</code>       <code class="s1">'&lt;div&gt;'</code> <code class="o">+</code>
<code class="lineno"> 9</code>         <code class="s1">'&lt;tabs&gt;'</code> <code class="o">+</code>
<code class="lineno">10</code>           <code class="s1">'&lt;pane title="First Tab"&gt;'</code> <code class="o">+</code>
<code class="lineno">11</code>             <code class="s1">'First content is {{first}}'</code> <code class="o">+</code>
<code class="lineno">12</code>           <code class="s1">'&lt;/pane&gt;'</code> <code class="o">+</code>
<code class="lineno">13</code>           <code class="s1">'&lt;pane title="Second Tab"&gt;'</code> <code class="o">+</code>
<code class="lineno">14</code>             <code class="s1">'Second content is {{second}}'</code> <code class="o">+</code>
<code class="lineno">15</code>           <code class="s1">'&lt;/pane&gt;'</code> <code class="o">+</code>
<code class="lineno">16</code>         <code class="s1">'&lt;/tabs&gt;'</code> <code class="o">+</code>
<code class="lineno">17</code>       <code class="s1">'&lt;/div&gt;'</code><code class="p">);</code>
<code class="lineno">18</code> 
<code class="lineno">19</code>     <code class="n">scope</code> <code class="o">=</code> <code class="nv">$rootScope</code><code class="p">;</code>
<code class="lineno">20</code>     <code class="nv">$compile</code><code class="p">(</code><code class="nx">elm</code><code class="p">)(</code><code class="nx">scope</code><code class="p">);</code>
<code class="lineno">21</code>     <code class="nx">scope.</code><code class="nv">$digest</code><code class="p">();</code>
<code class="lineno">22</code>   <code class="p">}));</code>
<code class="lineno">23</code> 
<code class="lineno">24</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'should create clickable titles'</code><code class="p">,</code> <code class="nx">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">25</code>     <code class="nx">console.log</code><code class="p">(</code><code class="nx">elm.find</code><code class="p">(</code><code class="s1">'ul.nav-tabs'</code><code class="p">));</code>
<code class="lineno">26</code>     <code class="kd">var</code> <code class="n">titles</code> <code class="o">=</code> <code class="nx">elm.find</code><code class="p">(</code><code class="s1">'ul.nav-tabs li a'</code><code class="p">);</code>
<code class="lineno">27</code> 
<code class="lineno">28</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">titles.length</code><code class="p">)</code><code class="bp">.</code><code class="nx">toBe</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code>
<code class="lineno">29</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">titles.eq</code><code class="p">(</code><code class="mi">0</code><code class="p">)</code><code class="bp">.</code><code class="nx">text</code><code class="p">())</code><code class="bp">.</code><code class="nx">toBe</code><code class="p">(</code><code class="s1">'First Tab'</code><code class="p">);</code>
<code class="lineno">30</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">titles.eq</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="bp">.</code><code class="nx">text</code><code class="p">())</code><code class="bp">.</code><code class="nx">toBe</code><code class="p">(</code><code class="s1">'Second Tab'</code><code class="p">);</code>
<code class="lineno">31</code>   <code class="p">});</code>
<code class="lineno">32</code> 
<code class="lineno">33</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'should set active class on title'</code><code class="p">,</code> <code class="nx">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">34</code>     <code class="kd">var</code> <code class="n">titles</code> <code class="o">=</code> <code class="nx">elm.find</code><code class="p">(</code><code class="s1">'ul.nav-tabs li'</code><code class="p">);</code>
<code class="lineno">35</code> 
<code class="lineno">36</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">titles.eq</code><code class="p">(</code><code class="mi">0</code><code class="p">))</code><code class="bp">.</code><code class="nx">toHaveClass</code><code class="p">(</code><code class="s1">'active'</code><code class="p">);</code>
<code class="lineno">37</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">titles.eq</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code><code class="bp">.</code><code class="nx">not.toHaveClass</code><code class="p">(</code><code class="s1">'active'</code><code class="p">);</code>
<code class="lineno">38</code>   <code class="p">});</code>
<code class="lineno">39</code> 
<code class="lineno">40</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'should change active pane when title clicked'</code><code class="p">,</code> <code class="nx">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">41</code>     <code class="kd">var</code> <code class="n">titles</code> <code class="o">=</code> <code class="nx">elm.find</code><code class="p">(</code><code class="s1">'ul.nav-tabs li'</code><code class="p">);</code>
<code class="lineno">42</code>     <code class="kd">var</code> <code class="n">contents</code> <code class="o">=</code> <code class="nx">elm.find</code><code class="p">(</code><code class="s1">'div.tab-content div.tab-pane'</code><code class="p">);</code>
<code class="lineno">43</code> 
<code class="lineno">44</code>     <code class="nx">titles.eq</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="bp">.</code><code class="nb">find</code><code class="p">(</code><code class="s1">'a'</code><code class="p">)</code><code class="bp">.</code><code class="nx">click</code><code class="p">();</code>
<code class="lineno">45</code> 
<code class="lineno">46</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">titles.eq</code><code class="p">(</code><code class="mi">0</code><code class="p">))</code><code class="bp">.</code><code class="nx">not.toHaveClass</code><code class="p">(</code><code class="s1">'active'</code><code class="p">);</code>
<code class="lineno">47</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">titles.eq</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code><code class="bp">.</code><code class="nx">toHaveClass</code><code class="p">(</code><code class="s1">'active'</code><code class="p">);</code>
<code class="lineno">48</code> 
<code class="lineno">49</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">contents.eq</code><code class="p">(</code><code class="mi">0</code><code class="p">))</code><code class="bp">.</code><code class="nx">not.toHaveClass</code><code class="p">(</code><code class="s1">'active'</code><code class="p">);</code>
<code class="lineno">50</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">contents.eq</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code><code class="bp">.</code><code class="nx">toHaveClass</code><code class="p">(</code><code class="s1">'active'</code><code class="p">);</code>
<code class="lineno">51</code>   <code class="p">});</code>
<code class="lineno">52</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter3/recipe8">github</a>.</p>

<h4 id="discussion-19">Discussion</h4>
<p>Combining jasmine with jasmine-jquery gives you useful assertions like <code>toHaveClass</code> and actions like <code>click</code>, which are used extensively in the example above.</p>

<p>To prepare the template we use <code>$compile</code> and <code>$digest</code> in the <code>beforeEach</code> function and then access the resulting Angular element in our tests.</p>

<p>The angular-seed project was slightly extended to add jquery and jasmine-jquery to the project.</p>

<p>The example code was extracted from <a href="https://github.com/vojtajina/ng-directive-testing/tree/start">Vojta Jina&rsquo; Github example</a> - the author of the awesome <a href="https://github.com/testacular/testacular">Testacular</a>.</p>

<h2 id="filters">Filters</h2>
<p>Angular Filters are typically used to format expressions in bindings in your template. They transform the input data to a new formatted data type.</p>

<h3 id="formatting-a-string-with-a-currency-filter">Formatting a String With a Currency Filter</h3>

<h4 id="problem-20">Problem</h4>
<p>You wish to format the amount of currency with a localized currency label.</p>

<h4 id="solution-20">Solution</h4>
<p>Use the built-in <code>currency</code> filter and make sure you load the corresponding locale file for the user&rsquo;s language.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;html&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;head&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;meta</code> <code class="na">charset=</code><code class="s">'utf-8'</code><code class="nt">&gt;</code>
<code class="lineno"> 4</code>     <code class="nt">&lt;script</code> <code class="na">src=</code><code class="s">"js/angular.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="lineno"> 5</code>     <code class="nt">&lt;script</code> <code class="na">src=</code><code class="s">"js/angular-locale_de.js"</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="lineno"> 6</code>   <code class="nt">&lt;/head&gt;</code>
<code class="lineno"> 7</code>   <code class="nt">&lt;body</code> <code class="err">ng-app</code><code class="nt">&gt;</code>
<code class="lineno"> 8</code>     <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"amount"</code> <code class="na">placeholder=</code><code class="s">"Enter amount"</code><code class="nt">/&gt;</code>
<code class="lineno"> 9</code>     <code class="nt">&lt;p&gt;</code>Default Currency: {{ amount | currency }}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">10</code>     <code class="nt">&lt;p&gt;</code>Custom Currency: {{ amount | currency: "Euro" }}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">11</code>   <code class="nt">&lt;/body&gt;</code>
<code class="lineno">12</code> <code class="nt">&lt;/html&gt;</code>
</pre></div>

</div>

<p>Enter an amount and it will be displayed using Angular&rsquo;s default locale.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter4/recipe1">github</a>.</p>

<h4 id="discussion-20">Discussion</h4>
<p>In our example we explicitly load the German locale settings and therefore the default formatting will be in German. The English locale is shipped by default, so there&rsquo;s no need to include the angular-locale_en.js file. If you remove the script tag, you will see the formatting change to English instead. This means in order for a localized application to work correctly you need to load the corresponding locale file. All available locale files can be seen on <a href="https://github.com/angular/angular.js/tree/master/src/ngLocale">github</a>.</p>

<h3 id="implementing-a-custom-filter-to-reverse-an-input-string">Implementing a Custom Filter to Reverse an Input String</h3>

<h4 id="problem-21">Problem</h4>
<p>You wish to reverse user&rsquo;s text input.</p>

<h4 id="solution-21">Solution</h4>
<p>Implement a custom filter, which reverses the input.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"text"</code> <code class="na">placeholder=</code><code class="s">"Enter text"</code><code class="nt">/&gt;</code>
<code class="lineno"> 3</code>   <code class="nt">&lt;p&gt;</code>Input: {{ text }}<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 4</code>   <code class="nt">&lt;p&gt;</code>Filtered input: {{ text | reverse }}<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 5</code> <code class="nt">&lt;/body&gt;</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code> app.filter("reverse", function() {
<code class="lineno">10</code>   return function(input) {
<code class="lineno">11</code>     var result = "";
<code class="lineno">12</code>     input = input || "";
<code class="lineno">13</code>     for (var i=0; i<code class="nt">&lt;input.length</code><code class="err">;</code> <code class="err">i++)</code> <code class="err">{</code>
<code class="lineno">14</code>       <code class="na">result =</code> <code class="s">input.charAt(i)</code> <code class="err">+</code> <code class="err">result;</code>
<code class="lineno">15</code>     <code class="err">}</code>
<code class="lineno">16</code>     <code class="err">return</code> <code class="err">result;</code>
<code class="lineno">17</code>   <code class="err">};</code>
<code class="lineno">18</code> <code class="err">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter4/recipe2">github</a>.</p>

<h4 id="discussion-21">Discussion</h4>
<p>Angular&rsquo;s filter function expects a filter name and a function as params. The function must return the actual filter function where you implement the business logic. In this example it will only have an <code>input</code> param. The result will be returned after the for loop has reversed the input.</p>

<h3 id="passing-configuration-params-to-filters">Passing Configuration Params to Filters</h3>

<h4 id="problem-22">Problem</h4>
<p>You wish to make your filter customizable by introducing config params.</p>

<h4 id="solution-22">Solution</h4>
<p>Angular filters can be passed a hash of params which can be directly accessed in the filter function.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"text"</code> <code class="na">placeholder=</code><code class="s">"Enter text"</code><code class="nt">/&gt;</code>
<code class="lineno"> 3</code>   <code class="nt">&lt;p&gt;</code>Input: {{ text }}<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 4</code>   <code class="nt">&lt;p&gt;</code>Filtered input: {{ text | reverse: { suffix: "!"} }}<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 5</code> <code class="nt">&lt;/body&gt;</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code> app.filter("reverse", function() {
<code class="lineno">10</code>   return function(input, options) {
<code class="lineno">11</code>     input = input || "";
<code class="lineno">12</code>     var result = "";
<code class="lineno">13</code>     var suffix = options<code class="cp">[</code><code class="s2">"suffix"</code><code class="cp">]</code> || "";
<code class="lineno">14</code> 
<code class="lineno">15</code>     for (var i=0; i<code class="nt">&lt;input.length</code><code class="err">;</code> <code class="err">i++)</code> <code class="err">{</code>
<code class="lineno">16</code>       <code class="na">result =</code> <code class="s">input.charAt(i)</code> <code class="err">+</code> <code class="err">result;</code>
<code class="lineno">17</code>     <code class="err">}</code>
<code class="lineno">18</code> 
<code class="lineno">19</code>     <code class="err">if</code> <code class="err">(input.length</code> <code class="nt">&gt;</code> 0) result += suffix;
<code class="lineno">20</code> 
<code class="lineno">21</code>     return result;
<code class="lineno">22</code>   };
<code class="lineno">23</code> });
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter4/recipe3">github</a>.</p>

<h4 id="discussion-22">Discussion</h4>
<p>The suffix <code>!</code> is passed as an option to the filter function and is appended to the output. Note that we check if an actual input exists since we don&rsquo;t want to render the suffix without any input.</p>

<h3 id="filtering-a-list-of-dom-nodes">Filtering a List of DOM Nodes</h3>

<h4 id="problem-23">Problem</h4>
<p>You wish to filter a <code>ul</code> list of names.</p>

<h4 id="solution-23">Solution</h4>
<p>As well as with strings as input, Angular&rsquo;s filters also work with arrays.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;ul</code> <code class="na">ng-init=</code><code class="s">"names = </code><code class="cp">[</code><code class="s1">'Peter'</code><code class="p">,</code> <code class="s1">'Anton'</code><code class="p">,</code> <code class="s1">'John'</code><code class="cp">]</code><code class="s">"</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;li</code> <code class="na">ng-repeat=</code><code class="s">"name in names | exclude:'Peter' "</code><code class="nt">&gt;</code>
<code class="lineno"> 4</code>       <code class="nt">&lt;span&gt;</code>{{name}}<code class="nt">&lt;/span&gt;</code>
<code class="lineno"> 5</code>     <code class="nt">&lt;/li&gt;</code>
<code class="lineno"> 6</code>   <code class="nt">&lt;/ul&gt;</code>
<code class="lineno"> 7</code> <code class="nt">&lt;/body&gt;</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno">10</code> 
<code class="lineno">11</code> app.filter("exclude", function() {
<code class="lineno">12</code>   return function(input, exclude) {
<code class="lineno">13</code>     var result = <code class="cp">[]</code>;
<code class="lineno">14</code>     for (var i=0; i<code class="nt">&lt;input.length</code><code class="err">;</code> <code class="err">i++)</code> <code class="err">{</code>
<code class="lineno">15</code>       <code class="err">if</code> <code class="err">(input</code><code class="cp">[</code><code class="nx">i</code><code class="cp">]</code> <code class="err">!==</code> <code class="err">exclude)</code> <code class="err">{</code>
<code class="lineno">16</code>         <code class="err">result.push(input</code><code class="cp">[</code><code class="nx">i</code><code class="cp">]</code><code class="err">);</code>
<code class="lineno">17</code>       <code class="err">}</code>
<code class="lineno">18</code>     <code class="err">}</code>
<code class="lineno">19</code> 
<code class="lineno">20</code>     <code class="err">return</code> <code class="err">result;</code>
<code class="lineno">21</code>   <code class="err">};</code>
<code class="lineno">22</code> <code class="err">});</code>
</pre></div>

</div>

<p>We pass <code>Peter</code> as the single param to the exclude filter, which will render all names except <code>Peter</code>.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter4/recipe4">github</a>.</p>

<h4 id="discussion-23">Discussion</h4>
<p>The filter implementation loops through all names and creates a result array excluding &lsquo;Peter&rsquo;. Note that the actual syntax of the filter function didn&rsquo;t change at all from our previous example with the String input.</p>

<h3 id="chaining-filters-together">Chaining Filters together</h3>

<h4 id="problem-24">Problem</h4>
<p>You wish to combine several filters to form a single result.</p>

<h4 id="solution-24">Solution</h4>
<p>Filters can be chained using the UNIX-like pipe syntax.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;ul</code> <code class="na">ng-init=</code><code class="s">"names = </code><code class="cp">[</code><code class="s1">'Peter'</code><code class="p">,</code> <code class="s1">'Anton'</code><code class="p">,</code> <code class="s1">'John'</code><code class="cp">]</code><code class="s">"</code><code class="nt">&gt;</code>
<code class="lineno">3</code>     <code class="nt">&lt;li</code> <code class="na">ng-repeat=</code><code class="s">"name in names | exclude:'Peter' | sortAscending "</code><code class="nt">&gt;</code>
<code class="lineno">4</code>       <code class="nt">&lt;span&gt;</code>{{name}}<code class="nt">&lt;/span&gt;</code>
<code class="lineno">5</code>     <code class="nt">&lt;/li&gt;</code>
<code class="lineno">6</code>   <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">7</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<h4 id="discussion-24">Discussion</h4>
<p>The pipe symbol (<code>|</code>) is used to chain multiple filters together. First we will start with the initial Array of names. After applying the <code>exclude</code> filter the Array contains only <code>['Anton', 'John']</code> and afterwards we will sort the names in ascending order.</p>

<p>I leave the implementation of the <code>sortAscending</code> filter as an exercise to the reader ;-)</p>

<h3 id="testing-filters">Testing Filters</h3>

<h4 id="problem-25">Problem</h4>
<p>You wish to unit test your new filter. Let us start with an easy filter, which renders a checkmark depending on a boolean value.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-init=</code><code class="s">"data = true"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;p&gt;</code>{{ data | checkmark}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 3</code>   <code class="nt">&lt;p&gt;</code>{{ !data | checkmark}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno"> 4</code> <code class="nt">&lt;/body&gt;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code> app.filter('checkmark', function() {
<code class="lineno"> 9</code>   return function(input) {
<code class="lineno">10</code>     return input ? '\u2713' : '\u2718';
<code class="lineno">11</code>   };
<code class="lineno">12</code> });
</pre></div>

</div>

<h4 id="solution-25">Solution</h4>
<p>Use the angular-seed project as a bootstrap again.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">describe</code><code class="p">(</code><code class="s1">'MyApp Tabs'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">beforeEach</code><code class="p">(</code><code class="nx">module</code><code class="p">(</code><code class="s1">'MyApp'</code><code class="p">));</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>   <code class="nx">describe</code><code class="p">(</code><code class="s1">'checkmark'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 5</code>      <code class="nx">it</code><code class="p">(</code><code class="s1">'should convert boolean values to unicode checkmark or cross'</code><code class="p">,</code>
<code class="lineno"> 6</code>         <code class="nx">inject</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">checkmarkFilter</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7</code>        <code class="nx">expect</code><code class="p">(</code><code class="nx">checkmarkFilter</code><code class="p">(</code><code class="kc">true</code><code class="p">)).</code><code class="nx">toBe</code><code class="p">(</code><code class="s1">'\u2713'</code><code class="p">);</code>
<code class="lineno"> 8</code>        <code class="nx">expect</code><code class="p">(</code><code class="nx">checkmarkFilter</code><code class="p">(</code><code class="kc">false</code><code class="p">)).</code><code class="nx">toBe</code><code class="p">(</code><code class="s1">'\u2718'</code><code class="p">);</code>
<code class="lineno"> 9</code>      <code class="p">}));</code>
<code class="lineno">10</code>    <code class="p">});</code>
<code class="lineno">11</code> <code class="p">});</code>
</pre></div>

</div>

<h4 id="discussion-25">Discussion</h4>
<p>The <code>beforeEach</code> loads the module and the <code>it</code> method injects the filter function for us. Note, that it has to be called <code>checkmarkFilter</code>, otherwise Angular can&rsquo;t inject our filter function correctly.</p>

<h2 id="consuming-externals-services">Consuming Externals Services</h2>
<p>Angular has built-in support for communication with remote HTTP servers. The <a href="http://docs.angularjs.org/api/ng.%24http">$http</a> service handles low-level AJAX requests via the browser&rsquo;s <a href="http://en.wikipedia.org/wiki/XMLHttpRequest">XMLHttpRequest</a> object or via <a href="http://en.wikipedia.org/wiki/JSONP">JSONP</a>. The <a href="http://docs.angularjs.org/api/ngResource.%24resource">$resource</a> service lets you interact with RESTful data sources and provides high-level behaviors which naturally map to RESTful resources.</p>

<h3 id="requesting-json-data-with-ajax">Requesting JSON Data with AJAX</h3>

<h4 id="problem-26">Problem</h4>
<p>You wish to fetch JSON data via AJAX request and render it.</p>

<h4 id="solution-26">Solution</h4>
<p>Implement a controller using the <code>$http</code> service to fetch the data and store it in the scope.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"PostsCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;ul</code> <code class="na">ng-repeat=</code><code class="s">"post in posts"</code><code class="nt">&gt;</code>
<code class="lineno"> 4</code>       <code class="nt">&lt;li&gt;</code>{{post.title}}<code class="nt">&lt;/li&gt;</code>
<code class="lineno"> 5</code>     <code class="nt">&lt;/ul&gt;</code>
<code class="lineno"> 6</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno"> 7</code> <code class="nt">&lt;/body&gt;</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code> var app = angular.module("MyApp", <code class="cp">[]</code>);
<code class="lineno">10</code> 
<code class="lineno">11</code> app.controller("PostsCtrl", function($scope, $http) {
<code class="lineno">12</code>   $http.get('data/posts.json').
<code class="lineno">13</code>     success(function(data, status, headers, config) {
<code class="lineno">14</code>       $scope.posts = data;
<code class="lineno">15</code>     }).
<code class="lineno">16</code>     error(function(data, status, headers, config) {
<code class="lineno">17</code>       // log error
<code class="lineno">18</code>     });
<code class="lineno">19</code> });
</pre></div>

</div>

<p>You can find the complete example using the angular-seed project on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter5/recipe1">github</a>.</p>

<h4 id="discussion-26">Discussion</h4>
<p>The controller defines a dependency to the <code>$scope</code> and the <code>$http</code> module. An HTTP GET request to the <code>data/posts.json</code> endpoint is carried out with the <code>get</code> method. It returns a <a href="http://docs.angularjs.org/api/ng.%24q">$promise</a> object with a <code>success</code> and an <code>error</code> method. Once successful, the JSON data is assigned to <code>$scope.posts</code> to make it available in the template.</p>

<p>The <code>$http</code> service supports the HTTP verbs <code>get</code>, <code>head</code>, <code>post</code>, <code>put</code>, <code>delete</code> and <code>jsonp</code>. We are going to look into more examples in the following chapters.</p>

<p>The <code>$http</code> service automatically adds certain HTTP headers like for example <code>X-Requested-With: XMLHttpRequest</code>. But you can also set custom HTTP headers by yourself using the <code>$http.defaults</code> function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="err">$</code><code class="n">http</code><code class="p">.</code><code class="n">defaults</code><code class="p">.</code><code class="n">headers</code><code class="p">.</code><code class="n">common</code><code class="p">[</code><code class="s">"X-Custom-Header"</code><code class="p">]</code> <code class="o">=</code> <code class="s">"Angular.js"</code>
</pre></div>

</div>

<p>Until now the <code>$http</code> service does not really look particularly special. But if you look into the <a href="http://docs.angularjs.org/api/ng.%24http">documentation</a> you find a whole lot of nice features like, for example, request/response transformations, to automatically deserialize JSON for you, response caching, response interceptors to handle global error handling, authentication or other preprocessing tasks and, of course, promise support. We will look into the <code>$q</code> service, Angular&rsquo;s promise/deferred service in a later chapter.</p>

<h3 id="consuming-restful-apis">Consuming RESTful APIs</h3>

<h4 id="problem-27">Problem</h4>
<p>You wish to consume a RESTful data source.</p>

<h4 id="solution-27">Solution</h4>
<p>Use Angular&rsquo;s high-level <code>$resource</code> service. Note that the Angular <code>ngResource</code> module needs to be separately loaded since it is not included in the base angular.js file:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="o">&lt;</code><code class="n">script</code> <code class="n">src</code><code class="o">=</code><code class="s">"angular-resource.js"</code><code class="o">&gt;</code>
</pre></div>

</div>

<p>Let us now start by defining the application module and our <code>Post</code> model as an Angular service:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s1">'myApp'</code><code class="p">,</code> <code class="cp">[</code><code class="s1">'ngResource'</code><code class="cp">]</code><code class="p">);</code>
<code class="lineno">2</code> 
<code class="lineno">3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s2">"Post"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$resource</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">4</code>   <code class="k">return</code> <code class="nx">$resource</code><code class="p">(</code><code class="s2">"/api/posts/:id"</code><code class="p">);</code>
<code class="lineno">5</code> <code class="p">});</code>
</pre></div>

</div>

<p>Now we can use our service to retrieve a list of posts inside a controller (example: HTTP GET /api/posts):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"PostIndexCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">Post</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">Post</code><code class="p">.</code><code class="nx">query</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">posts</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>
<code class="lineno">4</code>   <code class="p">});</code>
<code class="lineno">5</code> <code class="p">});</code>
</pre></div>

</div>

<p>Or a specific post by <code>id</code> (example: HTTP GET /api/posts/1):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"PostShowCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">Post</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">Post</code><code class="p">.</code><code class="nx">get</code><code class="p">({</code> <code class="nx">id</code><code class="o">:</code> <code class="mi">1</code> <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">post</code> <code class="o">=</code> <code class="nx">data</code><code class="p">;</code>
<code class="lineno">4</code>   <code class="p">});</code>
<code class="lineno">5</code> <code class="p">});</code>
</pre></div>

</div>

<p>We can create a new post using save (example: HTTP POST /api/posts):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">Post</code><code class="p">.</code><code class="n">save</code><code class="p">(</code><code class="n">data</code><code class="p">);</code>
</pre></div>

</div>

<p>And we can delete a specific post by <code>id</code> (example: DELETE /api/posts/1):</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">Post</code><code class="p">.</code><code class="n">delete</code><code class="p">({</code> <code class="n">id</code><code class="o">:</code> <code class="n">id</code> <code class="p">});</code>
</pre></div>

</div>

<p>The complete example code is based on Brian Ford&rsquo;s <a href="https://github.com/btford/angular-express-seed">angular-express-seed</a> and uses the <a href="http://expressjs.com/">Express</a> framework.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter5/recipe2">github</a>.</p>

<h4 id="discussion-27">Discussion</h4>
<p>Following some conventions simplifies our code quite a bit. We define the <code>$resource</code> by passing the URL schema only. This gives us a handful of nice methods including <code>query</code>, <code>get</code>, <code>save</code>, <code>remove</code> and <code>delete</code> to work with our resource. In the example above we implement several controllers to cover the typical use cases. The <code>get</code> and <code>query</code> methods expect three arguments, the request parameters, the success and the error callback. The <code>save</code> method expects four arguments, the request parameters, the POST data, the success and the error callback.</p>

<p>The <code>$resource</code> service currently does not support promises and therefore has a distinctly different interface to the <code>$http</code> service. But we don&rsquo;t have to wait very long for it, since work has already started in the 1.1 development branch to introduce promise support for the <code>$resource</code> service!</p>

<p>The returned object of a <code>$resource</code> query or get function is a <code>$resource</code> instance which provides <code>$save</code>, <code>$remove</code> and <code>$delete</code> methods. This allows you to easily fetch a resource and update it as in the following example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">post</code> <code class="o">=</code> <code class="nx">Post</code><code class="p">.</code><code class="nx">get</code><code class="p">({</code> <code class="nx">id</code><code class="o">:</code> <code class="mi">1</code> <code class="p">},</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">post</code><code class="p">.</code><code class="nx">title</code> <code class="o">=</code> <code class="s2">"My new title"</code><code class="p">;</code>
<code class="lineno">3</code>   <code class="nx">post</code><code class="p">.</code><code class="nx">$save</code><code class="p">();</code>
<code class="lineno">4</code> <code class="p">});</code>
</pre></div>

</div>

<p>It is important to notice that the <code>get</code> call immediately returns an empty reference - in our case the <code>post</code> variable. Once the data is returned from the server the existing reference is populated and we can change our post title and use the <code>$save</code> method conveniently.</p>

<p>Note that having an empty reference means that our post will not be rendered in the template. Once the data is returned though, the view automatically re-renders itself showing the new data.</p>

<h5 id="configuration">Configuration</h5>

<p>What if your response of posts is not an array but a more complex json? This typically results in the following error:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">TypeError</code><code class="o">:</code> <code class="n">Object</code> <code class="err">#</code><code class="o">&lt;</code><code class="n">Resource</code><code class="o">&gt;</code> <code class="n">has</code> <code class="n">no</code> <code class="n">method</code> <code class="s1">'push'</code>
</pre></div>

</div>

<p>Angular seems to expect your service to return a JSON array. Have a look at the following JSON example, which wraps a <code>posts</code> array in a JSON object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="s2">"posts"</code><code class="o">:</code> <code class="cp">[</code>
<code class="lineno"> 3</code>     <code class="p">{</code>
<code class="lineno"> 4</code>       <code class="s2">"id"</code>    <code class="p">:</code> <code class="mi">1</code><code class="p">,</code>
<code class="lineno"> 5</code>       <code class="s2">"title"</code> <code class="p">:</code> <code class="s2">"title 1"</code>
<code class="lineno"> 6</code>     <code class="p">},</code>
<code class="lineno"> 7</code>     <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="s2">"id"</code><code class="p">:</code> <code class="mi">2</code><code class="p">,</code>
<code class="lineno"> 9</code>       <code class="s2">"title"</code> <code class="p">:</code> <code class="s2">"title 2"</code>
<code class="lineno">10</code>     <code class="p">}</code>
<code class="lineno">11</code>   <code class="cp">]</code>
<code class="lineno">12</code> <code class="p">}</code>
</pre></div>

</div>

<p>In this case you have to change the <code>$resource</code> definition accordingly.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s2">"Post"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$resource</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">return</code> <code class="nx">$resource</code><code class="p">(</code><code class="s2">"/api/posts/:id"</code><code class="p">,</code> <code class="p">{},</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">query</code><code class="o">:</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s2">"GET"</code><code class="p">,</code> <code class="nx">isArray</code><code class="o">:</code> <code class="kc">false</code> <code class="p">}</code>
<code class="lineno"> 4</code>   <code class="p">});</code>
<code class="lineno"> 5</code> <code class="p">});</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"PostIndexCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">Post</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>   <code class="nx">Post</code><code class="p">.</code><code class="nx">query</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 9</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">posts</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">posts</code><code class="p">;</code>
<code class="lineno">10</code>   <code class="p">});</code>
<code class="lineno">11</code> <code class="p">});</code>
</pre></div>

</div>

<p>We only change the configuration of the <code>query</code> action to not expect an array by setting the <code>isArray</code> attribute to <code>false</code>. Then in our controller we can directly access <code>data.posts</code>.</p>

<p>It is generally good practice to encapsulate your model and <code>$resource</code> usage in an Angular service module and inject that in your controller. This way you can easily reuse the same model in different controllers and test it more easily.</p>

<h3 id="consuming-jsonp-apis">Consuming JSONP APIs</h3>

<h4 id="problem-28">Problem</h4>
<p>You wish to call a JSONP API.</p>

<h4 id="solution-28">Solution</h4>
<p>Use the <code>$resource</code> service and configure it to use JSONP. As an example we will take the Twitter search API here.</p>

<p>The HTML template lets you enter a search term in an input field and will render the search result in a list.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">3</code>     <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"searchTerm"</code> <code class="na">placeholder=</code><code class="s">"Search term"</code><code class="nt">&gt;</code>
<code class="lineno">4</code>     <code class="nt">&lt;button</code> <code class="na">ng-click=</code><code class="s">"search()"</code><code class="nt">&gt;</code>Search<code class="nt">&lt;/button&gt;</code>
<code class="lineno">5</code>     <code class="nt">&lt;ul</code> <code class="na">ng-repeat=</code><code class="s">"tweet in searchResult.results"</code><code class="nt">&gt;</code>
<code class="lineno">6</code>       <code class="nt">&lt;li&gt;</code>{{tweet.text}}<code class="nt">&lt;/li&gt;</code>
<code class="lineno">7</code>     <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">8</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">9</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>The <code>$resource</code> configuration can be done in a controller requesting the data:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[</code><code class="s2">"ngResource"</code><code class="cp">]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="kd">function</code> <code class="nx">MyCtrl</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">$resource</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="kd">var</code> <code class="nx">TwitterAPI</code> <code class="o">=</code> <code class="nx">$resource</code><code class="p">(</code><code class="s2">"http://search.twitter.com/search.json"</code><code class="p">,</code>
<code class="lineno"> 5</code>     <code class="p">{</code> <code class="nx">callback</code><code class="o">:</code> <code class="s2">"JSON_CALLBACK"</code> <code class="p">},</code>
<code class="lineno"> 6</code>     <code class="p">{</code> <code class="nx">get</code><code class="o">:</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s2">"JSONP"</code> <code class="p">}});</code>
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">search</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 9</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">searchResult</code> <code class="o">=</code> <code class="nx">TwitterAPI</code><code class="p">.</code><code class="nx">get</code><code class="p">({</code> <code class="nx">q</code><code class="o">:</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">searchTerm</code> <code class="p">});</code>
<code class="lineno">10</code>   <code class="p">};</code>
<code class="lineno">11</code> <code class="p">}</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter5/recipe3">github</a>.</p>

<h4 id="discussion-28">Discussion</h4>
<p>The Twitter search API supports a <code>callback</code> attribute for the JSON format as described in their <a href="https://dev.twitter.com/docs/api/1/get/search">documentation</a>. The <code>$resource</code> definition sets the <code>callback</code> attribute to <code>JSON_CALLBACK</code>, which is a convention from Angular when using <a href="http://en.wikipedia.org/wiki/JSONP">JSONP</a>. It is a placeholder that is replaced with the real callback function, generated by Angular. Additionally, we configure the get method to use <code>JSONP</code>. Now, when calling the API we use the <code>q</code> URL parameter to pass the entered <code>searchTerm</code>.</p>

<h3 id="deferred-and-promise">Deferred and Promise</h3>

<h4 id="problem-29">Problem</h4>
<p>You wish to synchronize multiple asynchronous functions and avoid Javascript callback hell.</p>

<h4 id="solution-29">Solution</h4>
<p>As an example, we want to call three services in sequence and combine the result of them. Let us start with a nested approach:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="cp">[]</code><code class="p">;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">$http</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/app/data/first.json"</code><code class="p">).</code><code class="nx">success</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="nx">tmp</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
<code class="lineno"> 5</code>   <code class="nx">$http</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/app/data/second.json"</code><code class="p">).</code><code class="nx">success</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>     <code class="nx">tmp</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
<code class="lineno"> 7</code>     <code class="nx">$http</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/app/data/third.json"</code><code class="p">).</code><code class="nx">success</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="nx">tmp</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
<code class="lineno"> 9</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">combinedNestedResult</code> <code class="o">=</code> <code class="nx">tmp</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s2">", "</code><code class="p">);</code>
<code class="lineno">10</code>     <code class="p">});</code>
<code class="lineno">11</code>   <code class="p">});</code>
<code class="lineno">12</code> <code class="p">});</code>
</pre></div>

</div>

<p>We call the <code>get</code> function three times to retrieve three JSON documents each with an array of strings. We haven&rsquo;t even started adding error handling but already using nested callbacks the code becomes messy and can be simplified using the <code>$q</code> service:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">first</code>  <code class="o">=</code> <code class="nx">$http</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/app/data/first.json"</code><code class="p">),</code>
<code class="lineno"> 2</code>     <code class="nx">second</code> <code class="o">=</code> <code class="nx">$http</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/app/data/second.json"</code><code class="p">),</code>
<code class="lineno"> 3</code>     <code class="nx">third</code>  <code class="o">=</code> <code class="nx">$http</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s2">"/app/data/third.json"</code><code class="p">);</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code> <code class="nx">$q</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="cp">[</code><code class="nb">first</code><code class="p">,</code> <code class="nb">second</code><code class="p">,</code> <code class="nx">third</code><code class="cp">]</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">result</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>   <code class="kd">var</code> <code class="nx">tmp</code> <code class="o">=</code> <code class="cp">[]</code><code class="p">;</code>
<code class="lineno"> 7</code>   <code class="nx">angular</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">result</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">response</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>     <code class="nx">tmp</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">response</code><code class="p">.</code><code class="nx">data</code><code class="p">);</code>
<code class="lineno"> 9</code>   <code class="p">});</code>
<code class="lineno">10</code>   <code class="k">return</code> <code class="nx">tmp</code><code class="p">;</code>
<code class="lineno">11</code> <code class="p">}).</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">tmpResult</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">12</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">combinedResult</code> <code class="o">=</code> <code class="nx">tmpResult</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s2">", "</code><code class="p">);</code>
<code class="lineno">13</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter5/recipe4">github</a>.</p>

<h4 id="discussion-29">Discussion</h4>
<p>The <code>all</code> function combines multiple promises into a single promise and solves our problem quite elegantly.</p>

<p>Let&rsquo;s have a closer look at the <code>then</code> method. It is rather contrived but should give you an idea of how to use <code>then</code> to sequentially call functions and pass data along. Since the <code>all</code> function returns a promise again we can call <code>then</code> on it. By returning the <code>tmp</code> variable it will be passed along to the then function as <code>tmpResult</code> argument.</p>

<p>Before finishing this recipe let us quickly discuss an example where we have to create our own deferred object:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">function</code> <code class="nx">deferredTimer</code><code class="p">(</code><code class="nx">success</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">deferred</code> <code class="o">=</code> <code class="nx">$q</code><code class="p">.</code><code class="nx">defer</code><code class="p">();</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>   <code class="nx">$timeout</code><code class="p">(</code><code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">success</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>       <code class="nx">deferred</code><code class="p">.</code><code class="nx">resolve</code><code class="p">({</code> <code class="nx">message</code><code class="o">:</code> <code class="s2">"This is great!"</code> <code class="p">});</code>
<code class="lineno"> 7</code>     <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="nx">deferred</code><code class="p">.</code><code class="nx">reject</code><code class="p">({</code> <code class="nx">message</code><code class="o">:</code> <code class="s2">"Really bad"</code> <code class="p">});</code>
<code class="lineno"> 9</code>     <code class="p">}</code>
<code class="lineno">10</code>   <code class="p">},</code> <code class="mi">1000</code><code class="p">);</code>
<code class="lineno">11</code> 
<code class="lineno">12</code>   <code class="k">return</code> <code class="nx">deferred</code><code class="p">.</code><code class="nx">promise</code><code class="p">;</code>
<code class="lineno">13</code> <code class="p">}</code>
</pre></div>

</div>

<p>Using the <code>defer</code> method we create a deferred instance. As an example of an asynchronous operation we will use the <code>$timeout</code> service which will either resolve or reject our operation depending on the boolean success parameter. The function will immediately return the <code>promise</code> and therefore not render any result in our HTML template. After one second, the timer will execute and return our success or failure response.</p>

<p>This <code>deferredTimer</code> can be triggered in our HTML template by wrapping it into a function defined on the scope:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">startDeferredTimer</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">success</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">deferredTimer</code><code class="p">(</code><code class="nx">success</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code>
<code class="lineno"> 3</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">deferredTimerResult</code> <code class="o">=</code> <code class="s2">"Successfully finished: "</code> <code class="o">+</code>
<code class="lineno"> 5</code>         <code class="nx">data</code><code class="p">.</code><code class="nx">message</code><code class="p">;</code>
<code class="lineno"> 6</code>     <code class="p">},</code>
<code class="lineno"> 7</code>     <code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">deferredTimerResult</code> <code class="o">=</code> <code class="s2">"Failed: "</code> <code class="o">+</code> <code class="nx">data</code><code class="p">.</code><code class="nx">message</code><code class="p">;</code>
<code class="lineno"> 9</code>     <code class="p">}</code>
<code class="lineno">10</code>   <code class="p">);</code>
<code class="lineno">11</code> <code class="p">};</code>
</pre></div>

</div>

<p>Our <code>startDeferredTimer</code> function will get a <code>success</code> parameter which it passes along to the <code>deferredTimer</code>. The <code>then</code> function expects a success and an error callback as arguments which we use to set a scope variable <code>deferredTimerResult</code> to show our result.</p>

<p>This is just one of many examples of how promises can simplify your code, but you can find many more examples by looking into <a href="https://github.com/kriskowal/q">Kris Kowal&rsquo;s Q implementation</a>.</p>

<h3 id="testing-services">Testing Services</h3>

<h4 id="problem-30">Problem</h4>
<p>You wish to unit test your controller and service consuming a JSONP API.</p>

<p>Let&rsquo;s have a look again at our example we wish to test:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[</code><code class="s2">"ngResource"</code><code class="cp">]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s2">"TwitterAPI"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$resource</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="k">return</code> <code class="nx">$resource</code><code class="p">(</code><code class="s2">"http://search.twitter.com/search.json"</code><code class="p">,</code>
<code class="lineno"> 5</code>     <code class="p">{</code> <code class="nx">callback</code><code class="o">:</code> <code class="s2">"JSON_CALLBACK"</code> <code class="p">},</code>
<code class="lineno"> 6</code>     <code class="p">{</code> <code class="nx">get</code><code class="o">:</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s2">"JSONP"</code> <code class="p">}});</code>
<code class="lineno"> 7</code> <code class="p">});</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"MyCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">TwitterAPI</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">10</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">search</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">11</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">searchResult</code> <code class="o">=</code> <code class="nx">TwitterAPI</code><code class="p">.</code><code class="nx">get</code><code class="p">({</code> <code class="nx">q</code><code class="o">:</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">searchTerm</code> <code class="p">});</code>
<code class="lineno">12</code>   <code class="p">};</code>
<code class="lineno">13</code> <code class="p">});</code>
</pre></div>

</div>

<p>Note that it slightly changed from the previous recipe as the <code>TwitterAPI</code> is pulled out of the controller and resides in its own service now.</p>

<h4 id="solution-30">Solution</h4>
<p>Use the angular-seed project and the $http_backend mocking service.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">describe</code><code class="p">(</code><code class="s1">'MyCtrl'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(){</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">scope</code><code class="p">,</code> <code class="nx">ctrl</code><code class="p">,</code> <code class="nx">httpBackend</code><code class="p">;</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>   <code class="nx">beforeEach</code><code class="p">(</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">));</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>   <code class="nx">beforeEach</code><code class="p">(</code>
<code class="lineno"> 7</code>     <code class="nx">inject</code><code class="p">(</code>
<code class="lineno"> 8</code>       <code class="kd">function</code><code class="p">(</code><code class="nx">$controller</code><code class="p">,</code> <code class="nx">$rootScope</code><code class="p">,</code> <code class="nx">TwitterAPI</code><code class="p">,</code> <code class="nx">$httpBackend</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 9</code>         <code class="nx">httpBackend</code> <code class="o">=</code> <code class="nx">$httpBackend</code><code class="p">;</code>
<code class="lineno">10</code>         <code class="nx">scope</code> <code class="o">=</code> <code class="nx">$rootScope</code><code class="p">.</code><code class="nx">$new</code><code class="p">();</code>
<code class="lineno">11</code>         <code class="nx">ctrl</code> <code class="o">=</code> <code class="nx">$controller</code><code class="p">(</code><code class="s2">"MyCtrl"</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">12</code>           <code class="nx">$scope</code><code class="o">:</code> <code class="nx">scope</code><code class="p">,</code> <code class="nx">TwitterAPI</code><code class="o">:</code> <code class="nx">TwitterAPI</code> <code class="p">});</code>
<code class="lineno">13</code> 
<code class="lineno">14</code>         <code class="kd">var</code> <code class="nx">mockData</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">key</code><code class="o">:</code> <code class="s2">"test"</code> <code class="p">};</code>
<code class="lineno">15</code>         <code class="kd">var</code> <code class="nx">url</code> <code class="o">=</code> <code class="s2">"http://search.twitter.com/search.json?"</code> <code class="o">+</code>
<code class="lineno">16</code>           <code class="s2">"callback=JSON_CALLBACK&amp;q=angularjs"</code><code class="p">;</code>
<code class="lineno">17</code>         <code class="nx">httpBackend</code><code class="p">.</code><code class="nx">whenJSONP</code><code class="p">(</code><code class="nx">url</code><code class="p">).</code><code class="nx">respond</code><code class="p">(</code><code class="nx">mockData</code><code class="p">);</code>
<code class="lineno">18</code>       <code class="p">}</code>
<code class="lineno">19</code>     <code class="p">)</code>
<code class="lineno">20</code>   <code class="p">);</code>
<code class="lineno">21</code> 
<code class="lineno">22</code>   <code class="nx">it</code><code class="p">(</code><code class="s1">'should set searchResult on successful search'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">23</code>     <code class="nx">scope</code><code class="p">.</code><code class="nx">searchTerm</code> <code class="o">=</code> <code class="s2">"angularjs"</code><code class="p">;</code>
<code class="lineno">24</code>     <code class="nx">scope</code><code class="p">.</code><code class="nx">search</code><code class="p">();</code>
<code class="lineno">25</code>     <code class="nx">httpBackend</code><code class="p">.</code><code class="nx">flush</code><code class="p">();</code>
<code class="lineno">26</code> 
<code class="lineno">27</code>     <code class="nx">expect</code><code class="p">(</code><code class="nx">scope</code><code class="p">.</code><code class="nx">searchResult</code><code class="p">.</code><code class="nx">key</code><code class="p">).</code><code class="nx">toBe</code><code class="p">(</code><code class="s2">"test"</code><code class="p">);</code>
<code class="lineno">28</code>   <code class="p">});</code>
<code class="lineno">29</code> 
<code class="lineno">30</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter5/recipe5">github</a>.</p>

<h4 id="discussion-30">Discussion</h4>
<p>Since we now have a clear separation between the service and the controller, we can simply inject the <code>TwitterAPI</code> into our <code>beforeEach</code> function.</p>

<p>Mocking with the <code>$httpBackend</code> is done as a last step in <code>beforeEach</code>. When a JSONP request happens we respond with <code>mockData</code>. After the <code>search()</code> is triggered we <code>flush()</code> the <code>httpBackend</code> in order to return our <code>mockData</code>.</p>

<p>Have a look at the <a href="http://docs.angularjs.org/api/ngMock.%24httpBackend">ngMock.$httpBackend</a> module for more details.</p>

<h2 id="urls-routing-and-partials">URLs, Routing and Partials</h2>
<p>The <a href="http://docs.angularjs.org/guide/dev_guide.services.%24location">$location service</a> in Angular.js parses the current browser URL and makes it available to your application. Changes in either the browser address bar or the <code>$location</code> service will be kept in sync.</p>

<p>Depending on the configuration, the <code>$location</code> service behaves differently and has different requirements for your application. We will first look into client-side routing with hashbang URLs since it is the default mode, and then later, look at the new HTML5-based routing.</p>

<h3 id="client-side-routing-with-hashbang-urls">Client-Side Routing with Hashbang URLs</h3>

<h4 id="problem-31">Problem</h4>
<p>You wish the browser address bar to reflect your applications page flow consistently.</p>

<h4 id="solution-31">Solution</h4>
<p>Use the <code>$routeProvider</code> and <code>$locationProvider</code> services to define your routes and the <code>ng-view</code> directive as the placeholder for the partials, which should be shown for a particular route definition.</p>

<p>The main template uses the <code>ng-view</code> directive:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;body&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;h1&gt;</code>Routing Example<code class="nt">&lt;/h1&gt;</code>
<code class="lineno">3</code>   <code class="nt">&lt;ng-view&gt;&lt;/ng-view&gt;</code>
<code class="lineno">4</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>The route configuration is implemented in <code>app.js</code> using the <code>config</code> method:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">).</code>
<code class="lineno"> 2</code>   <code class="nx">config</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">$routeProvider</code><code class="p">,</code> <code class="nx">$locationProvider</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">$locationProvider</code><code class="p">.</code><code class="nx">hashPrefix</code><code class="p">(</code><code class="s1">'!'</code><code class="p">);</code>
<code class="lineno"> 4</code>     <code class="nx">$routeProvider</code><code class="p">.</code>
<code class="lineno"> 5</code>       <code class="nx">when</code><code class="p">(</code><code class="s2">"/persons"</code><code class="p">,</code> <code class="p">{</code> <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"partials/person_list.html"</code> <code class="p">}).</code>
<code class="lineno"> 6</code>       <code class="nx">when</code><code class="p">(</code><code class="s2">"/persons/:id"</code><code class="p">,</code>
<code class="lineno"> 7</code>         <code class="p">{</code> <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"partials/person_details.html"</code><code class="p">,</code>
<code class="lineno"> 8</code>           <code class="nx">controller</code><code class="o">:</code> <code class="s2">"ShowCtrl"</code> <code class="p">}).</code>
<code class="lineno"> 9</code>       <code class="nx">otherwise</code><code class="p">(</code> <code class="p">{</code> <code class="nx">redirectTo</code><code class="o">:</code> <code class="s2">"/persons"</code> <code class="p">});</code>
<code class="lineno">10</code> <code class="p">});</code>
</pre></div>

</div>

<p>It is set up to render either the <code>person_list.html</code> or the <code>person_details.html</code> partial depending on the URL. The partial <code>person_list.html</code> renders a list of <code>persons</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;h3&gt;</code>Person List<code class="nt">&lt;/h3&gt;</code>
<code class="lineno"> 2</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"IndexCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code>   <code class="nt">&lt;table&gt;</code>
<code class="lineno"> 4</code>     <code class="nt">&lt;thead&gt;</code>
<code class="lineno"> 5</code>       <code class="nt">&lt;tr&gt;</code>
<code class="lineno"> 6</code>         <code class="nt">&lt;td&gt;</code>Name<code class="nt">&lt;/td&gt;</code>
<code class="lineno"> 7</code>         <code class="nt">&lt;td&gt;</code>Actions<code class="nt">&lt;/td&gt;</code>
<code class="lineno"> 8</code>       <code class="nt">&lt;/tr&gt;</code>
<code class="lineno"> 9</code>     <code class="nt">&lt;/thead&gt;</code>
<code class="lineno">10</code>     <code class="nt">&lt;tbody&gt;</code>
<code class="lineno">11</code>       <code class="nt">&lt;tr</code> <code class="na">ng-repeat=</code><code class="s">"person in persons"</code><code class="nt">&gt;</code>
<code class="lineno">12</code>         <code class="nt">&lt;td&gt;</code>{{person.name}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">13</code>         <code class="nt">&lt;td&gt;&lt;a</code> <code class="na">href=</code><code class="s">"#!persons/{{person.id}}"</code><code class="nt">&gt;</code>Details<code class="nt">&lt;/a&gt;&lt;/td&gt;</code>
<code class="lineno">14</code>       <code class="nt">&lt;/tr&gt;</code>
<code class="lineno">15</code>     <code class="nt">&lt;/tbody&gt;</code>
<code class="lineno">16</code>   <code class="nt">&lt;/table&gt;</code>
<code class="lineno">17</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>And the partial <code>person_details.html</code> shows more detailed information for a specific <code>person</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;h3&gt;</code>{{person.name}} Details<code class="nt">&lt;/h3&gt;</code>
<code class="lineno">2</code> <code class="nt">&lt;p&gt;</code>Name: {{person.name}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">3</code> <code class="nt">&lt;p&gt;</code>Age: {{person.age}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">4</code> 
<code class="lineno">5</code> <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"#!persons"</code><code class="nt">&gt;</code>Go back<code class="nt">&lt;/a&gt;</code>
</pre></div>

</div>

<p>This example is based on the Angular Seed Bootstrap again and will not work without starting the development server.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter6/recipe1">github</a>.</p>

<h4 id="discussion-31">Discussion</h4>
<p>Let&rsquo;s give our app a try and open the <code>index.html</code>. The <code>otherwise</code> defined route redirects us from <code>index.html</code> to <code>index.html#!/persons</code>. This is the default behavior in case other <code>when</code> conditions don&rsquo;t apply.</p>

<p>Take a closer look at the <code>index.html#!/persons</code> URL and note how the hashbang (#!) separates the <code>index.html</code> from the dynamic client-side part <code>/persons</code>. By default, Angular would use the hash (#) character but we configured it to use the hashbang instead, following Google&rsquo;s <a href="https://developers.google.com/webmasters/ajax-crawling/">Making AJAX applications crawlable</a> guide.</p>

<p>The <code>/persons</code> route loads the <code>person_list.html</code> partial via HTTP Request (that is also the reason why it won&rsquo;t work without a development server). It shows a list of persons and therefore defines a <code>ng-controller</code> directive inside the template. Let us assume for now that the controller implementation defines a <code>$scope.persons</code> somewhere. Now for each person we also render a link to show the details via <code>#!persons/{{person.id}}</code>.</p>

<p>The route definition for the person&rsquo;s details uses a placeholder <code>/persons/:id</code> which resolves to a specific person&rsquo;s details, for example <code>/persons/1</code>. The <code>person_details.html</code> partial and additionally a controller are defined for this URL. The controller will be scoped to the partial, which basically resembles our <code>index.html</code> template where we defined our own <code>ng-controller</code> directive to achieve the same effect.</p>

<p>The <code>person_details.html</code> has a back link to <code>#!persons</code> which leads back to the <code>person_list.html</code> page.</p>

<p>Let us come back to the <code>ng-view</code> directive. It is automatically bound to the router definition. Therefore you can currently use only a single <code>ng-view</code> on your page. For example, you cannot use nested <code>ng-view</code>s to achieve user interaction patterns with a first and second level navigation.</p>

<p>And finally the HTTP request for the partials happens only once and is then cached via <code>$templateCache</code> service.</p>

<p>Finally, the hashbang-based routing is client-side only and doesn&rsquo;t require server-side configuration. Let us look into the HTML5-based approach next.</p>

<h3 id="using-regular-urls-with-the-html5-history-api">Using Regular URLs with the HTML5 History API</h3>

<h4 id="problem-32">Problem</h4>
<p>You want nice looking URLs and can provide server-side support.</p>

<h4 id="solution-32">Solution</h4>
<p>We will use the same example but use the <a href="http://expressjs.com/">Express</a> framework to serve all content and handle the URL rewriting.</p>

<p>Let us start with the route configuration:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">config</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">$routeProvider</code><code class="p">,</code> <code class="nx">$locationProvider</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">$locationProvider</code><code class="p">.</code><code class="nx">html5Mode</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>   <code class="nx">$routeProvider</code><code class="p">.</code>
<code class="lineno"> 5</code>     <code class="nx">when</code><code class="p">(</code><code class="s2">"/persons"</code><code class="p">,</code>
<code class="lineno"> 6</code>       <code class="p">{</code> <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"/partials/index.jade"</code><code class="p">,</code>
<code class="lineno"> 7</code>         <code class="nx">controller</code><code class="o">:</code> <code class="s2">"PersonIndexCtrl"</code> <code class="p">}).</code>
<code class="lineno"> 8</code>     <code class="nx">when</code><code class="p">(</code><code class="s2">"/persons/:id"</code><code class="p">,</code>
<code class="lineno"> 9</code>       <code class="p">{</code> <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"/partials/show.jade"</code><code class="p">,</code>
<code class="lineno">10</code>         <code class="nx">controller</code><code class="o">:</code> <code class="s2">"PersonShowCtrl"</code> <code class="p">}).</code>
<code class="lineno">11</code>     <code class="nx">otherwise</code><code class="p">(</code> <code class="p">{</code> <code class="nx">redirectTo</code><code class="o">:</code> <code class="s2">"/persons"</code> <code class="p">});</code>
<code class="lineno">12</code> <code class="p">});</code>
</pre></div>

</div>

<p>There are no changes except for the <code>html5Mode</code> method, which enables our new routing mechanism. The Controller implementation does not change at all.</p>

<p>We have to take care of the partial loading though. Our <code>Express</code> app will have to serve the partials for us. The initial typical boilerplate for an <code>Express</code> app loads the module and creates a server:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">var</code> <code class="n">express</code> <code class="o">=</code> <code class="n">require</code><code class="p">(</code><code class="err">'</code><code class="n">express</code><code class="err">'</code><code class="p">);</code>
<code class="lineno">2</code> <code class="n">var</code> <code class="n">app</code>     <code class="o">=</code> <code class="n">module</code><code class="p">.</code><code class="n">exports</code> <code class="o">=</code> <code class="n">express</code><code class="p">.</code><code class="n">createServer</code><code class="p">();</code>
</pre></div>

</div>

<p>We will skip the configuration here and jump directly to the server-side route definition:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/partials/:name'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="kd">var</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>
<code class="lineno">3</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'partials/'</code> <code class="o">+</code> <code class="nx">name</code><code class="p">);</code>
<code class="lineno">4</code> <code class="p">});</code>
</pre></div>

</div>

<p>The <code>Express</code> route definition loads the partial with given name from the <code>partials</code> directory and renders its content.</p>

<p>When supporting HTML5 routing, our server has to redirect all other URLs to the entry point of our application, the <code>index</code> page. First we define the rendering of the <code>index</code> page, which contains the <code>ng-view</code> directive:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'index'</code><code class="p">);</code>
<code class="lineno">3</code> <code class="p">});</code>
</pre></div>

</div>

<p>Then the catch all route which redirects to the same page:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'*'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>
<code class="lineno">3</code> <code class="p">});</code>
</pre></div>

</div>

<p>Let us quickly check the partials again. Note that they use the <a href="http://jade-lang.com/">Jade</a> template engine, which relies on indentation to define the HTML document:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">p</code> <code class="n">This</code> <code class="n">is</code> <code class="n">the</code> <code class="n">index</code> <code class="n">partial</code>
<code class="lineno">2</code> <code class="nf">ul</code><code class="p">(</code><code class="n">ng</code><code class="o">-</code><code class="n">repeat</code><code class="o">=</code><code class="s">"person in persons"</code><code class="p">)</code>
<code class="lineno">3</code>   <code class="n">li</code>
<code class="lineno">4</code>     <code class="n">a</code><code class="p">(</code><code class="n">href</code><code class="o">=</code><code class="s">"/persons/{{person.id}}"</code><code class="p">){{</code><code class="n">person</code><code class="p">.</code><code class="n">name</code><code class="p">}}</code>
</pre></div>

</div>

<p>The index page creates a list of persons and the show page shows some more details:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">h3</code> <code class="n">Person</code> <code class="n">Details</code> <code class="p">{{</code><code class="n">person</code><code class="p">.</code><code class="n">name</code><code class="p">}}</code>
<code class="lineno">2</code> <code class="n">p</code> <code class="n">Age</code><code class="o">:</code> <code class="p">{{</code><code class="n">person</code><code class="p">.</code><code class="n">age</code><code class="p">}}</code>
<code class="lineno">3</code> <code class="n">a</code><code class="p">(</code><code class="n">href</code><code class="o">=</code><code class="s">"/persons"</code><code class="p">)</code> <code class="n">Back</code>
</pre></div>

</div>

<p>The person details link <code>/persons/{{person.id}}</code> and the back link <code>/persons</code> are both now much cleaner in my opinion compared to the hashbang URLs.</p>

<p>Have a look at the complete <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter6/recipe2">example on Github</a> and start the <code>Express</code> app with <code>node app.js</code>.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter6/recipe2">github</a>.</p>

<h4 id="discussion-32">Discussion</h4>
<p>If we weren&rsquo;t to redirect all requests to the root, what would happen if we were to navigate to the persons list at <code>http://localhost:3000/persons</code>? The <code>Express</code> framework would show us an error because there is no route defined for <code>persons</code>, we only defined routes for our root URL (<code>/</code>) and the partials URL <code>/partials/:name</code>. The redirect ensures that we actually end up at our root URL, which then kicks in our Angular app. When the client-side routing takes over we then redirect back to the <code>/persons</code> URL.</p>

<p>Also note how navigating to a person&rsquo;s detail page will load only the <code>show.jade</code> partial and navigating back to the <code>persons</code> list won&rsquo;t carry out any server requests. Everything our app needs is loaded once from the server and cached client-side.</p>

<p>If you have a hard time understanding the server implementation, I suggest you read the excellent <a href="http://expressjs.com/guide.html">Express Guide</a>. Additionally, there is going to be an extra chapter, which goes into more details on how to integrate Angular.js with server-side frameworks.</p>

<h3 id="using-route-location-to-implement-a-navigation-menu">Using Route Location to Implement a Navigation Menu</h3>

<h4 id="problem-33">Problem</h4>
<p>You wish to implement a navigation menu, which shows the selected menu item to the user.</p>

<h4 id="solution-33">Solution</h4>
<p>Use the <code>$location</code> service in a controller to compare the address bar URL to the navigation menu item the user selected.</p>

<p>The navigation menu is the classic ul/li menu using a class attribute to mark one of the <code>li</code> elements as <code>active</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;body</code> <code class="na">ng-controller=</code><code class="s">"MainCtrl"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;ul</code> <code class="na">class=</code><code class="s">"menu"</code><code class="nt">&gt;</code>
<code class="lineno">3</code>     <code class="nt">&lt;li</code> <code class="na">ng-class=</code><code class="s">"menuClass('persons')"</code><code class="nt">&gt;&lt;a</code> <code class="na">href=</code><code class="s">"#!persons"</code><code class="nt">&gt;</code>Home<code class="nt">&lt;/a&gt;&lt;/li&gt;</code>
<code class="lineno">4</code>     <code class="nt">&lt;li</code> <code class="na">ng-class=</code><code class="s">"menuClass('help')"</code><code class="nt">&gt;&lt;a</code> <code class="na">href=</code><code class="s">"#!help"</code><code class="nt">&gt;</code>Help<code class="nt">&lt;/a&gt;&lt;/li&gt;</code>
<code class="lineno">5</code>   <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">6</code>   ...
<code class="lineno">7</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>The controller implements the <code>menuClass</code> function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"MainCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">$location</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">menuClass</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">page</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="kd">var</code> <code class="nx">current</code> <code class="o">=</code> <code class="nx">$location</code><code class="p">.</code><code class="nx">path</code><code class="p">().</code><code class="nx">substring</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
<code class="lineno">4</code>     <code class="k">return</code> <code class="nx">page</code> <code class="o">===</code> <code class="nx">current</code> <code class="o">?</code> <code class="s2">"active"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">5</code>   <code class="p">};</code>
<code class="lineno">6</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter6/recipe3">github</a>.</p>

<h4 id="discussion-33">Discussion</h4>
<p>When the user selects a menu item the client-side navigation will kick in as expected. The <code>menuClass</code> function is bound using the <code>ngClass</code> directive and updates the CSS class automatically for us depending on the current route.</p>

<p>Using <code>$location.path()</code> we get the current route. The <code>substring</code> operation removes the leading slash (<code>/</code>) and converts <code>/persons</code> to <code>persons</code>.</p>

<h3 id="listening-on-route-changes-to-implement-a-login-mechanism">Listening on Route Changes to Implement a Login Mechanism</h3>

<h4 id="problem-34">Problem</h4>
<p>You wish to ensure that a user has to login before navigating to protected pages.</p>

<h4 id="solution-34">Solution</h4>
<p>Implement a listener on the <code>$routeChangeStart</code> event to track the next route navigation. Redirect to a login page if the user is not yet logged in.</p>

<p>The most interesting part is the implementation of the route change listener:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">).</code>
<code class="lineno"> 2</code>   <code class="nx">config</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">$routeProvider</code><code class="p">,</code> <code class="nx">$locationProvider</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">$routeProvider</code><code class="p">.</code>
<code class="lineno"> 4</code>       <code class="nx">when</code><code class="p">(</code><code class="s2">"/persons"</code><code class="p">,</code>
<code class="lineno"> 5</code>         <code class="p">{</code> <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"partials/index.html"</code> <code class="p">}).</code>
<code class="lineno"> 6</code>       <code class="nx">when</code><code class="p">(</code><code class="s2">"/login"</code><code class="p">,</code>
<code class="lineno"> 7</code>         <code class="p">{</code> <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"partials/login.html"</code><code class="p">,</code> <code class="nx">controller</code><code class="o">:</code> <code class="s2">"LoginCtrl"</code> <code class="p">}).</code>
<code class="lineno"> 8</code>       <code class="c1">// event more routes here ...</code>
<code class="lineno"> 9</code>       <code class="nx">otherwise</code><code class="p">(</code> <code class="p">{</code> <code class="nx">redirectTo</code><code class="o">:</code> <code class="s2">"/persons"</code> <code class="p">});</code>
<code class="lineno">10</code>   <code class="p">}).</code>
<code class="lineno">11</code>   <code class="nx">run</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">$rootScope</code><code class="p">,</code> <code class="nx">$location</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">12</code>     <code class="nx">$rootScope</code><code class="p">.</code><code class="nx">$on</code><code class="p">(</code> <code class="s2">"$routeChangeStart"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">event</code><code class="p">,</code> <code class="nx">next</code><code class="p">,</code> <code class="nx">current</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">13</code>       <code class="k">if</code> <code class="p">(</code><code class="nx">$rootScope</code><code class="p">.</code><code class="nx">loggedInUser</code> <code class="o">==</code> <code class="kc">null</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">14</code>         <code class="c1">// no logged user, redirect to /login</code>
<code class="lineno">15</code>         <code class="k">if</code> <code class="p">(</code> <code class="nx">next</code><code class="p">.</code><code class="nx">templateUrl</code> <code class="o">===</code> <code class="s2">"partials/login.html"</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">16</code>         <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
<code class="lineno">17</code>           <code class="nx">$location</code><code class="p">.</code><code class="nx">path</code><code class="p">(</code><code class="s2">"/login"</code><code class="p">);</code>
<code class="lineno">18</code>         <code class="p">}</code>
<code class="lineno">19</code>       <code class="p">}</code>
<code class="lineno">20</code>     <code class="p">});</code>
<code class="lineno">21</code>   <code class="p">});</code>
</pre></div>

</div>

<p>Next we will define a login form to enter the username, skipping the password for the sake of simplicity:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;form</code> <code class="na">ng-submit=</code><code class="s">"login()"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;label&gt;</code>Username<code class="nt">&lt;/label&gt;</code>
<code class="lineno">3</code>   <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"username"</code><code class="nt">&gt;</code>
<code class="lineno">4</code>   <code class="nt">&lt;button&gt;</code>Login<code class="nt">&lt;/button&gt;</code>
<code class="lineno">5</code> <code class="nt">&lt;/form&gt;</code>
</pre></div>

</div>

<p>and finally the login controller, which sets the logged in user and redirects to the persons URL:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"LoginCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">$location</code><code class="p">,</code> <code class="nx">$rootScope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">login</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">$rootScope</code><code class="p">.</code><code class="nx">loggedInUser</code> <code class="o">=</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">username</code><code class="p">;</code>
<code class="lineno">4</code>     <code class="nx">$location</code><code class="p">.</code><code class="nx">path</code><code class="p">(</code><code class="s2">"/persons"</code><code class="p">);</code>
<code class="lineno">5</code>   <code class="p">};</code>
<code class="lineno">6</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter6/recipe4">github</a>.</p>

<h4 id="discussion-34">Discussion</h4>
<p>This is of course not a fully fledged login system so please don&rsquo;t use it in any production system. But, it exemplifies how to generally handle access to specific areas of your web app. When you open the app in your browser you will be redirected to the login app in all cases. Only after you have entered a username can you access the other areas.</p>

<p>The <code>run</code> method is defined in <a href="http://docs.angularjs.org/api/angular.Module">Module</a> and is a good place for such a route change listener since it runs only once on initialization after the injector is finished loading all the modules. We check the <code>loggedInUser</code> in the <code>$rootScope</code> and if it is not set we redirect the user to the login page. Note that in order to skip this behavior when already navigating to the login page, we have to explicitly check the next <code>templateUrl</code>.</p>

<p>The login controller sets the <code>$rootScope</code> to the username and redirects to <code>/persons</code>. Generally, I try to avoid using the <code>$rootScope</code> since it basically is a kind of global state but in our case it fits nicely since there should be a current user globally available.</p>

<h2 id="using-forms">Using Forms</h2>
<p>Every website eventually uses some kind of form for users to enter data. Angular makes it particularly easy to implement client-side form validations to give immediate feedback for an improved user experience.</p>

<h3 id="implementing-a-basic-form">Implementing a Basic Form</h3>

<h4 id="problem-35">Problem</h4>
<p>You wish to create a form to enter user details and capture this information in an Angular.js scope.</p>

<h4 id="solution-35">Solution</h4>
<p>Use the standard <code>form</code> tag and the <code>ng-model</code> directive to implement a basic form:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"User"</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;form</code> <code class="na">ng-submit=</code><code class="s">"submit()"</code> <code class="na">class=</code><code class="s">"form-horizontal"</code> <code class="err">novalidate</code><code class="nt">&gt;</code>
<code class="lineno"> 4</code>       <code class="nt">&lt;label&gt;</code>Firstname<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 5</code>       <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.firstname"</code><code class="nt">/&gt;</code>
<code class="lineno"> 6</code>       <code class="nt">&lt;label&gt;</code>Lastname<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 7</code>       <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.lastname"</code><code class="nt">/&gt;</code>
<code class="lineno"> 8</code>       <code class="nt">&lt;label&gt;</code>Age<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 9</code>       <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.age"</code><code class="nt">/&gt;</code>
<code class="lineno">10</code>       <code class="nt">&lt;button</code> <code class="na">class=</code><code class="s">"btn"</code><code class="nt">&gt;</code>Submit<code class="nt">&lt;/button&gt;</code>
<code class="lineno">11</code>     <code class="nt">&lt;/form&gt;</code>
<code class="lineno">12</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">13</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>The <code>novalidate</code> attribute disables the HTML5 validations, which are client-side validations supports by modern browsers. In our example we only want the Angular.js validations running to have complete control over the look and feel.</p>

<p>The controller binds the form data to your user model and implements the <code>submit()</code> function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"User"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">user</code> <code class="o">=</code> <code class="p">{};</code>
<code class="lineno"> 5</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">wasSubmitted</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">submit</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 8</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">wasSubmitted</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 9</code>   <code class="p">};</code>
<code class="lineno">10</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter7/recipe1">github</a>.</p>

<h4 id="discussion-35">Discussion</h4>
<p>The initial idea when using forms would be to implement them in the traditional way by serialising the form data and submit it to the server. Instead we use <code>ng-model</code> to bind the form to our model, something we have been doing a lot already in previous recipes.</p>

<p>The submit button state is reflected in our <code>wasSubmitted</code> scope variable, but no submit to the server was actually done. The default behavior in Angular.js forms is to prevent the default action since we do not want to reload the whole page. We want to handle the submission in an application-specific way. In fact there is even more going on in the background and we are going to look into the behavior of the <code>form</code> or <code>ng-form</code> directive in the next recipe.</p>

<h3 id="validating-a-form-model-client-side">Validating a Form Model Client-Side</h3>

<h4 id="problem-36">Problem</h4>
<p>You wish to validate the form client-side using HTML5 form attributes.</p>

<h4 id="solution-36">Solution</h4>
<p>Angular.js works in tandem with HTML5 form attributes. Let us start with the same form but let us add some HTML5 attributes to make the input required:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;form</code> <code class="na">name=</code><code class="s">"form"</code> <code class="na">ng-submit=</code><code class="s">"submit()"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;label&gt;</code>Firstname<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 3</code>   <code class="nt">&lt;input</code> <code class="na">name=</code><code class="s">"firstname"</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.firstname"</code> <code class="err">required</code><code class="nt">/&gt;</code>
<code class="lineno"> 4</code>   <code class="nt">&lt;label&gt;</code>Lastname<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 5</code>   <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.lastname"</code> <code class="err">required</code><code class="nt">/&gt;</code>
<code class="lineno"> 6</code>   <code class="nt">&lt;label&gt;</code>Age<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 7</code>   <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.age"</code><code class="nt">/&gt;</code>
<code class="lineno"> 8</code>   <code class="nt">&lt;br&gt;</code>
<code class="lineno"> 9</code>   <code class="nt">&lt;button</code> <code class="na">class=</code><code class="s">"btn"</code><code class="nt">&gt;</code>Submit<code class="nt">&lt;/button&gt;</code>
<code class="lineno">10</code> <code class="nt">&lt;/form&gt;</code>
</pre></div>

</div>

<p>It is still the same form but this time we defined the <code>name</code> attribute on the form and made the input <code>required</code> for the firstname.</p>

<p>Let us add some more debug output below the form:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">Firstname</code> <code class="nb">input</code> <code class="nb">valid</code><code class="p">:</code> <code class="p">{{</code><code class="nx">form.firstname.</code><code class="nv">$valid</code><code class="p">}}</code>
<code class="lineno">2</code> <code class="o">&lt;</code><code class="nx">br</code><code class="o">&gt;</code>
<code class="lineno">3</code> <code class="nx">Firstname</code> <code class="nx">validation</code> <code class="nb">error</code><code class="p">:</code> <code class="p">{{</code><code class="nx">form.firstname.</code><code class="nv">$error</code><code class="p">}}</code>
<code class="lineno">4</code> <code class="o">&lt;</code><code class="nx">br</code><code class="o">&gt;</code>
<code class="lineno">5</code> <code class="nb">Form</code> <code class="nb">valid</code><code class="p">:</code> <code class="p">{{</code><code class="nx">form.</code><code class="nv">$valid</code><code class="p">}}</code>
<code class="lineno">6</code> <code class="o">&lt;</code><code class="nx">br</code><code class="o">&gt;</code>
<code class="lineno">7</code> <code class="nb">Form</code> <code class="nx">validation</code> <code class="nb">error</code><code class="p">:</code> <code class="p">{{</code><code class="nx">form.</code><code class="nv">$error</code><code class="p">}}</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter7/recipe2">github</a>.</p>

<h4 id="discussion-36">Discussion</h4>
<p>When starting with a fresh empty form, you will notice that Angular adds the css class <code>ng-pristine</code> and <code>ng-valid</code> to the form tag and each input tag. When editing the form the <code>ng-pristine</code> class will be removed from the changed input field and also from the form tag. Instead it will be replaced by the <code>ng-dirty</code> class. Very useful because it allows you to easily add new features to your app depending on these states.</p>

<p>In addition to these two css classes there are two more to look into. The <code>ng-valid</code> class will be added whenever an input is valid, otherwise the css class <code>ng-invalid</code> is added. Note that the form tag also gets either a valid or invalid class depending on the input fields. To demonstrate this I&rsquo;ve added the <code>required</code> HTML5 attribute. Initially, the firstname and lastname input fields are empty and therefore have the <code>ng-invalid</code> css class, whereas the age input field has the <code>ng-valid</code> class. Additionally, there&rsquo;s <code>ng-invalid-required</code> class alongside the <code>ng-invalid</code> for even more specificity.</p>

<p>Since we defined the <code>name</code> attribute on the form HTML element we can now access Angular&rsquo;s form controller via scope variables. In the debug output we can check the validity and specific error for each named form input and the form itself. Note that this only works on the level of the form&rsquo;s name attributes and not on the model scope. If you output the following expression <code>{{user.firstname.$error}}</code> it will not work.</p>

<p>Angular&rsquo;s form controller exposes <code>$valid</code>, <code>$invalid</code>, <code>$error</code>, <code>$pristine</code> and <code>$dirty</code> variables.</p>

<p>For validation, Angular provides built-in directives including <code>required</code>, <code>pattern</code>, <code>minlength</code>, <code>maxlength</code>, <code>min</code> and <code>max</code>.</p>

<p>Let us use Angular&rsquo;s form integration to actually show validation errors in the next recipe.</p>

<h3 id="displaying-form-validation-errors">Displaying Form Validation Errors</h3>

<h4 id="problem-37">Problem</h4>
<p>You wish to show validation errors to the user by marking the input field red and displaying an error message.</p>

<h4 id="solution-37">Solution</h4>
<p>We can use the <code>ng-show</code> directive to show an error message if a form input is invalid and CSS classes to change the input element&rsquo;s background color depending on its state.</p>

<p>Let us start with the styling changes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;style</code> <code class="na">type=</code><code class="s">"text/css"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   input.ng-invalid.ng-dirty {
<code class="lineno">3</code>     background-color: red;
<code class="lineno">4</code>   }
<code class="lineno">5</code>   input.ng-valid.ng-dirty {
<code class="lineno">6</code>     background-color: green;
<code class="lineno">7</code>   }
<code class="lineno">8</code> <code class="nt">&lt;/style&gt;</code>
</pre></div>

</div>

<p>And here is a small part of the form with an error message for the input field:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;label&gt;</code>Firstname<code class="nt">&lt;/label&gt;</code>
<code class="lineno">2</code> <code class="nt">&lt;input</code> <code class="na">name=</code><code class="s">"firstname"</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"user.firstname"</code> <code class="err">required</code><code class="nt">/&gt;</code>
<code class="lineno">3</code> <code class="nt">&lt;p</code> <code class="na">ng-show=</code><code class="s">"form.firstname.$invalid &amp;&amp; form.firstname.$dirty"</code><code class="nt">&gt;</code>
<code class="lineno">4</code>   Firstname is required
<code class="lineno">5</code> <code class="nt">&lt;/p&gt;</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter7/recipe3">github</a>.</p>

<h4 id="discussion-37">Discussion</h4>
<p>The CSS classes ensure that we initially show the fresh form without any classes. When the user starts typing in some input for the first time, we change it to either green or red. That is a good example of using the <code>ng-dirty</code> and <code>ng-invalid</code> CSS classes.</p>

<p>We use the same logic in the <code>ng-show</code> directive to only show the error message when the user starts typing for the first time.</p>

<h3 id="displaying-form-validation-errors-with-the-twitter-bootstrap-framework">Displaying Form Validation Errors with the Twitter Bootstrap framework</h3>

<h4 id="problem-38">Problem</h4>
<p>You wish to display form validation errors but the form is styled using <a href="http://twitter.github.com/bootstrap/index.html">Twitter Bootstrap</a>.</p>

<h4 id="solution-38">Solution</h4>
<p>When using the <code>.horizontal-form</code> class Twitter Bootstrap uses <code>div</code> elements to structure label, input fields and help messages into groups. The group div has the class <code>control-group</code> and the actual controls are further nested in another <code>div</code> element with the CSS class <code>controls</code>. Twitter Bootstrap shows a nice validation status when adding the CSS class <code>error</code> on the div with the <code>control-group</code> class.</p>

<p>Let us start with the form:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"User"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;form</code> <code class="na">name=</code><code class="s">"form"</code> <code class="na">ng-submit=</code><code class="s">"submit()"</code> <code class="err">novalidate</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"control-group"</code> <code class="na">ng-class=</code><code class="s">"error('firstname')"</code><code class="nt">&gt;</code>
<code class="lineno"> 5</code>       <code class="nt">&lt;label</code> <code class="na">class=</code><code class="s">"control-label"</code> <code class="na">for=</code><code class="s">"firstname"</code><code class="nt">&gt;</code>Firstname<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 6</code>       <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"controls"</code><code class="nt">&gt;</code>
<code class="lineno"> 7</code>         <code class="nt">&lt;input</code> <code class="na">id=</code><code class="s">"firstname"</code> <code class="na">name=</code><code class="s">"firstname"</code> <code class="na">type=</code><code class="s">"text"</code>
<code class="lineno"> 8</code>           <code class="na">ng-model=</code><code class="s">"user.firstname"</code> <code class="na">placeholder=</code><code class="s">"Firstname"</code> <code class="err">required</code><code class="nt">/&gt;</code>
<code class="lineno"> 9</code>         <code class="nt">&lt;span</code> <code class="na">class=</code><code class="s">"help-block"</code>
<code class="lineno">10</code>           <code class="na">ng-show=</code><code class="s">"form.firstname.$invalid &amp;&amp; form.firstname.$dirty"</code><code class="nt">&gt;</code>
<code class="lineno">11</code>           Firstname is required
<code class="lineno">12</code>         <code class="nt">&lt;/span&gt;</code>
<code class="lineno">13</code>       <code class="nt">&lt;/div&gt;</code>
<code class="lineno">14</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">15</code> 
<code class="lineno">16</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"control-group"</code> <code class="na">ng-class=</code><code class="s">"error('lastname')"</code><code class="nt">&gt;</code>
<code class="lineno">17</code>       <code class="nt">&lt;label</code> <code class="na">class=</code><code class="s">"control-label"</code> <code class="na">for=</code><code class="s">"lastname"</code><code class="nt">&gt;</code>Lastname<code class="nt">&lt;/label&gt;</code>
<code class="lineno">18</code>       <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"controls"</code><code class="nt">&gt;</code>
<code class="lineno">19</code>         <code class="nt">&lt;input</code> <code class="na">id=</code><code class="s">"lastname"</code> <code class="na">name=</code><code class="s">"lastname"</code> <code class="na">type=</code><code class="s">"text"</code>
<code class="lineno">20</code>           <code class="na">ng-model=</code><code class="s">"user.lastname"</code> <code class="na">placeholder=</code><code class="s">"Lastname"</code> <code class="err">required</code><code class="nt">/&gt;</code>
<code class="lineno">21</code>         <code class="nt">&lt;span</code> <code class="na">class=</code><code class="s">"help-block"</code>
<code class="lineno">22</code>           <code class="na">ng-show=</code><code class="s">"form.lastname.$invalid &amp;&amp; form.lastname.$dirty"</code><code class="nt">&gt;</code>
<code class="lineno">23</code>           Lastname is required
<code class="lineno">24</code>         <code class="nt">&lt;/span&gt;</code>
<code class="lineno">25</code>       <code class="nt">&lt;/div&gt;</code>
<code class="lineno">26</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">27</code> 
<code class="lineno">28</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"control-group"</code><code class="nt">&gt;</code>
<code class="lineno">29</code>       <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"controls"</code><code class="nt">&gt;</code>
<code class="lineno">30</code>         <code class="nt">&lt;button</code> <code class="na">ng-disabled=</code><code class="s">"form.$invalid"</code> <code class="na">class=</code><code class="s">"btn"</code><code class="nt">&gt;</code>Submit<code class="nt">&lt;/button&gt;</code>
<code class="lineno">31</code>       <code class="nt">&lt;/div&gt;</code>
<code class="lineno">32</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">33</code>   <code class="nt">&lt;/form&gt;</code>
<code class="lineno">34</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>Note that we use the <code>ng-class</code> directive on the <code>control-group</code> div. So let&rsquo;s look at the controller implementation of the <code>error</code> function:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"User"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="c1">// ...</code>
<code class="lineno">3</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">error</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">name</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">4</code>     <code class="kd">var</code> <code class="nx">s</code> <code class="o">=</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">form</code><code class="cp">[</code><code class="nb">name</code><code class="cp">]</code><code class="p">;</code>
<code class="lineno">5</code>     <code class="k">return</code> <code class="nx">s</code><code class="p">.</code><code class="nx">$invalid</code> <code class="o">&amp;&amp;</code> <code class="nx">s</code><code class="p">.</code><code class="nx">$dirty</code> <code class="o">?</code> <code class="s2">"error"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">6</code>   <code class="p">};</code>
<code class="lineno">7</code> <code class="p">});</code>
</pre></div>

</div>

<p>The error function gets the input name attribute passed as a string and checks for the <code>$invalid</code> and <code>$dirty</code> flags to return either the error class or a blank string.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter7/recipe4">github</a>.</p>

<h4 id="discussion-38">Discussion</h4>
<p>Again we check both the invalid and dirty flags because we only show the error message in case the user has actually changed the form. Note that this <code>ng-class</code> function usage is pretty typical in Angular since expressions do not support ternary checks.</p>

<h3 id="only-enabling-the-submit-button-if-the-form-is-valid">Only Enabling the Submit Button if the Form is Valid</h3>

<h4 id="problem-39">Problem</h4>
<p>You wish to disable the Submit button as long as the form contains invalid data.</p>

<h4 id="solution-39">Solution</h4>
<p>Use the <code>$form.invalid</code> state in combination with a <code>ng-disabled</code> directive.</p>

<p>Here is the changed submit button:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;button</code> <code class="na">ng-disabled=</code><code class="s">"form.$invalid"</code> <code class="na">class=</code><code class="s">"btn"</code><code class="nt">&gt;</code>Submit<code class="nt">&lt;/button&gt;</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter7/recipe5">github</a>.</p>

<h4 id="discussion-39">Discussion</h4>
<p>The Form Controller attributes <code>form.$invalid</code> and friends are very useful to cover all kinds of use cases which focus on the form as a whole instead of individual fields.</p>

<p>Note that you have to assign a <code>name</code> attribute to the form element, otherwise <code>form.$invalid</code> won&rsquo;t be available.</p>

<h3 id="implementing-custom-validations">Implementing Custom Validations</h3>

<h4 id="problem-40">Problem</h4>
<p>You wish to validate user input by comparing it to a blacklist of words.</p>

<h4 id="solution-40">Solution</h4>
<p>The <a href="http://angular-ui.github.com/">angular-ui</a> project offers a nice custom validation directive which lets you pass in options via expression.</p>

<p>Let us have a look at the template first with the usage of the <code>ui-validate</code> Directive:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;input</code> <code class="na">name=</code><code class="s">"firstname"</code> <code class="na">type=</code><code class="s">"text"</code>
<code class="lineno">2</code>   <code class="na">ng-model=</code><code class="s">"user.firstname"</code> <code class="err">required</code>
<code class="lineno">3</code>   <code class="na">ui-validate=</code><code class="s">" { blacklisted: 'notBlacklisted($value)' } "</code>
<code class="lineno">4</code> <code class="nt">/&gt;</code>
<code class="lineno">5</code> 
<code class="lineno">6</code> <code class="nt">&lt;p</code> <code class="na">ng-show=</code><code class="s">'form.firstname.$error.blackListed'</code><code class="nt">&gt;</code>
<code class="lineno">7</code>   This firstname is blacklisted.
<code class="lineno">8</code> <code class="nt">&lt;/p&gt;</code>
</pre></div>

</div>

<p>And the controller with the <code>notBlackListed</code> implementation:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[</code><code class="s2">"ui"</code><code class="p">,</code> <code class="s2">"ui.directives"</code><code class="cp">]</code><code class="p">);</code>
<code class="lineno">2</code> 
<code class="lineno">3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"User"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">blacklist</code> <code class="o">=</code> <code class="cp">[</code><code class="s1">'idiot'</code><code class="p">,</code><code class="s1">'loser'</code><code class="cp">]</code><code class="p">;</code>
<code class="lineno">5</code> 
<code class="lineno">6</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">notBlackListed</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">7</code>     <code class="k">return</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">blacklist</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="nx">value</code><code class="p">)</code> <code class="o">===</code> <code class="o">-</code><code class="mi">1</code><code class="p">;</code>
<code class="lineno">8</code>   <code class="p">};</code>
<code class="lineno">9</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter7/recipe6">github</a>.</p>

<h4 id="discussion-40">Discussion</h4>
<p>First we need to explicitly list our module dependency to the Angular UI directives module. Make sure you actually download the javascript file and load it via script tag.</p>

<p>Our blacklist contains the words we do not want to accept as user input and the <code>notBlackListed</code> function checks if the user input matches any of the words defined in the blacklist.</p>

<p>The <code>ui-validate</code> directive is pretty powerful since it lets you define your custom validations easily by just implementing the business logic in a controller function.</p>

<p>If you want to know even more, have a look at how to implement custom directives for yourself in Angular&rsquo;s excellent <a href="http://docs.angularjs.org/guide/forms">guide</a>.</p>

<h2 id="common-user-interface-patterns">Common User Interface Patterns</h2>

<h3 id="filtering-and-sorting-a-list">Filtering and Sorting a List</h3>

<h4 id="problem-41">Problem</h4>
<p>You wish to filter and sort a relatively small list of items all available on the client.</p>

<h4 id="solution-41">Solution</h4>
<p>For this example we will render a list of friends using the <code>ng-repeat</code> directive. Using the built-in <code>filter</code> and <code>orderBy</code> filters we will filter and sort the friends list client-side.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;form</code> <code class="na">class=</code><code class="s">"form-inline"</code><code class="nt">&gt;</code>
<code class="lineno"> 4</code>       <code class="nt">&lt;input</code> <code class="na">ng-model=</code><code class="s">"query"</code> <code class="na">type=</code><code class="s">"text"</code>
<code class="lineno"> 5</code>         <code class="na">placeholder=</code><code class="s">"Filter by"</code> <code class="err">autofocus</code><code class="nt">&gt;</code>
<code class="lineno"> 6</code>     <code class="nt">&lt;/form&gt;</code>
<code class="lineno"> 7</code>     <code class="nt">&lt;ul</code> <code class="na">ng-repeat=</code><code class="s">"friend in friends | filter:query | orderBy: 'name' "</code><code class="nt">&gt;</code>
<code class="lineno"> 8</code>       <code class="nt">&lt;li&gt;</code>{{friend.name}}<code class="nt">&lt;/li&gt;</code>
<code class="lineno"> 9</code>     <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">10</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">11</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>A plain text input field is used to enter the filter query and bound to the <code>filter</code>. Any changes are therefore directly used to filter the list.</p>

<p>The controller defines the default friends array:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"MyCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">friends</code> <code class="o">=</code> <code class="cp">[</code>
<code class="lineno"> 3</code>     <code class="p">{</code> <code class="nb">name</code><code class="p">:</code> <code class="s2">"Peter"</code><code class="p">,</code>   <code class="nx">age</code><code class="p">:</code> <code class="mi">20</code> <code class="p">},</code>
<code class="lineno"> 4</code>     <code class="p">{</code> <code class="nb">name</code><code class="p">:</code> <code class="s2">"Pablo"</code><code class="p">,</code>   <code class="nx">age</code><code class="p">:</code> <code class="mi">55</code> <code class="p">},</code>
<code class="lineno"> 5</code>     <code class="p">{</code> <code class="nb">name</code><code class="p">:</code> <code class="s2">"Linda"</code><code class="p">,</code>   <code class="nx">age</code><code class="p">:</code> <code class="mi">20</code> <code class="p">},</code>
<code class="lineno"> 6</code>     <code class="p">{</code> <code class="nb">name</code><code class="p">:</code> <code class="s2">"Marta"</code><code class="p">,</code>   <code class="nx">age</code><code class="p">:</code> <code class="mi">37</code> <code class="p">},</code>
<code class="lineno"> 7</code>     <code class="p">{</code> <code class="nb">name</code><code class="p">:</code> <code class="s2">"Othello"</code><code class="p">,</code> <code class="nx">age</code><code class="p">:</code> <code class="mi">20</code> <code class="p">},</code>
<code class="lineno"> 8</code>     <code class="p">{</code> <code class="nb">name</code><code class="p">:</code> <code class="s2">"Markus"</code><code class="p">,</code>  <code class="nx">age</code><code class="p">:</code> <code class="mi">32</code> <code class="p">}</code>
<code class="lineno"> 9</code>   <code class="cp">]</code><code class="p">;</code>
<code class="lineno">10</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe1">github</a>.</p>

<h4 id="discussion-41">Discussion</h4>
<p>Chaining filters is a fantastic way of implementing such a use case as long as you have all the data available on the client.</p>

<p>The <a href="http://docs.angularjs.org/api/ng.filter:filter">filter</a> Angular.js Filter works on an array and returns a subset of items as a new array. It supports a String, Object or Function parameter. In this example we only use the String parameter, but given that the <code>$scope.friends</code> is an array of objects we could think of more complex examples where we use the Object param, as for example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;ul</code> <code class="na">ng-repeat=</code><code class="s">"friend in friends |</code>
<code class="lineno">2</code> <code class="s">  filter: { name: query, age: '20' } |</code>
<code class="lineno">3</code> <code class="s">  orderBy: 'name' "</code><code class="nt">&gt;</code>
<code class="lineno">4</code>   <code class="nt">&lt;li&gt;</code>{{friend.name}} ({{friend.age}})<code class="nt">&lt;/li&gt;</code>
<code class="lineno">5</code> <code class="nt">&lt;/ul&gt;</code>
</pre></div>

</div>

<p>That way we can filter by name and age at the same time. And lastly you could call a function defined in the controller, which does the filtering for you:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;ul</code> <code class="na">ng-repeat=</code><code class="s">"friend in friends |</code>
<code class="lineno">2</code> <code class="s">  filter: filterFunction |</code>
<code class="lineno">3</code> <code class="s">  orderBy: 'name' "</code><code class="nt">&gt;</code>
<code class="lineno">4</code>   <code class="nt">&lt;li&gt;</code>{{friend.name}} ({{friend.age}})<code class="nt">&lt;/li&gt;</code>
<code class="lineno">5</code> <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">6</code> 
<code class="lineno">7</code> $scope.filterFunction = function(element) {
<code class="lineno">8</code>   return element.name.match(/^Ma/) ? true : false;
<code class="lineno">9</code> };
</pre></div>

</div>

<p>The <code>filterFunction</code> must return either <code>true</code> or <code>false</code>. In this example we use a regular expression on the name starting with <code>Ma</code> to filter the list.</p>

<h3 id="paginating-through-client-side-data">Paginating Through Client-Side Data</h3>

<h4 id="problem-42">Problem</h4>
<p>You have a table of data completely client-side and want to paginate through the data.</p>

<h4 id="solution-42">Solution</h4>
<p>Use an HTML table element with the <code>ng-repeat</code> directive to render only the items for the current page. All the pagination logic should be handled in a custom filter and controller implementation.</p>

<p>Let us start with the template using Twitter Bootstrap for the table and pagination elements:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"PaginationCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;table</code> <code class="na">class=</code><code class="s">"table table-striped"</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;thead&gt;</code>
<code class="lineno"> 4</code>       <code class="nt">&lt;tr&gt;</code>
<code class="lineno"> 5</code>         <code class="nt">&lt;th&gt;</code>Id<code class="nt">&lt;/th&gt;</code>
<code class="lineno"> 6</code>         <code class="nt">&lt;th&gt;</code>Name<code class="nt">&lt;/th&gt;</code>
<code class="lineno"> 7</code>         <code class="nt">&lt;th&gt;</code>Description<code class="nt">&lt;/th&gt;</code>
<code class="lineno"> 8</code>       <code class="nt">&lt;/tr&gt;</code>
<code class="lineno"> 9</code>     <code class="nt">&lt;/thead&gt;</code>
<code class="lineno">10</code>     <code class="nt">&lt;tbody&gt;</code>
<code class="lineno">11</code>       <code class="nt">&lt;tr</code> <code class="na">ng-repeat=</code><code class="s">"item in items |</code>
<code class="lineno">12</code> <code class="s">        offset: currentPage*itemsPerPage |</code>
<code class="lineno">13</code> <code class="s">        limitTo: itemsPerPage"</code><code class="nt">&gt;</code>
<code class="lineno">14</code>         <code class="nt">&lt;td&gt;</code>{{item.id}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">15</code>         <code class="nt">&lt;td&gt;</code>{{item.name}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">16</code>         <code class="nt">&lt;td&gt;</code>{{item.description}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">17</code>       <code class="nt">&lt;/tr&gt;</code>
<code class="lineno">18</code>     <code class="nt">&lt;/tbody&gt;</code>
<code class="lineno">19</code>     <code class="nt">&lt;tfoot&gt;</code>
<code class="lineno">20</code>       <code class="nt">&lt;td</code> <code class="na">colspan=</code><code class="s">"3"</code><code class="nt">&gt;</code>
<code class="lineno">21</code>         <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"pagination"</code><code class="nt">&gt;</code>
<code class="lineno">22</code>           <code class="nt">&lt;ul&gt;</code>
<code class="lineno">23</code>             <code class="nt">&lt;li</code> <code class="na">ng-class=</code><code class="s">"prevPageDisabled()"</code><code class="nt">&gt;</code>
<code class="lineno">24</code>               <code class="nt">&lt;a</code> <code class="err">href</code> <code class="na">ng-click=</code><code class="s">"prevPage()"</code><code class="nt">&gt;</code>&Acirc;&laquo; Prev<code class="nt">&lt;/a&gt;</code>
<code class="lineno">25</code>             <code class="nt">&lt;/li&gt;</code>
<code class="lineno">26</code>             <code class="nt">&lt;li</code> <code class="na">ng-repeat=</code><code class="s">"n in range()"</code>
<code class="lineno">27</code>               <code class="na">ng-class=</code><code class="s">"{active: n == currentPage}"</code> <code class="na">ng-click=</code><code class="s">"setPage(n)"</code><code class="nt">&gt;</code>
<code class="lineno">28</code>               <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"#"</code><code class="nt">&gt;</code>{{n+1}}<code class="nt">&lt;/a&gt;</code>
<code class="lineno">29</code>             <code class="nt">&lt;/li&gt;</code>
<code class="lineno">30</code>             <code class="nt">&lt;li</code> <code class="na">ng-class=</code><code class="s">"nextPageDisabled()"</code><code class="nt">&gt;</code>
<code class="lineno">31</code>               <code class="nt">&lt;a</code> <code class="err">href</code> <code class="na">ng-click=</code><code class="s">"nextPage()"</code><code class="nt">&gt;</code>Next &Acirc;&raquo;<code class="nt">&lt;/a&gt;</code>
<code class="lineno">32</code>             <code class="nt">&lt;/li&gt;</code>
<code class="lineno">33</code>           <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">34</code>         <code class="nt">&lt;/div&gt;</code>
<code class="lineno">35</code>       <code class="nt">&lt;/td&gt;</code>
<code class="lineno">36</code>     <code class="nt">&lt;/tfoot&gt;</code>
<code class="lineno">37</code>   <code class="nt">&lt;/table&gt;</code>
<code class="lineno">38</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>The <code>offset</code> Filter is responsible for selecting the subset of items for the current page. It uses the <code>slice</code> function on the Array given the start param as the index.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="s1">'offset'</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="k">return</code> <code class="kd">function</code><code class="p">(</code><code class="nx">input</code><code class="p">,</code> <code class="nx">start</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">start</code> <code class="o">=</code> <code class="nb">parseInt</code><code class="p">(</code><code class="nx">start</code><code class="p">,</code> <code class="mi">10</code><code class="p">);</code>
<code class="lineno">4</code>     <code class="k">return</code> <code class="nx">input</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="nx">start</code><code class="p">);</code>
<code class="lineno">5</code>   <code class="p">};</code>
<code class="lineno">6</code> <code class="p">});</code>
</pre></div>

</div>

<p>The controller manages the actual <code>$scope.items</code> array and handles the logic for enabling/disabling the pagination buttons.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"PaginationCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code>
<code class="lineno"> 4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="lineno"> 5</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">items</code> <code class="o">=</code> <code class="cp">[]</code><code class="p">;</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code>   <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code><code class="o">&lt;</code><code class="mi">50</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">items</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code>
<code class="lineno"> 9</code>       <code class="nx">id</code><code class="o">:</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"name "</code><code class="o">+</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">description</code><code class="o">:</code> <code class="s2">"description "</code> <code class="o">+</code> <code class="nx">i</code>
<code class="lineno">10</code>     <code class="p">});</code>
<code class="lineno">11</code>   <code class="p">}</code>
<code class="lineno">12</code> 
<code class="lineno">13</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">prevPage</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">14</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">15</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code><code class="o">--</code><code class="p">;</code>
<code class="lineno">16</code>     <code class="p">}</code>
<code class="lineno">17</code>   <code class="p">};</code>
<code class="lineno">18</code> 
<code class="lineno">19</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">prevPageDisabled</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">20</code>     <code class="k">return</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">===</code> <code class="mi">0</code> <code class="o">?</code> <code class="s2">"disabled"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">21</code>   <code class="p">};</code>
<code class="lineno">22</code> 
<code class="lineno">23</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">pageCount</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">24</code>     <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">ceil</code><code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">items</code><code class="p">.</code><code class="nx">length</code><code class="o">/</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">)</code><code class="o">-</code><code class="mi">1</code><code class="p">;</code>
<code class="lineno">25</code>   <code class="p">};</code>
<code class="lineno">26</code> 
<code class="lineno">27</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">nextPage</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">28</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">&lt;</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">pageCount</code><code class="p">())</code> <code class="p">{</code>
<code class="lineno">29</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code><code class="o">++</code><code class="p">;</code>
<code class="lineno">30</code>     <code class="p">}</code>
<code class="lineno">31</code>   <code class="p">};</code>
<code class="lineno">32</code> 
<code class="lineno">33</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">nextPageDisabled</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">34</code>     <code class="k">return</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">===</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">pageCount</code><code class="p">()</code> <code class="o">?</code> <code class="s2">"disabled"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">35</code>   <code class="p">};</code>
<code class="lineno">36</code> 
<code class="lineno">37</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe2">github</a>.</p>

<h4 id="discussion-42">Discussion</h4>
<p>The initial idea of this pagination solution can be best explained by looking into the usage of <code>ng-repeat</code> to render the table rows for each item:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;tr</code> <code class="na">ng-repeat=</code><code class="s">"item in items |</code>
<code class="lineno">2</code> <code class="s">  offset: currentPage*itemsPerPage |</code>
<code class="lineno">3</code> <code class="s">  limitTo: itemsPerPage"</code><code class="nt">&gt;</code>
<code class="lineno">4</code>   <code class="nt">&lt;td&gt;</code>{{item.id}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">5</code>   <code class="nt">&lt;td&gt;</code>{{item.name}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">6</code>   <code class="nt">&lt;td&gt;</code>{{item.description}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">7</code> <code class="nt">&lt;/tr&gt;</code>
</pre></div>

</div>

<p>The <code>offset</code> filter uses the <code>currentPage*itemsPerPage</code> to calculate the offset for the array slice operation. This will generate an array from the offset to the end of the array. Then we use the built-in <code>limitTo</code> filter to subset the array to the number of <code>itemsPerPage</code>. All this is done on the client side with filters only.</p>

<p>The controller is responsible for supporting a <code>nextPage</code> and <code>prevPage</code> action and the accompanying functions to check the disabled state of these actions via <code>ng-class</code> directive: <code>nextPageDisabled</code> and <code>prevPageDisabled</code>. The <code>prevPage</code> function first checks if it has not reached the first page yet before decrementing the <code>currentPage</code> and the <code>nextPage</code> does the same for the last page and the same logic is applied for the disabled checks.</p>

<p>This example is already quite involved and I intentionally omitted an explanation of the rendering of links between the previous and next buttons. The <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe2">full implementation</a> is online though for you to investigate.</p>

<h3 id="paginating-through-server-side-data">Paginating Through Server-Side Data</h3>

<h4 id="problem-43">Problem</h4>
<p>You wish to paginate through a large server-side result set.</p>

<h4 id="solution-43">Solution</h4>
<p>You cannot use the previous method with a filter since that would require all data to be available on the client. Instead we use an implementation with a controller only instead.</p>

<p>The template has not changed much. Only the <code>ng-repeat</code> directive looks simpler now:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;tr</code> <code class="na">ng-repeat=</code><code class="s">"item in pagedItems"</code><code class="nt">&gt;</code>
<code class="lineno">2</code>   <code class="nt">&lt;td&gt;</code>{{item.id}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">3</code>   <code class="nt">&lt;td&gt;</code>{{item.name}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">4</code>   <code class="nt">&lt;td&gt;</code>{{item.description}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">5</code> <code class="nt">&lt;/tr&gt;</code>
</pre></div>

</div>

<p>In order to simplify the example we will fake a server-side service by providing an Angular service implementation for the items.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s2">"Item"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>   <code class="kd">var</code> <code class="nx">items</code> <code class="o">=</code> <code class="cp">[]</code><code class="p">;</code>
<code class="lineno"> 4</code>   <code class="k">for</code> <code class="p">(</code><code class="kd">var</code> <code class="nx">i</code><code class="o">=</code><code class="mi">0</code><code class="p">;</code> <code class="nx">i</code><code class="o">&lt;</code><code class="mi">50</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="nx">items</code><code class="p">.</code><code class="nx">push</code><code class="p">({</code>
<code class="lineno"> 6</code>       <code class="nx">id</code><code class="o">:</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">name</code><code class="o">:</code> <code class="s2">"name "</code><code class="o">+</code> <code class="nx">i</code><code class="p">,</code> <code class="nx">description</code><code class="o">:</code> <code class="s2">"description "</code> <code class="o">+</code> <code class="nx">i</code>
<code class="lineno"> 7</code>     <code class="p">});</code>
<code class="lineno"> 8</code>   <code class="p">}</code>
<code class="lineno"> 9</code> 
<code class="lineno">10</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno">11</code>     <code class="nx">get</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">offset</code><code class="p">,</code> <code class="nx">limit</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">12</code>       <code class="k">return</code> <code class="nx">items</code><code class="p">.</code><code class="nx">slice</code><code class="p">(</code><code class="nx">offset</code><code class="p">,</code> <code class="nx">offset</code><code class="o">+</code><code class="nx">limit</code><code class="p">);</code>
<code class="lineno">13</code>     <code class="p">},</code>
<code class="lineno">14</code>     <code class="nx">total</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">15</code>       <code class="k">return</code> <code class="nx">items</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>
<code class="lineno">16</code>     <code class="p">}</code>
<code class="lineno">17</code>   <code class="p">};</code>
<code class="lineno">18</code> <code class="p">});</code>
</pre></div>

</div>

<p>The service manages a list of items and has methods for retrieving a subset of items for a given offset and limit and the total number of items.</p>

<p>The controller uses dependency injection to access the <code>Item</code> service and contains almost the same methods as our previous recipe.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"PaginationCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">Item</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code>
<code class="lineno"> 4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">prevPage</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 7</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 8</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code><code class="o">--</code><code class="p">;</code>
<code class="lineno"> 9</code>     <code class="p">}</code>
<code class="lineno">10</code>   <code class="p">};</code>
<code class="lineno">11</code> 
<code class="lineno">12</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">prevPageDisabled</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">13</code>     <code class="k">return</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">===</code> <code class="mi">0</code> <code class="o">?</code> <code class="s2">"disabled"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">14</code>   <code class="p">};</code>
<code class="lineno">15</code> 
<code class="lineno">16</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">nextPage</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">17</code>     <code class="k">if</code> <code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">&lt;</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">pageCount</code><code class="p">()</code> <code class="o">-</code> <code class="mi">1</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">18</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code><code class="o">++</code><code class="p">;</code>
<code class="lineno">19</code>     <code class="p">}</code>
<code class="lineno">20</code>   <code class="p">};</code>
<code class="lineno">21</code> 
<code class="lineno">22</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">nextPageDisabled</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">23</code>     <code class="k">return</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">===</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">pageCount</code><code class="p">()</code> <code class="o">-</code> <code class="mi">1</code> <code class="o">?</code> <code class="s2">"disabled"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">24</code>   <code class="p">};</code>
<code class="lineno">25</code> 
<code class="lineno">26</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">pageCount</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">27</code>     <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">ceil</code><code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">total</code><code class="o">/</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">);</code>
<code class="lineno">28</code>   <code class="p">};</code>
<code class="lineno">29</code> 
<code class="lineno">30</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">$watch</code><code class="p">(</code><code class="s2">"currentPage"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">newValue</code><code class="p">,</code> <code class="nx">oldValue</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">31</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">pagedItems</code> <code class="o">=</code>
<code class="lineno">32</code>       <code class="nx">Item</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">newValue</code><code class="o">*</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">,</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">);</code>
<code class="lineno">33</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">total</code> <code class="o">=</code> <code class="nx">Item</code><code class="p">.</code><code class="nx">total</code><code class="p">();</code>
<code class="lineno">34</code>   <code class="p">});</code>
<code class="lineno">35</code> 
<code class="lineno">36</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe3">github</a>.</p>

<h4 id="discussion-43">Discussion</h4>
<p>When you select the next/previous page you will change the <code>$scope.currentPage</code> value and the <code>$watch</code> function is triggered. It fetches fresh items for the current page and the total number of items. So, on the client side we only have five items available as defined in <code>itemsPerPage</code> and when paginating we throw away the items of the previous page and fetch new items.</p>

<p>If you want to try this with a real backend you only have to swap out the <code>Item</code> service implementation.</p>

<h3 id="paginating-using-infinite-results">Paginating Using Infinite Results</h3>

<h4 id="problem-44">Problem</h4>
<p>You wish to paginate through server-side data with a &ldquo;Load More&rdquo; button, which just keeps appending more data until no more data is available.</p>

<h4 id="solution-44">Solution</h4>
<p>Let&rsquo;s start by looking at how the item table is rendered with the <code>ng-repeat</code> Directive.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;div</code> <code class="na">ng-controller=</code><code class="s">"PaginationCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;table</code> <code class="na">class=</code><code class="s">"table table-striped"</code><code class="nt">&gt;</code>
<code class="lineno"> 3</code>     <code class="nt">&lt;thead&gt;</code>
<code class="lineno"> 4</code>       <code class="nt">&lt;tr&gt;</code>
<code class="lineno"> 5</code>         <code class="nt">&lt;th&gt;</code>Id<code class="nt">&lt;/th&gt;</code>
<code class="lineno"> 6</code>         <code class="nt">&lt;th&gt;</code>Name<code class="nt">&lt;/th&gt;</code>
<code class="lineno"> 7</code>         <code class="nt">&lt;th&gt;</code>Description<code class="nt">&lt;/th&gt;</code>
<code class="lineno"> 8</code>       <code class="nt">&lt;/tr&gt;</code>
<code class="lineno"> 9</code>     <code class="nt">&lt;/thead&gt;</code>
<code class="lineno">10</code>     <code class="nt">&lt;tbody&gt;</code>
<code class="lineno">11</code>       <code class="nt">&lt;tr</code> <code class="na">ng-repeat=</code><code class="s">"item in pagedItems"</code><code class="nt">&gt;</code>
<code class="lineno">12</code>         <code class="nt">&lt;td&gt;</code>{{item.id}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">13</code>         <code class="nt">&lt;td&gt;</code>{{item.name}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">14</code>         <code class="nt">&lt;td&gt;</code>{{item.description}}<code class="nt">&lt;/td&gt;</code>
<code class="lineno">15</code>       <code class="nt">&lt;/tr&gt;</code>
<code class="lineno">16</code>     <code class="nt">&lt;/tbody&gt;</code>
<code class="lineno">17</code>     <code class="nt">&lt;tfoot&gt;</code>
<code class="lineno">18</code>       <code class="nt">&lt;td</code> <code class="na">colspan=</code><code class="s">"3"</code><code class="nt">&gt;</code>
<code class="lineno">19</code>         <code class="nt">&lt;button</code> <code class="na">class=</code><code class="s">"btn"</code> <code class="na">href=</code><code class="s">"#"</code> <code class="na">ng-class=</code><code class="s">"nextPageDisabledClass()"</code>
<code class="lineno">20</code>           <code class="na">ng-click=</code><code class="s">"loadMore()"</code><code class="nt">&gt;</code>Load More<code class="nt">&lt;/button&gt;</code>
<code class="lineno">21</code>       <code class="nt">&lt;/td&gt;</code>
<code class="lineno">22</code>     <code class="nt">&lt;/tfoot&gt;</code>
<code class="lineno">23</code>   <code class="nt">&lt;/table&gt;</code>
<code class="lineno">24</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>The controller uses the same <code>Item</code> Service as used for the previous recipe and handles the logic for the &ldquo;Load More&rdquo; button.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"PaginationCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">Item</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code>
<code class="lineno"> 4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="lineno"> 5</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">total</code> <code class="o">=</code> <code class="nx">Item</code><code class="p">.</code><code class="nx">total</code><code class="p">();</code>
<code class="lineno"> 6</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">pagedItems</code> <code class="o">=</code> <code class="nx">Item</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code><code class="o">*</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">,</code>
<code class="lineno"> 7</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">);</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">loadMore</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">10</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code><code class="o">++</code><code class="p">;</code>
<code class="lineno">11</code>     <code class="kd">var</code> <code class="nx">newItems</code> <code class="o">=</code> <code class="nx">Item</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code><code class="o">*</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">,</code>
<code class="lineno">12</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">);</code>
<code class="lineno">13</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">pagedItems</code> <code class="o">=</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">pagedItems</code><code class="p">.</code><code class="nx">concat</code><code class="p">(</code><code class="nx">newItems</code><code class="p">);</code>
<code class="lineno">14</code>   <code class="p">};</code>
<code class="lineno">15</code> 
<code class="lineno">16</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">nextPageDisabledClass</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">17</code>     <code class="k">return</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">currentPage</code> <code class="o">===</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">pageCount</code><code class="p">()</code><code class="o">-</code><code class="mi">1</code> <code class="o">?</code> <code class="s2">"disabled"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">18</code>   <code class="p">};</code>
<code class="lineno">19</code> 
<code class="lineno">20</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">pageCount</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">21</code>     <code class="k">return</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">ceil</code><code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">total</code><code class="o">/</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">itemsPerPage</code><code class="p">);</code>
<code class="lineno">22</code>   <code class="p">};</code>
<code class="lineno">23</code> 
<code class="lineno">24</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe4">github</a>.</p>

<h4 id="discussion-44">Discussion</h4>
<p>The solution is actually pretty similar to the previous recipe and uses a controller only again. The <code>$scope.pagedItems</code> is retrieved initially to render the first five items.</p>

<p>When pressing the &ldquo;Load More&rdquo; button we fetch another set of items incrementing the <code>currentPage</code> to change the <code>offset</code> of the <code>Item.get</code> function. The new items will be concatenated with the existing items using the Array <code>concat</code> function. The changes to <code>pagedItems</code> will be automatically rendered by the <code>ng-repeat</code> directive.</p>

<p>The <code>nextPageDisabledClass</code> checks whether there is more data available by calculating the total number of pages in <code>pageCount</code> and comparing that to the current page.</p>

<h3 id="displaying-a-flash-noticefailure-message">Displaying a Flash Notice/Failure Message</h3>

<h4 id="problem-45">Problem</h4>
<p>You wish to display a flash confirmation message after a user submitted a form successfully.</p>

<h4 id="solution-45">Solution</h4>
<p>In a web framework like Ruby on Rails, the form submit will lead to a redirect with the flash confirmation message, relying on the browser session. For our client-side approach we bind to route changes and manage a queue of flash messages.</p>

<p>In our example we use a home page with a form and on form submit we navigate to another page and show the flash message. We use the <code>ng-view</code> Directive and define the two pages as script tags here.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code>   <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>     <code class="nt">&lt;ul</code> <code class="na">class=</code><code class="s">"nav nav-pills"</code><code class="nt">&gt;</code>
<code class="lineno"> 4</code>       <code class="nt">&lt;li&gt;&lt;a</code> <code class="na">href=</code><code class="s">"#/"</code><code class="nt">&gt;</code>Home<code class="nt">&lt;/a&gt;&lt;/li&gt;</code>
<code class="lineno"> 5</code>       <code class="nt">&lt;li&gt;&lt;a</code> <code class="na">href=</code><code class="s">"#/page"</code><code class="nt">&gt;</code>Next Page<code class="nt">&lt;/a&gt;&lt;/li&gt;</code>
<code class="lineno"> 6</code>     <code class="nt">&lt;/ul&gt;</code>
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"alert"</code> <code class="na">ng-show=</code><code class="s">"flash.getMessage()"</code><code class="nt">&gt;</code>
<code class="lineno"> 9</code>       <code class="nt">&lt;b&gt;</code>Alert!<code class="nt">&lt;/b&gt;</code>
<code class="lineno">10</code>       <code class="nt">&lt;p&gt;</code>{{flash.getMessage()}}<code class="nt">&lt;/p&gt;</code>
<code class="lineno">11</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">12</code> 
<code class="lineno">13</code>     <code class="nt">&lt;ng-view&gt;&lt;/ng-view&gt;</code>
<code class="lineno">14</code> 
<code class="lineno">15</code>     <code class="nt">&lt;script</code> <code class="na">type=</code><code class="s">"text/ng-template"</code> <code class="na">id=</code><code class="s">"home.html"</code><code class="nt">&gt;</code>
<code class="lineno">16</code>       <code class="nt">&lt;h3&gt;</code>Home<code class="nt">&lt;/h3&gt;</code>
<code class="lineno">17</code> 
<code class="lineno">18</code>       <code class="nt">&lt;form</code> <code class="na">ng-submit=</code><code class="s">"submit(message)"</code> <code class="na">class=</code><code class="s">"form-inline"</code><code class="nt">&gt;</code>
<code class="lineno">19</code>         <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">ng-model=</code><code class="s">"message"</code> <code class="err">autofocus</code><code class="nt">&gt;</code>
<code class="lineno">20</code>         <code class="nt">&lt;button</code> <code class="na">class=</code><code class="s">"btn"</code><code class="nt">&gt;</code>Submit<code class="nt">&lt;/button&gt;</code>
<code class="lineno">21</code>       <code class="nt">&lt;/form&gt;</code>
<code class="lineno">22</code> 
<code class="lineno">23</code>     <code class="nt">&lt;/script&gt;</code>
<code class="lineno">24</code> 
<code class="lineno">25</code>     <code class="nt">&lt;script</code> <code class="na">type=</code><code class="s">"text/ng-template"</code> <code class="na">id=</code><code class="s">"page.html"</code><code class="nt">&gt;</code>
<code class="lineno">26</code>       <code class="nt">&lt;h3&gt;</code>Next Page<code class="nt">&lt;/h3&gt;</code>
<code class="lineno">27</code> 
<code class="lineno">28</code>     <code class="nt">&lt;/script&gt;</code>
<code class="lineno">29</code> 
<code class="lineno">30</code>   <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>Note that the flash message just like the navigation is always shown but conditionally hidden depending on whether there is a flash message available.</p>

<p>The route definition defines the pages, nothing new here for us:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[]</code><code class="p">);</code>
<code class="lineno">2</code> 
<code class="lineno">3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">config</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">$routeProvider</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">4</code>   <code class="nx">$routeProvider</code><code class="p">.</code>
<code class="lineno">5</code>     <code class="nx">when</code><code class="p">(</code><code class="s2">"/home"</code><code class="p">,</code> <code class="p">{</code> <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"home.html"</code> <code class="p">}).</code>
<code class="lineno">6</code>     <code class="nx">when</code><code class="p">(</code><code class="s2">"/page"</code><code class="p">,</code> <code class="p">{</code> <code class="nx">templateUrl</code><code class="o">:</code> <code class="s2">"page.html"</code> <code class="p">}).</code>
<code class="lineno">7</code>     <code class="nx">otherwise</code><code class="p">({</code> <code class="nx">redirectTo</code><code class="o">:</code> <code class="s2">"/home"</code> <code class="p">});</code>
<code class="lineno">8</code> <code class="p">});</code>
</pre></div>

</div>

<p>The interesting part is the <code>flash</code> service, which handles a queue of messages and listens for route changes to provide a message from the queue to the current page.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s2">"flash"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$rootScope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="kd">var</code> <code class="nx">queue</code> <code class="o">=</code> <code class="cp">[]</code><code class="p">;</code>
<code class="lineno"> 3</code>   <code class="kd">var</code> <code class="nx">currentMessage</code> <code class="o">=</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code>   <code class="nx">$rootScope</code><code class="p">.</code><code class="nx">$on</code><code class="p">(</code><code class="s2">"$routeChangeSuccess"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 6</code>     <code class="nx">currentMessage</code> <code class="o">=</code> <code class="nx">queue</code><code class="p">.</code><code class="nx">shift</code><code class="p">()</code> <code class="o">||</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno"> 7</code>   <code class="p">});</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno">10</code>     <code class="nx">setMessage</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">message</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">11</code>       <code class="nx">queue</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">message</code><code class="p">);</code>
<code class="lineno">12</code>     <code class="p">},</code>
<code class="lineno">13</code>     <code class="nx">getMessage</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">14</code>       <code class="k">return</code> <code class="nx">currentMessage</code><code class="p">;</code>
<code class="lineno">15</code>     <code class="p">}</code>
<code class="lineno">16</code>   <code class="p">};</code>
<code class="lineno">17</code> <code class="p">});</code>
</pre></div>

</div>

<p>The controller handles the form submit and navigates to the other page.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"MyCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">$location</code><code class="p">,</code> <code class="nx">flash</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">flash</code> <code class="o">=</code> <code class="nx">flash</code><code class="p">;</code>
<code class="lineno">3</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">message</code> <code class="o">=</code> <code class="s2">"Hello World"</code><code class="p">;</code>
<code class="lineno">4</code> 
<code class="lineno">5</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">submit</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">message</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">6</code>     <code class="nx">flash</code><code class="p">.</code><code class="nx">setMessage</code><code class="p">(</code><code class="nx">message</code><code class="p">);</code>
<code class="lineno">7</code>     <code class="nx">$location</code><code class="p">.</code><code class="nx">path</code><code class="p">(</code><code class="s2">"/page"</code><code class="p">);</code>
<code class="lineno">8</code>   <code class="p">}</code>
<code class="lineno">9</code> <code class="p">});</code>
</pre></div>

</div>

<p>The flash service is dependency-injected into the controller and made available to the scope since we want to use it in our template.</p>

<p>When you press the submit button you will be navigated to the other page and see the flash message. Note that using the navigation to go back and forth between pages doesn&rsquo;t show the flash message.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe5">github</a>.</p>

<h4 id="discussion-45">Discussion</h4>
<p>The controller uses the <code>setMessage</code> function of the <code>flash</code> service and the service stores the message in an array called <code>queue</code>. When the controller then uses <code>$location</code> service to navigate the service <code>routeChangeSuccess</code> listener will be called and retrieves the message from the queue.</p>

<p>In the template we use <code>ng-show</code> to hide the div element with the flash messaging using <code>flash.getMessage()</code>.</p>

<p>Since this is a service it can be used anywhere in your code and it will show a flash message on the next route change.</p>

<h3 id="editing-text-in-place-using-html5-contenteditable">Editing Text In-Place using HTML5 ContentEditable</h3>

<h4 id="problem-46">Problem</h4>
<p>You wish to make a div element editable in place using the HTML5 contenteditable attribute.</p>

<h4 id="solution-46">Solution</h4>
<p>Implement a directive for the <code>contenteditable</code> attribute and use <code>ng-model</code> for data binding.</p>

<p>In this example we use a div and a paragraph to render the content.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nt">&lt;div</code> <code class="err">contenteditable</code> <code class="na">ng-model=</code><code class="s">"text"</code><code class="nt">&gt;&lt;/div&gt;</code>
<code class="lineno">2</code> <code class="nt">&lt;p&gt;</code>{{text}}<code class="nt">&lt;/p&gt;</code>
</pre></div>

</div>

<p>The directive is especially interesting since it uses <code>ng-model</code> instead of custom attributes.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">directive</code><code class="p">(</code><code class="s2">"contenteditable"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">return</code> <code class="p">{</code>
<code class="lineno"> 3</code>     <code class="nx">restrict</code><code class="o">:</code> <code class="s2">"A"</code><code class="p">,</code>
<code class="lineno"> 4</code>     <code class="nx">require</code><code class="o">:</code> <code class="s2">"ngModel"</code><code class="p">,</code>
<code class="lineno"> 5</code>     <code class="nx">link</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">scope</code><code class="p">,</code> <code class="nx">element</code><code class="p">,</code> <code class="nx">attrs</code><code class="p">,</code> <code class="nx">ngModel</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code>       <code class="kd">function</code> <code class="nx">read</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 8</code>         <code class="nx">ngModel</code><code class="p">.</code><code class="nx">$setViewValue</code><code class="p">(</code><code class="nx">element</code><code class="p">.</code><code class="nx">html</code><code class="p">());</code>
<code class="lineno"> 9</code>       <code class="p">}</code>
<code class="lineno">10</code> 
<code class="lineno">11</code>       <code class="nx">ngModel</code><code class="p">.</code><code class="nx">$render</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">12</code>         <code class="nx">element</code><code class="p">.</code><code class="nx">html</code><code class="p">(</code><code class="nx">ngModel</code><code class="p">.</code><code class="nx">$viewValue</code> <code class="o">||</code> <code class="s2">""</code><code class="p">);</code>
<code class="lineno">13</code>       <code class="p">};</code>
<code class="lineno">14</code> 
<code class="lineno">15</code>       <code class="nx">element</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="s2">"blur keyup change"</code><code class="p">,</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">16</code>         <code class="nx">scope</code><code class="p">.</code><code class="nx">$apply</code><code class="p">(</code><code class="nx">read</code><code class="p">);</code>
<code class="lineno">17</code>       <code class="p">});</code>
<code class="lineno">18</code>     <code class="p">}</code>
<code class="lineno">19</code>   <code class="p">};</code>
<code class="lineno">20</code> <code class="p">});</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe6">github</a>.</p>

<h4 id="discussion-46">Discussion</h4>
<p>The directive is restricted for usage as an HTML attribute since we want to use the HTML5 contenteditable attribute as it is instead of defining a new HTML element.</p>

<p>It requires the <code>ngModel</code> controller for data binding in conjunction with the link function. The implementation binds an event listener, which executes the <code>read</code> function with <a href="http://docs.angularjs.org/api/ng.%24rootScope.Scope">apply</a>. This ensures that even though we call the <code>read</code> function from within a DOM event handler we notify Angular about it.</p>

<p>The <code>read</code> function updates the model based on the view&rsquo;s user input. And the <code>$render</code> function is doing the same in the other direction, updating the view for us whenever the model changes.</p>

<p>The directive is surprisingly simple, leaving the <code>ng-model</code> aside. But without the <code>ng-model</code> support we would have to come up with our own model-attribute handling which would not be consistent with other directives.</p>

<h3 id="displaying-a-modal-dialog">Displaying a Modal Dialog</h3>

<h4 id="question">Question</h4>
<p>You wish to use a Modal Dialog using the Twitter Bootstrap Framework. A dialog is called modal when it is blocking the rest of your web application until it is closed.</p>

<h4 id="solution-47">Solution</h4>
<p>Use the <code>angular-ui</code> module&rsquo;s nice <code>modal</code> plugin, which directly supports Twitter Bootstrap.</p>

<p>The template defines a button to open the modal and the modal code itself.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>   <code class="nt">&lt;button</code> <code class="na">class=</code><code class="s">"btn"</code> <code class="na">ng-click=</code><code class="s">"open()"</code><code class="nt">&gt;</code>Open Modal<code class="nt">&lt;/button&gt;</code>
<code class="lineno"> 4</code> 
<code class="lineno"> 5</code>   <code class="nt">&lt;div</code> <code class="na">modal=</code><code class="s">"showModal"</code> <code class="na">close=</code><code class="s">"cancel()"</code><code class="nt">&gt;</code>
<code class="lineno"> 6</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"modal-header"</code><code class="nt">&gt;</code>
<code class="lineno"> 7</code>         <code class="nt">&lt;h4&gt;</code>Modal Dialog<code class="nt">&lt;/h4&gt;</code>
<code class="lineno"> 8</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno"> 9</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"modal-body"</code><code class="nt">&gt;</code>
<code class="lineno">10</code>         <code class="nt">&lt;p&gt;</code>Example paragraph with some text.<code class="nt">&lt;/p&gt;</code>
<code class="lineno">11</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">12</code>     <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"modal-footer"</code><code class="nt">&gt;</code>
<code class="lineno">13</code>       <code class="nt">&lt;button</code> <code class="na">class=</code><code class="s">"btn btn-success"</code> <code class="na">ng-click=</code><code class="s">"ok()"</code><code class="nt">&gt;</code>Okay<code class="nt">&lt;/button&gt;</code>
<code class="lineno">14</code>       <code class="nt">&lt;button</code> <code class="na">class=</code><code class="s">"btn"</code> <code class="na">ng-click=</code><code class="s">"cancel()"</code><code class="nt">&gt;</code>Cancel<code class="nt">&lt;/button&gt;</code>
<code class="lineno">15</code>     <code class="nt">&lt;/div&gt;</code>
<code class="lineno">16</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">17</code> 
<code class="lineno">18</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>Note that even though we don&rsquo;t specify it explicitly the modal dialog is hidden initially via the <code>modal</code> attribute. The controller only handles the button click and the <code>showModal</code> value used by the <code>modal</code> attribute.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[</code><code class="s2">"ui.bootstrap.modal"</code><code class="cp">]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">open</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">showModal</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 5</code> <code class="p">};</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">ok</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno"> 8</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">showModal</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno"> 9</code> <code class="p">};</code>
<code class="lineno">10</code> 
<code class="lineno">11</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">cancel</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">12</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">showModal</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
<code class="lineno">13</code> <code class="p">};</code>
</pre></div>

</div>

<p>Do not forget to download and include the angular-ui.js file in a script tag. The module dependency is defined directly to &ldquo;ui.bootstrap.modal&rdquo;. The <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe7">full example</a> is available on Github including the angular-ui module.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe7">github</a>.</p>

<h4 id="discussion-47">Discussion</h4>
<p>The modal as defined in the template is straight from the Twitter bootstrap <a href="http://twitter.github.com/bootstrap/javascript.html#modals">documentation</a>. We can control the visibility with the <code>modal</code> attribute. Additionally, the <code>close</code> attribute defines a <code>close</code> function which is called whenever the dialog is closed. Note that this could happen if the user presses the <code>escape</code> key or clicking outside the modal.</p>

<p>Our own cancel button uses the same function to close the modal manually, whereas the okay button uses the <code>ok</code> function. This makes it easy for us to distinguish between a user who simply cancelled the modal or actually pressed the okay button.</p>

<h3 id="displaying-a-loading-spinner">Displaying a Loading Spinner</h3>

<h4 id="problem-47">Problem</h4>
<p>You wish to display a loading spinner while waiting for an AJAX request to be finished.</p>

<h4 id="solution-48">Solution</h4>
<p>We will use the Twitter search API for our example to render a list of search results. When pressing the button the AJAX request is run and the spinner image should be shown until the request is done.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;body</code> <code class="na">ng-app=</code><code class="s">"MyApp"</code> <code class="na">ng-controller=</code><code class="s">"MyCtrl"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>   <code class="nt">&lt;div&gt;</code>
<code class="lineno"> 4</code>     <code class="nt">&lt;button</code> <code class="na">class=</code><code class="s">"btn"</code> <code class="na">ng-click=</code><code class="s">"load()"</code><code class="nt">&gt;</code>Load Tweets<code class="nt">&lt;/button&gt;</code>
<code class="lineno"> 5</code>     <code class="nt">&lt;img</code> <code class="na">id=</code><code class="s">"spinner"</code> <code class="na">ng-src=</code><code class="s">"img/spinner.gif"</code> <code class="na">style=</code><code class="s">"display:none;"</code><code class="nt">&gt;</code>
<code class="lineno"> 6</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno"> 7</code> 
<code class="lineno"> 8</code>   <code class="nt">&lt;div&gt;</code>
<code class="lineno"> 9</code>     <code class="nt">&lt;ul</code> <code class="na">ng-repeat=</code><code class="s">"tweet in tweets"</code><code class="nt">&gt;</code>
<code class="lineno">10</code>       <code class="nt">&lt;li&gt;</code>
<code class="lineno">11</code>         <code class="nt">&lt;img</code> <code class="na">ng-src=</code><code class="s">"{{tweet.profile_image_url}}"</code> <code class="na">alt=</code><code class="s">""</code><code class="nt">&gt;</code>
<code class="lineno">12</code>         <code class="ni">&amp;nbsp;</code> {{tweet.from_user}}
<code class="lineno">13</code>         {{tweet.text}}
<code class="lineno">14</code>       <code class="nt">&lt;/li&gt;</code>
<code class="lineno">15</code>     <code class="nt">&lt;/ul&gt;</code>
<code class="lineno">16</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">17</code> 
<code class="lineno">18</code> <code class="nt">&lt;/body&gt;</code>
</pre></div>

</div>

<p>An Angular.js interceptor for all AJAX calls is used, which allows you to execute code before the actual request is started and when it is finished.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"MyApp"</code><code class="p">,</code> <code class="cp">[</code><code class="s2">"ngResource"</code><code class="cp">]</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="nx">app</code><code class="p">.</code><code class="nx">config</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">$httpProvider</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="nx">$httpProvider</code><code class="p">.</code><code class="nx">responseInterceptors</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="s1">'myHttpInterceptor'</code><code class="p">);</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code>   <code class="kd">var</code> <code class="nx">spinnerFunction</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">spinnerFunction</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="nx">headersGetter</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 7</code>     <code class="nx">$</code><code class="p">(</code><code class="s2">"#spinner"</code><code class="p">).</code><code class="nx">show</code><code class="p">();</code>
<code class="lineno"> 8</code>     <code class="k">return</code> <code class="nx">data</code><code class="p">;</code>
<code class="lineno"> 9</code>   <code class="p">};</code>
<code class="lineno">10</code> 
<code class="lineno">11</code>   <code class="nx">$httpProvider</code><code class="p">.</code><code class="nx">defaults</code><code class="p">.</code><code class="nx">transformRequest</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">spinnerFunction</code><code class="p">);</code>
<code class="lineno">12</code> <code class="p">});</code>
<code class="lineno">13</code> 
<code class="lineno">14</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s1">'myHttpInterceptor'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">$q</code><code class="p">,</code> <code class="nx">$window</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">15</code>   <code class="k">return</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">promise</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">16</code>     <code class="k">return</code> <code class="nx">promise</code><code class="p">.</code><code class="nx">then</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">response</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">17</code>       <code class="nx">$</code><code class="p">(</code><code class="s2">"#spinner"</code><code class="p">).</code><code class="nx">hide</code><code class="p">();</code>
<code class="lineno">18</code>       <code class="k">return</code> <code class="nx">response</code><code class="p">;</code>
<code class="lineno">19</code>     <code class="p">},</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">response</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">20</code>       <code class="nx">$</code><code class="p">(</code><code class="s2">"#spinner"</code><code class="p">).</code><code class="nx">hide</code><code class="p">();</code>
<code class="lineno">21</code>       <code class="k">return</code> <code class="nx">$q</code><code class="p">.</code><code class="nx">reject</code><code class="p">(</code><code class="nx">response</code><code class="p">);</code>
<code class="lineno">22</code>     <code class="p">});</code>
<code class="lineno">23</code>   <code class="p">};</code>
<code class="lineno">24</code> <code class="p">});</code>
</pre></div>

</div>

<p>Note that we use jQuery to show the spinner in the configuration step and hide the spinner in the interceptor.</p>

<p>Additionally we use a controller to handle the button click and execute the search request.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">controller</code><code class="p">(</code><code class="s2">"MyCtrl"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$scope</code><code class="p">,</code> <code class="nx">$resource</code><code class="p">,</code> <code class="nx">$rootScope</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">resultsPerPage</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code>
<code class="lineno"> 4</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">page</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
<code class="lineno"> 5</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">searchTerm</code> <code class="o">=</code> <code class="s2">"angularjs"</code><code class="p">;</code>
<code class="lineno"> 6</code> 
<code class="lineno"> 7</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">twitter</code> <code class="o">=</code> <code class="nx">$resource</code><code class="p">(</code><code class="s1">'http://search.twitter.com/search.json'</code><code class="p">,</code>
<code class="lineno"> 8</code>     <code class="p">{</code> <code class="nx">callback</code><code class="o">:</code><code class="s1">'JSON_CALLBACK'</code><code class="p">,</code>
<code class="lineno"> 9</code>       <code class="nx">page</code><code class="o">:</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">page</code><code class="p">,</code>
<code class="lineno">10</code>       <code class="nx">rpp</code><code class="o">:</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">resultsPerPage</code><code class="p">,</code>
<code class="lineno">11</code>       <code class="nx">q</code><code class="o">:</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">searchTerm</code> <code class="p">},</code>
<code class="lineno">12</code>     <code class="p">{</code> <code class="nx">get</code><code class="o">:</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code><code class="s1">'JSONP'</code> <code class="p">}</code> <code class="p">});</code>
<code class="lineno">13</code> 
<code class="lineno">14</code>   <code class="nx">$scope</code><code class="p">.</code><code class="nx">load</code> <code class="o">=</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
<code class="lineno">15</code>     <code class="nx">$scope</code><code class="p">.</code><code class="nx">twitter</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">16</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">tweets</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">results</code><code class="p">;</code>
<code class="lineno">17</code>     <code class="p">});</code>
<code class="lineno">18</code>   <code class="p">};</code>
<code class="lineno">19</code> <code class="p">});</code>
</pre></div>

</div>

<p>Don&rsquo;t forget to add <code>ngResource</code> to the module and load it via script tag.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter8/recipe8">github</a>.</p>

<h4 id="discussion-48">Discussion</h4>
<p>The template is the easy part of this recipe since it renders a list of tweets using the <code>ng-repeat</code> directive. Let us jump straight to the interceptor code.</p>

<p>The interceptor is implemented using the factory method and attaches itself to the promise function of the AJAX response to hide the spinner on success or failure. Note that on failure we use the <code>reject</code> function of the <a href="http://docs.angularjs.org/api/ng.%24q">$q</a> service, Angular&rsquo;s promise/deferred implementation.</p>

<p>Now, in the <code>config</code> method we add our inceptor to the list of responseInterceptors of <code>$httpProvider</code> to register it properly. In a similar manner we add the <code>spinnerFunction</code> to the default <code>transformRequest</code> list in order to call it before each AJAX request.</p>

<p>The controller is responsible for using a <code>$resource</code> object and handling the button click with the <code>load</code> function. We are using JSONP here to allow this code to be executed locally even though it is served by a different domain.</p>

<h2 id="backend-integration-with-ruby-on-rails">Backend Integration with Ruby on Rails</h2>
<p>In this chapter we will have a look into solving common problems when combining Angular.js with the <a href="http://rubyonrails.org/">Ruby on Rails</a> frameworks. The examples used in this chapter are based on an example application to manage a list of contacts.</p>

<h3 id="consuming-rest-apis">Consuming REST APIs</h3>

<h4 id="problem-48">Problem</h4>
<p>You wish to consume a JSON REST API implemented in your Rails application.</p>

<h4 id="solution-49">Solution</h4>
<p>Using the <code>$resource</code> service is a great start and can be tweaked to feel more natural to a Rails developer by configuring the methods in accordance with the Rails actions.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s2">"Contact"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$resource</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">return</code> <code class="nx">$resource</code><code class="p">(</code><code class="s2">"/api/contacts/:id"</code><code class="p">,</code> <code class="p">{</code> <code class="nx">id</code><code class="o">:</code> <code class="s2">"@id"</code> <code class="p">},</code>
<code class="lineno"> 3</code>     <code class="p">{</code>
<code class="lineno"> 4</code>       <code class="s1">'create'</code><code class="o">:</code>  <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code> <code class="p">},</code>
<code class="lineno"> 5</code>       <code class="s1">'index'</code><code class="o">:</code>   <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'GET'</code><code class="p">,</code> <code class="nx">isArray</code><code class="o">:</code> <code class="kc">true</code> <code class="p">},</code>
<code class="lineno"> 6</code>       <code class="s1">'show'</code><code class="o">:</code>    <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'GET'</code><code class="p">,</code> <code class="nx">isArray</code><code class="o">:</code> <code class="kc">false</code> <code class="p">},</code>
<code class="lineno"> 7</code>       <code class="s1">'update'</code><code class="o">:</code>  <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'PUT'</code> <code class="p">},</code>
<code class="lineno"> 8</code>       <code class="s1">'destroy'</code><code class="o">:</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'DELETE'</code> <code class="p">}</code>
<code class="lineno"> 9</code>     <code class="p">}</code>
<code class="lineno">10</code>   <code class="p">);</code>
<code class="lineno">11</code> <code class="p">});</code>
</pre></div>

</div>

<p>We can now fetch a list of contacts using <code>Contact.index()</code> and a single contact with <code>Contact.show(id)</code>. These actions can be directly mapped to the <code>ContactsController</code> actions in your Rails backend.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="n">class</code> <code class="n">ContactsController</code> <code class="o">&lt;</code> <code class="n">ApplicationController</code>
<code class="lineno"> 2</code>   <code class="n">respond_to</code> <code class="o">:</code><code class="n">json</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>   <code class="n">def</code> <code class="n">index</code>
<code class="lineno"> 5</code>     <code class="err">@</code><code class="n">contacts</code> <code class="o">=</code> <code class="n">Contact</code><code class="p">.</code><code class="n">all</code>
<code class="lineno"> 6</code>     <code class="n">respond_with</code> <code class="err">@</code><code class="n">contacts</code>
<code class="lineno"> 7</code>   <code class="n">end</code>
<code class="lineno"> 8</code> 
<code class="lineno"> 9</code>   <code class="n">def</code> <code class="n">show</code>
<code class="lineno">10</code>     <code class="err">@</code><code class="n">contact</code> <code class="o">=</code> <code class="n">Contact</code><code class="p">.</code><code class="n">find</code><code class="p">(</code><code class="n">params</code><code class="p">[</code><code class="o">:</code><code class="n">id</code><code class="p">])</code>
<code class="lineno">11</code>     <code class="n">respond_with</code> <code class="err">@</code><code class="n">contact</code>
<code class="lineno">12</code>   <code class="n">end</code>
<code class="lineno">13</code> 
<code class="lineno">14</code>   <code class="p">...</code>
<code class="lineno">15</code> <code class="n">end</code>
</pre></div>

</div>

<p>The Rails action controller uses a <code>Contact</code> ActiveRecord model with the usual contact attributes like firstname, lastname, age, etc. By specifying <code>respond_to :json</code> the controller only responds to the JSON resource format and we can use <code>respond_with</code> to automatically transform the <code>Contact</code> model to a JSON response.</p>

<p>The route definition uses the Rails default resource routing and an <code>api</code> scope to separate the API requests from other requests.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">Contacts</code><code class="o">::</code><code class="n">Application</code><code class="p">.</code><code class="n">routes</code><code class="p">.</code><code class="n">draw</code> <code class="k">do</code>
<code class="lineno">2</code>   <code class="n">scope</code> <code class="s">"api"</code> <code class="k">do</code>
<code class="lineno">3</code>     <code class="n">resources</code> <code class="o">:</code><code class="n">contacts</code>
<code class="lineno">4</code>   <code class="n">end</code>
<code class="lineno">5</code> <code class="n">end</code>
</pre></div>

</div>

<p>This will generate paths like for example <code>api/contacts</code> and <code>api/contacts/:id</code> for the HTTP GET method.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter9/recipe1">github</a>.</p>

<h4 id="discussion-49">Discussion</h4>
<p>If you want to get up to speed with Ruby on Rails, I suggest that you look into the <a href="http://guides.rubyonrails.org/index.html">Rails Guides</a> which will help you understand how all the pieces fit together.</p>

<h5 id="rails-security-using-authenticity-token">Rails Security using Authenticity Token</h5>
<p>The example code above works nicely until we use the HTTP methods <code>POST</code>, <code>PUT</code> and <code>DELETE</code> with the resource. As a security mechanism, Rails expects an authenticity token to prevent a CSRF (<a href="http://guides.rubyonrails.org/security.html#cross-site-request-forgery-csrf">Cross Site Request Forgery</a>) attack. We need  to submit an additional HTTP header <code>X-CSRF-Token</code> with the token. It is conveniently rendered in the HTML <code>meta</code> tag <code>csrf-token</code> by Rails. Using jQuery we can fetch that meta tag definition and configure the <code>$httpProvider</code> appropriately.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s2">"Contacts"</code><code class="p">,</code> <code class="cp">[</code><code class="s2">"ngResource"</code><code class="cp">]</code><code class="p">);</code>
<code class="lineno">2</code> <code class="nx">app</code><code class="p">.</code><code class="nx">config</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">$httpProvider</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">3</code>   <code class="nx">$httpProvider</code><code class="p">.</code><code class="nx">defaults</code><code class="p">.</code><code class="nx">headers</code><code class="p">.</code><code class="nx">common</code><code class="cp">[</code><code class="s1">'X-CSRF-Token'</code><code class="cp">]</code> <code class="o">=</code>
<code class="lineno">4</code>     <code class="nx">$</code><code class="p">(</code><code class="s1">'meta</code><code class="cp">[</code><code class="n">name</code><code class="o">=</code><code class="nx">csrf</code><code class="na">-token</code><code class="cp">]</code><code class="s1">'</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'content'</code><code class="p">);</code>
<code class="lineno">5</code> <code class="p">});</code>
</pre></div>

</div>

<h5 id="rails-json-response-format">Rails JSON response format</h5>
<p>If you are using a Rails version prior 3.1, you&rsquo;ll notice that the JSON response will use a <code>contact</code> namespace for the model attributes which breaks your Angular.js code. To disable this behavior you can configure your Rails app accordingly.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">ActiveRecord</code><code class="o">::</code><code class="n">Base</code><code class="p">.</code><code class="n">include_root_in_json</code> <code class="o">=</code> <code class="nb">false</code>
</pre></div>

</div>

<p>There are still inconsistencies between the Ruby and Javascript world. For example, in Ruby we use underscored attribute names (display_name) whereas in Javascript we use camelCase (displayName).</p>

<p>There is a custom <code>$resource</code> implementation <a href="https://github.com/tpodom/angularjs-rails-resource">angularjs-rails-resource</a> available to streamline consuming Rails resources. It uses transformers and inceptors to rename the attribute fields and handles the root wrapping behavior for you.</p>

<h3 id="implementing-client-side-routing">Implementing Client-Side Routing</h3>

<h4 id="problem-49">Problem</h4>
<p>You wish to use client-side routing in conjunction with a Ruby on Rails backend.</p>

<h4 id="solution-50">Solution</h4>
<p>Every request to the backend should initially render the complete page in order to load our Angular app. Only then will the client-side rendering take over. Let us first have a look at the route definition for this &ldquo;catch all&rdquo; route.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">Contacts</code><code class="o">::</code><code class="n">Application</code><code class="p">.</code><code class="n">routes</code><code class="p">.</code><code class="n">draw</code> <code class="k">do</code>
<code class="lineno">2</code>   <code class="n">root</code> <code class="o">:</code><code class="n">to</code> <code class="o">=&gt;</code> <code class="s">"layouts#index"</code>
<code class="lineno">3</code>   <code class="n">match</code> <code class="s">"*path"</code> <code class="o">=&gt;</code> <code class="s">"layouts#index"</code>
<code class="lineno">4</code> <code class="n">end</code>
</pre></div>

</div>

<p>It uses <a href="http://guides.rubyonrails.org/routing.html#route-globbing">Route Globbing</a> to match all URLs and defines a root URL. Both will be handled by a layout controller with the sole purpose of rendering the initial layout.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">class</code> <code class="n">LayoutsController</code> <code class="o">&lt;</code> <code class="n">ApplicationController</code>
<code class="lineno">2</code>   <code class="n">def</code> <code class="n">index</code>
<code class="lineno">3</code>     <code class="n">render</code> <code class="s">"layouts/application"</code>
<code class="lineno">4</code>   <code class="n">end</code>
<code class="lineno">5</code> <code class="n">end</code>
</pre></div>

</div>

<p>The actual layout template defines our <code>ng-view</code> directive and resides in <code>app/views/layouts/application.html</code> - nothing new here. So let&rsquo;s skip ahead to the Angular route definition in <code>app.js.erb</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="x">var app = angular.module("Contacts", ["ngResource"]);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="x">app.config(function($routeProvider, $locationProvider) {</code>
<code class="lineno"> 4</code> <code class="x">  $locationProvider.html5Mode(true);</code>
<code class="lineno"> 5</code> <code class="x">  $routeProvider</code>
<code class="lineno"> 6</code> <code class="x">    .when("/contacts",</code>
<code class="lineno"> 7</code> <code class="x">      { templateUrl: "</code><code class="cp">&lt;%=</code> <code class="n">asset_path</code><code class="p">(</code><code class="s1">'contacts/index.html'</code><code class="p">)</code> <code class="cp">%&gt;</code><code class="x"> ",</code>
<code class="lineno"> 8</code> <code class="x">        controller: "ContactsIndexCtrl" })</code>
<code class="lineno"> 9</code> <code class="x">    .when("/contacts/new",</code>
<code class="lineno">10</code> <code class="x">      { templateUrl: "</code><code class="cp">&lt;%=</code> <code class="n">asset_path</code><code class="p">(</code><code class="s1">'contacts/edit.html'</code><code class="p">)</code> <code class="cp">%&gt;</code><code class="x"> ",</code>
<code class="lineno">11</code> <code class="x">        controller: "ContactsEditCtrl" })</code>
<code class="lineno">12</code> <code class="x">    .when("/contacts/:id",</code>
<code class="lineno">13</code> <code class="x">      { templateUrl: "</code><code class="cp">&lt;%=</code> <code class="n">asset_path</code><code class="p">(</code><code class="s1">'contacts/show.html'</code><code class="p">)</code> <code class="cp">%&gt;</code><code class="x"> ",</code>
<code class="lineno">14</code> <code class="x">        controller: "ContactsShowCtrl" })</code>
<code class="lineno">15</code> <code class="x">    .when("/contacts/:id/edit",</code>
<code class="lineno">16</code> <code class="x">      { templateUrl: "</code><code class="cp">&lt;%=</code> <code class="n">asset_path</code><code class="p">(</code><code class="s1">'contacts/edit.html'</code><code class="p">)</code> <code class="cp">%&gt;</code><code class="x"> ",</code>
<code class="lineno">17</code> <code class="x">        controller: "ContactsEditCtrl" })</code>
<code class="lineno">18</code> <code class="x">    .otherwise({ redirectTo: "/contacts" });</code>
<code class="lineno">19</code> <code class="x">});</code>
</pre></div>

</div>

<p>We set the <code>$locationProvider</code> to use the HTML5 mode and define our client-side routes for listing, showing, editing and creating new contacts.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter9/recipe1">github</a>.</p>

<h4 id="discussion-50">Discussion</h4>
<p>Let us have a look into the route definition again. First of all the filename ends with <code>erb</code>, since it uses ERB tags in the javascript file, courtesy of the <a href="http://guides.rubyonrails.org/asset_pipeline.html">Rails Asset Pipeline</a>. The  <code>asset_path</code> method is used to retrieve the URL to the HTML partials since it will change depending on the environment. On production the filename contains an MD5 checksum and the actual ERB output will change from <code>/assets/contacts/index.html</code> to <code>/assets/contacts/index-7ce113b9081a20d93a4a86e1aacce05f.html</code>. If your Rails app is configured to use an asset host, the path will in fact be absolute.</p>

<h3 id="validating-forms-server-side">Validating Forms Server-Side</h3>

<h4 id="problem-50">Problem</h4>
<p>You wish to validate forms using a server-side REST API provided by Rails.</p>

<h4 id="solution-51">Solution</h4>
<p>Rails already provides model validation support out of the box for us. Let us start with the Contact <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html">ActiveRecord model</a>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">class</code> <code class="n">Contact</code> <code class="o">&lt;</code> <code class="n">ActiveRecord</code><code class="o">::</code><code class="n">Base</code>
<code class="lineno">2</code>   <code class="n">attr_accessible</code> <code class="o">:</code><code class="n">age</code><code class="p">,</code> <code class="o">:</code><code class="n">firstname</code><code class="p">,</code> <code class="o">:</code><code class="n">lastname</code>
<code class="lineno">3</code> 
<code class="lineno">4</code>   <code class="n">validates</code> <code class="o">:</code><code class="n">age</code><code class="p">,</code> <code class="o">:</code><code class="n">numericality</code> <code class="o">=&gt;</code> <code class="p">{</code>
<code class="lineno">5</code>     <code class="o">:</code><code class="n">only_integer</code> <code class="o">=&gt;</code> <code class="nb">true</code><code class="p">,</code> <code class="o">:</code><code class="n">less_than_or_equal_to</code> <code class="o">=&gt;</code> <code class="mi">50</code> <code class="p">}</code>
<code class="lineno">6</code> <code class="n">end</code>
</pre></div>

</div>

<p>It defines a validation on the <code>age</code> attribute. It must be an integer and less or equal to 50 years.</p>

<p>In the <code>ContactsController</code> we can use that to make sure the REST API returns proper error messages. As an example let us look into the <code>create</code> action.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="n">class</code> <code class="n">ContactsController</code> <code class="o">&lt;</code> <code class="n">ApplicationController</code>
<code class="lineno"> 2</code>   <code class="n">respond_to</code> <code class="o">:</code><code class="n">json</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code>   <code class="n">def</code> <code class="n">create</code>
<code class="lineno"> 5</code>     <code class="err">@</code><code class="n">contact</code> <code class="o">=</code> <code class="n">Contact</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">[</code><code class="o">:</code><code class="n">contact</code><code class="p">])</code>
<code class="lineno"> 6</code>     <code class="k">if</code> <code class="err">@</code><code class="n">contact</code><code class="p">.</code><code class="n">save</code>
<code class="lineno"> 7</code>       <code class="n">render</code> <code class="n">json</code><code class="o">:</code> <code class="err">@</code><code class="n">contact</code><code class="p">,</code> <code class="n">status</code><code class="o">:</code> <code class="o">:</code><code class="n">created</code><code class="p">,</code> <code class="n">location</code><code class="o">:</code> <code class="err">@</code><code class="n">contact</code>
<code class="lineno"> 8</code>     <code class="k">else</code>
<code class="lineno"> 9</code>       <code class="n">render</code> <code class="n">json</code><code class="o">:</code> <code class="err">@</code><code class="n">contact</code><code class="p">.</code><code class="n">errors</code><code class="p">,</code> <code class="n">status</code><code class="o">:</code> <code class="o">:</code><code class="n">unprocessable_entity</code>
<code class="lineno">10</code>     <code class="n">end</code>
<code class="lineno">11</code>   <code class="n">end</code>
<code class="lineno">12</code> 
<code class="lineno">13</code> <code class="n">end</code>
</pre></div>

</div>

<p>On success it will render the contact model using a JSON presentation and on failure it will return all validation errors transformed to JSON. Let us have a look at an example JSON response:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="p">{</code> <code class="s">"age"</code><code class="o">:</code> <code class="p">[</code><code class="s">"must be less than or equal to 50"</code><code class="p">]</code> <code class="p">}</code>
</pre></div>

</div>

<p>It is a hash with an entry for each attribute with validation errors. The value is an array of Strings since there might be multiple errors at the same time.</p>

<p>Let us move on to the client-side of our application. The Angular.js contact <code>$resource</code> calls the create function and passes the failure callback function.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">Contact</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">contact</code><code class="p">,</code> <code class="nx">success</code><code class="p">,</code> <code class="nx">failure</code><code class="p">);</code>
<code class="lineno"> 2</code> 
<code class="lineno"> 3</code> <code class="kd">function</code> <code class="nx">failure</code><code class="p">(</code><code class="nx">response</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>   <code class="nx">_</code><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="nx">response</code><code class="p">.</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">errors</code><code class="p">,</code> <code class="nx">key</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 5</code>     <code class="nx">_</code><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="nx">errors</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 6</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">form</code><code class="cp">[</code><code class="nb">key</code><code class="cp">]</code><code class="p">.</code><code class="nx">$dirty</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
<code class="lineno"> 7</code>       <code class="nx">$scope</code><code class="p">.</code><code class="nx">form</code><code class="cp">[</code><code class="nb">key</code><code class="cp">]</code><code class="p">.</code><code class="nx">$setValidity</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="kc">false</code><code class="p">);</code>
<code class="lineno"> 8</code>     <code class="p">});</code>
<code class="lineno"> 9</code>   <code class="p">});</code>
<code class="lineno">10</code> <code class="p">}</code>
</pre></div>

</div>

<p>Note that ActiveRecord attributes can have multiple validations defined. That is why the <code>failure</code> function iterates through each validation entry and each error and uses <code>$setValidity</code> and <code>$dirty</code> to mark the form fields as invalid.</p>

<p>Now we are ready to show some feedback to our users using the same approach discussed already in the forms chapter.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"control-group"</code> <code class="na">ng-class=</code><code class="s">"errorClass('age')"</code><code class="nt">&gt;</code>
<code class="lineno"> 2</code>   <code class="nt">&lt;label</code> <code class="na">class=</code><code class="s">"control-label"</code> <code class="na">for=</code><code class="s">"age"</code><code class="nt">&gt;</code>Age<code class="nt">&lt;/label&gt;</code>
<code class="lineno"> 3</code>   <code class="nt">&lt;div</code> <code class="na">class=</code><code class="s">"controls"</code><code class="nt">&gt;</code>
<code class="lineno"> 4</code>     <code class="nt">&lt;input</code> <code class="na">ng-model=</code><code class="s">"contact.age"</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">name=</code><code class="s">"age"</code>
<code class="lineno"> 5</code>       <code class="na">placeholder=</code><code class="s">"Age"</code> <code class="err">required</code><code class="nt">&gt;</code>
<code class="lineno"> 6</code>     <code class="nt">&lt;span</code> <code class="na">class=</code><code class="s">"help-block"</code>
<code class="lineno"> 7</code>       <code class="na">ng-show=</code><code class="s">"form.age.$invalid &amp;&amp; form.age.$dirty"</code><code class="nt">&gt;</code>
<code class="lineno"> 8</code>       {{errorMessage('age')}}
<code class="lineno"> 9</code>     <code class="nt">&lt;/span&gt;</code>
<code class="lineno">10</code>   <code class="nt">&lt;/div&gt;</code>
<code class="lineno">11</code> <code class="nt">&lt;/div&gt;</code>
</pre></div>

</div>

<p>The <code>errorClass</code> function adds the <code>error</code> CSS class if the form field is invalid and dirty. This will render the label, input field and the help block with a red color.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">errorClass</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">name</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="kd">var</code> <code class="nx">s</code> <code class="o">=</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">form</code><code class="cp">[</code><code class="nb">name</code><code class="cp">]</code><code class="p">;</code>
<code class="lineno">3</code>   <code class="k">return</code> <code class="nx">s</code><code class="p">.</code><code class="nx">$invalid</code> <code class="o">&amp;&amp;</code> <code class="nx">s</code><code class="p">.</code><code class="nx">$dirty</code> <code class="o">?</code> <code class="s2">"error"</code> <code class="o">:</code> <code class="s2">""</code><code class="p">;</code>
<code class="lineno">4</code> <code class="p">};</code>
</pre></div>

</div>

<p>The <code>errorMessage</code> will print a more detailed error message and is defined in the same controller.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">$scope</code><code class="p">.</code><code class="nx">errorMessage</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">name</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">result</code> <code class="o">=</code> <code class="cp">[]</code><code class="p">;</code>
<code class="lineno">3</code>   <code class="nx">_</code><code class="p">.</code><code class="nx">each</code><code class="p">(</code><code class="nx">$scope</code><code class="p">.</code><code class="nx">form</code><code class="cp">[</code><code class="nb">name</code><code class="cp">]</code><code class="p">.</code><code class="nx">$error</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">key</code><code class="p">,</code> <code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">4</code>     <code class="nx">result</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">value</code><code class="p">);</code>
<code class="lineno">5</code>   <code class="p">});</code>
<code class="lineno">6</code>   <code class="k">return</code> <code class="nx">result</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s2">", "</code><code class="p">);</code>
<code class="lineno">7</code> <code class="p">};</code>
</pre></div>

</div>

<p>It iterates over each error message and creates a comma separated String out of it.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter9/recipe1">github</a>.</p>

<h4 id="discussion-51">Discussion</h4>
<p>Finally, the <code>errorMessage</code> handling is of course pretty primitive. A user would expect a localized failure message instead of this technical presentation. The Rails <a href="http://guides.rubyonrails.org/i18n.html#translations-for-active-record-models">Internationalization Guide</a> describes how to translate validation error messages in Rails and might prove helpful to further use that in your client-side code.</p>

<h2 id="backend-integration-with-node-express">Backend Integration with Node Express</h2>
<p>In this chapter we will have a look into solving common problems when combining Angular.js with the Node.js <a href="http://expressjs.com/">Express</a> framework. The examples used in this chapter are based on a Contacts app to manage a list of contacts. As an extra we use MongoDB as a backend for our contacts since it requires further customization to make it work in conjunction with Angular&rsquo;s <code>$resource</code> service.</p>

<h3 id="consuming-rest-apis-1">Consuming REST APIs</h3>

<h4 id="problem-51">Problem</h4>
<p>You wish to consume a JSON REST API implemented in your Express application.</p>

<h4 id="solution-52">Solution</h4>
<p>Using the <code>$resource</code> service we will begin by defining our Contact model and all RESTful actions.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">factory</code><code class="p">(</code><code class="s2">"Contact"</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">$resource</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 2</code>   <code class="k">return</code> <code class="nx">$resource</code><code class="p">(</code><code class="s2">"/api/contacts/:id"</code><code class="p">,</code> <code class="p">{</code> <code class="nx">id</code><code class="o">:</code> <code class="s2">"@_id"</code> <code class="p">},</code>
<code class="lineno"> 3</code>     <code class="p">{</code>
<code class="lineno"> 4</code>       <code class="s1">'create'</code><code class="o">:</code>  <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'POST'</code> <code class="p">},</code>
<code class="lineno"> 5</code>       <code class="s1">'index'</code><code class="o">:</code>   <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'GET'</code><code class="p">,</code> <code class="nx">isArray</code><code class="o">:</code> <code class="kc">true</code> <code class="p">},</code>
<code class="lineno"> 6</code>       <code class="s1">'show'</code><code class="o">:</code>    <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'GET'</code><code class="p">,</code> <code class="nx">isArray</code><code class="o">:</code> <code class="kc">false</code> <code class="p">},</code>
<code class="lineno"> 7</code>       <code class="s1">'update'</code><code class="o">:</code>  <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'PUT'</code> <code class="p">},</code>
<code class="lineno"> 8</code>       <code class="s1">'destroy'</code><code class="o">:</code> <code class="p">{</code> <code class="nx">method</code><code class="o">:</code> <code class="s1">'DELETE'</code> <code class="p">}</code>
<code class="lineno"> 9</code>     <code class="p">}</code>
<code class="lineno">10</code>   <code class="p">);</code>
<code class="lineno">11</code> <code class="p">});</code>
</pre></div>

</div>

<p>We can now fetch a list of contacts using <code>Contact.index()</code> and a single contact with <code>Contact.show(id)</code>. These actions can be directly mapped to the API routes defined in <code>app.js</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="n">var</code> <code class="n">express</code> <code class="o">=</code> <code class="n">require</code><code class="p">(</code><code class="err">'</code><code class="n">express</code><code class="err">'</code><code class="p">),</code>
<code class="lineno"> 2</code>         <code class="n">api</code> <code class="o">=</code> <code class="n">require</code><code class="p">(</code><code class="err">'</code><code class="p">.</code><code class="o">/</code><code class="n">routes</code><code class="o">/</code><code class="n">api</code><code class="err">'</code><code class="p">);</code>
<code class="lineno"> 3</code> 
<code class="lineno"> 4</code> <code class="n">var</code> <code class="n">app</code> <code class="o">=</code> <code class="n">module</code><code class="p">.</code><code class="n">exports</code> <code class="o">=</code> <code class="n">express</code><code class="p">();</code>
<code class="lineno"> 5</code> 
<code class="lineno"> 6</code> <code class="n">app</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="err">'</code><code class="o">/</code><code class="n">api</code><code class="o">/</code><code class="n">contacts</code><code class="err">'</code><code class="p">,</code> <code class="n">api</code><code class="p">.</code><code class="n">contacts</code><code class="p">);</code>
<code class="lineno"> 7</code> <code class="n">app</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="err">'</code><code class="o">/</code><code class="n">api</code><code class="o">/</code><code class="n">contacts</code><code class="o">/:</code><code class="n">id</code><code class="err">'</code><code class="p">,</code> <code class="n">api</code><code class="p">.</code><code class="n">contact</code><code class="p">);</code>
<code class="lineno"> 8</code> <code class="n">app</code><code class="p">.</code><code class="n">post</code><code class="p">(</code><code class="err">'</code><code class="o">/</code><code class="n">api</code><code class="o">/</code><code class="n">contacts</code><code class="err">'</code><code class="p">,</code> <code class="n">api</code><code class="p">.</code><code class="n">createContact</code><code class="p">);</code>
<code class="lineno"> 9</code> <code class="n">app</code><code class="p">.</code><code class="n">put</code><code class="p">(</code><code class="err">'</code><code class="o">/</code><code class="n">api</code><code class="o">/</code><code class="n">contacts</code><code class="o">/:</code><code class="n">id</code><code class="err">'</code><code class="p">,</code> <code class="n">api</code><code class="p">.</code><code class="n">updateContact</code><code class="p">);</code>
<code class="lineno">10</code> <code class="n">app</code><code class="p">.</code><code class="n">delete</code><code class="p">(</code><code class="err">'</code><code class="o">/</code><code class="n">api</code><code class="o">/</code><code class="n">contacts</code><code class="o">/:</code><code class="n">id</code><code class="err">'</code><code class="p">,</code> <code class="n">api</code><code class="p">.</code><code class="n">destroyContact</code><code class="p">);</code>
</pre></div>

</div>

<p>I like to keep routes in a separate file <code>routes/api.js</code> and just reference them in <code>app.js</code> in order to keep it small. The API implementation first initializes the <a href="http://mongoosejs.com/">Mongoose</a> library and defines a schema for our Contact model.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">var</code> <code class="n">mongoose</code> <code class="o">=</code> <code class="n">require</code><code class="p">(</code><code class="err">'</code><code class="n">mongoose</code><code class="err">'</code><code class="p">);</code>
<code class="lineno">2</code> <code class="n">mongoose</code><code class="p">.</code><code class="n">connect</code><code class="p">(</code><code class="err">'</code><code class="n">mongodb</code><code class="o">:</code><code class="c1">//localhost/contacts_database');</code>
<code class="lineno">3</code> 
<code class="lineno">4</code> <code class="n">var</code> <code class="n">contactSchema</code> <code class="o">=</code> <code class="n">mongoose</code><code class="p">.</code><code class="n">Schema</code><code class="p">({</code>
<code class="lineno">5</code>   <code class="nl">firstname:</code> <code class="err">'</code><code class="n">string</code><code class="err">'</code><code class="p">,</code> <code class="n">lastname</code><code class="o">:</code> <code class="err">'</code><code class="n">string</code><code class="err">'</code><code class="p">,</code> <code class="n">age</code><code class="o">:</code> <code class="err">'</code><code class="n">number</code><code class="err">'</code>
<code class="lineno">6</code> <code class="p">});</code>
<code class="lineno">7</code> <code class="n">var</code> <code class="n">Contact</code> <code class="o">=</code> <code class="n">mongoose</code><code class="p">.</code><code class="n">model</code><code class="p">(</code><code class="err">'</code><code class="n">Contact</code><code class="err">'</code><code class="p">,</code> <code class="n">contactSchema</code><code class="p">);</code>
</pre></div>

</div>

<p>We can now use the <code>Contact</code> model to implement the API. Lets start with the index action:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">contacts</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">Contact</code><code class="p">.</code><code class="nx">find</code><code class="p">({},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code>
<code class="lineno">4</code>   <code class="p">});</code>
<code class="lineno">5</code> <code class="p">};</code>
</pre></div>

</div>

<p>Skipping the error handling we retrieve all contacts with the <code>find</code> function provided by Mongoose and render the result in the JSON format. The show action is pretty similar except it uses <code>findOne</code> and the id from the URL parameter to retrieve a single contact.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">contact</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="nx">Contact</code><code class="p">.</code><code class="nx">findOne</code><code class="p">({</code> <code class="nx">_id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">id</code> <code class="p">},</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">3</code>     <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="nx">obj</code><code class="p">);</code>
<code class="lineno">4</code>   <code class="p">});</code>
<code class="lineno">5</code> <code class="p">};</code>
</pre></div>

</div>

<p>As a final example we will create a new Contact instance passing in the request body and call the <code>save</code> method to persist it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">createContact</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="kd">var</code> <code class="nx">contact</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Contact</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">);</code>
<code class="lineno">3</code>   <code class="nx">contact</code><code class="p">.</code><code class="nx">save</code><code class="p">();</code>
<code class="lineno">4</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">);</code>
<code class="lineno">5</code> <code class="p">};</code>
</pre></div>

</div>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter10/recipe1">github</a>.</p>

<h4 id="discussion-52">Discussion</h4>
<p>Let have a look again at the example for the contact function, which retrieves a single Contact. It uses <code>_id</code> instead of <code>id</code> as the parameter for the <code>findOne</code> function. This underscore is intentional and used by MongoDB for its auto-generated IDs. In order to automatically map from <code>id</code> to the <code>_id</code> parameter we used a nice trick of the <code>$resource</code> service. Take a look at the second parameter of the Contact <code>$resource</code> definition: <code>{ id: "@_id" }</code>. Using this parameter Angular will automatically set the URL parameter <code>id</code> based on the value of the model attribute <code>_id</code>.</p>

<h3 id="implementing-client-side-routing-1">Implementing Client-Side Routing</h3>

<h4 id="problem-52">Problem</h4>
<p>You wish to use client-side routing in conjunction with an Express backend.</p>

<h4 id="solution-53">Solution</h4>
<p>Every request to the backend should initially render the complete layout in order to load our Angular app. Only then will the client-side rendering take over. Let us first have a look at the route definition for this &ldquo;catch all&rdquo; route in our <code>app.js</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="n">var</code> <code class="n">express</code> <code class="o">=</code> <code class="n">require</code><code class="p">(</code><code class="err">'</code><code class="n">express</code><code class="err">'</code><code class="p">),</code>
<code class="lineno">2</code>      <code class="n">routes</code> <code class="o">=</code> <code class="n">require</code><code class="p">(</code><code class="err">'</code><code class="p">.</code><code class="o">/</code><code class="n">routes</code><code class="err">'</code><code class="p">);</code>
<code class="lineno">3</code> 
<code class="lineno">4</code> <code class="n">app</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="sc">'/'</code><code class="p">,</code> <code class="n">routes</code><code class="p">.</code><code class="n">index</code><code class="p">);</code>
<code class="lineno">5</code> <code class="n">app</code><code class="p">.</code><code class="n">get</code><code class="p">(</code><code class="sc">'*'</code><code class="p">,</code> <code class="n">routes</code><code class="p">.</code><code class="n">index</code><code class="p">);</code>
</pre></div>

</div>

<p>It uses the wildcard character to catch all requests in order to get processed with the <code>routes.index</code> module. Additionally, it defines the route to use the same module. The module again resides in <code>routes/index.js</code>.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">exports</code><code class="p">.</code><code class="nx">index</code> <code class="o">=</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
<code class="lineno">2</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'layout'</code><code class="p">);</code>
<code class="lineno">3</code> <code class="p">};</code>
</pre></div>

</div>

<p>The implementation only renders the layout template. It uses the <a href="http://jade-lang.com/">Jade</a> template engine.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="o">!!!</code>
<code class="lineno"> 2</code> <code class="n">html</code><code class="p">(</code><code class="n">ng</code><code class="o">-</code><code class="n">app</code><code class="o">=</code><code class="s">"myApp"</code><code class="p">)</code>
<code class="lineno"> 3</code>   <code class="n">head</code>
<code class="lineno"> 4</code>     <code class="n">meta</code><code class="p">(</code><code class="n">charset</code><code class="o">=</code><code class="err">'</code><code class="n">utf8</code><code class="err">'</code><code class="p">)</code>
<code class="lineno"> 5</code>     <code class="n">title</code> <code class="n">Angular</code> <code class="n">Express</code> <code class="n">Seed</code> <code class="n">App</code>
<code class="lineno"> 6</code>     <code class="n">link</code><code class="p">(</code><code class="n">rel</code><code class="o">=</code><code class="err">'</code><code class="n">stylesheet</code><code class="err">'</code><code class="p">,</code> <code class="n">href</code><code class="o">=</code><code class="err">'</code><code class="o">/</code><code class="n">css</code><code class="o">/</code><code class="n">bootstrap</code><code class="p">.</code><code class="n">css</code><code class="err">'</code><code class="p">)</code>
<code class="lineno"> 7</code>   <code class="n">body</code>
<code class="lineno"> 8</code>     <code class="n">div</code>
<code class="lineno"> 9</code>       <code class="n">ng</code><code class="o">-</code><code class="n">view</code>
<code class="lineno">10</code> 
<code class="lineno">11</code>     <code class="n">script</code><code class="p">(</code><code class="n">src</code><code class="o">=</code><code class="err">'</code><code class="n">js</code><code class="o">/</code><code class="n">lib</code><code class="o">/</code><code class="n">angular</code><code class="o">/</code><code class="n">angular</code><code class="p">.</code><code class="n">js</code><code class="err">'</code><code class="p">)</code>
<code class="lineno">12</code>     <code class="n">script</code><code class="p">(</code><code class="n">src</code><code class="o">=</code><code class="err">'</code><code class="n">js</code><code class="o">/</code><code class="n">lib</code><code class="o">/</code><code class="n">angular</code><code class="o">/</code><code class="n">angular</code><code class="o">-</code><code class="n">resource</code><code class="p">.</code><code class="n">js</code><code class="err">'</code><code class="p">)</code>
<code class="lineno">13</code>     <code class="n">script</code><code class="p">(</code><code class="n">src</code><code class="o">=</code><code class="err">'</code><code class="n">js</code><code class="o">/</code><code class="n">app</code><code class="p">.</code><code class="n">js</code><code class="err">'</code><code class="p">)</code>
<code class="lineno">14</code>     <code class="n">script</code><code class="p">(</code><code class="n">src</code><code class="o">=</code><code class="err">'</code><code class="n">js</code><code class="o">/</code><code class="n">services</code><code class="p">.</code><code class="n">js</code><code class="err">'</code><code class="p">)</code>
<code class="lineno">15</code>     <code class="n">script</code><code class="p">(</code><code class="n">src</code><code class="o">=</code><code class="err">'</code><code class="n">js</code><code class="o">/</code><code class="n">controllers</code><code class="p">.</code><code class="n">js</code><code class="err">'</code><code class="p">)</code>
</pre></div>

</div>

<p>Now that we can actually render the initial layout we can get started with the client-side routing definition in <code>app.js</code></p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno"> 1</code> <code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">angular</code><code class="p">.</code><code class="nx">module</code><code class="p">(</code><code class="s1">'myApp'</code><code class="p">,</code> <code class="cp">[</code><code class="s2">"ngResource"</code><code class="cp">]</code><code class="p">).</code>
<code class="lineno"> 2</code>   <code class="nx">config</code><code class="p">(</code><code class="cp">[</code><code class="s1">'$routeProvider'</code><code class="p">,</code> <code class="s1">'$locationProvider'</code><code class="p">,</code>
<code class="lineno"> 3</code>     <code class="nx">function</code><code class="p">(</code><code class="nv">$routeProvider</code><code class="p">,</code> <code class="nv">$locationProvider</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno"> 4</code>       <code class="nv">$locationProvider.html5Mode</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
<code class="lineno"> 5</code>       <code class="nv">$routeProvider</code>
<code class="lineno"> 6</code>         <code class="bp">.</code><code class="nx">when</code><code class="p">(</code><code class="s2">"/contacts"</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno"> 7</code>           <code class="nx">templateUrl</code><code class="p">:</code> <code class="s2">"partials/index.jade"</code><code class="p">,</code>
<code class="lineno"> 8</code>           <code class="nx">controller</code><code class="p">:</code> <code class="s2">"ContactsIndexCtrl"</code> <code class="p">})</code>
<code class="lineno"> 9</code>         <code class="bp">.</code><code class="nx">when</code><code class="p">(</code><code class="s2">"/contacts/new"</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">10</code>           <code class="nx">templateUrl</code><code class="p">:</code> <code class="s2">"partials/edit.jade"</code><code class="p">,</code>
<code class="lineno">11</code>           <code class="nx">controller</code><code class="p">:</code> <code class="s2">"ContactsEditCtrl"</code> <code class="p">})</code>
<code class="lineno">12</code>         <code class="bp">.</code><code class="nx">when</code><code class="p">(</code><code class="s2">"/contacts/:id"</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">13</code>           <code class="nx">templateUrl</code><code class="p">:</code> <code class="s2">"partials/show.jade"</code><code class="p">,</code>
<code class="lineno">14</code>           <code class="nx">controller</code><code class="p">:</code> <code class="s2">"ContactsShowCtrl"</code> <code class="p">})</code>
<code class="lineno">15</code>         <code class="bp">.</code><code class="nx">when</code><code class="p">(</code><code class="s2">"/contacts/:id/edit"</code><code class="p">,</code> <code class="p">{</code>
<code class="lineno">16</code>           <code class="nx">templateUrl</code><code class="p">:</code> <code class="s2">"partials/edit.jade"</code><code class="p">,</code>
<code class="lineno">17</code>           <code class="nx">controller</code><code class="p">:</code> <code class="s2">"ContactsEditCtrl"</code> <code class="p">})</code>
<code class="lineno">18</code>         <code class="bp">.</code><code class="nx">otherwise</code><code class="p">({</code> <code class="nb">redirectTo</code><code class="p">:</code> <code class="s2">"/contacts"</code> <code class="p">});</code>
<code class="lineno">19</code>     <code class="p">}</code>
<code class="lineno">20</code>   <code class="cp">]</code>
<code class="lineno">21</code> <code class="p">);</code>
</pre></div>

</div>

<p>We define route definitions to list, show and edit contacts and use a set of partials and corresponding controllers. In order for the partials to get loaded correctly we need to add another express route in the backend which serves all these partials.</p>

<div class="code-block">
<div class="highlight"><pre><code class="lineno">1</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/partials/:name'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
<code class="lineno">2</code>   <code class="kd">var</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>
<code class="lineno">3</code>   <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'partials/'</code> <code class="o">+</code> <code class="nx">name</code><code class="p">);</code>
<code class="lineno">4</code> <code class="p">});</code>
</pre></div>

</div>

<p>It uses the name of the partial as an URL param and renders the partial with the given name from the <code>partial</code> directory. Keep in mind that you must define that route before the catch all route, otherwise it will not work.</p>

<p>You can find the complete example on <a href="https://github.com/fdietz/recipes-with-angular-js-examples/tree/master/chapter10/recipe1">github</a>.</p>

<h4 id="discussion-53">Discussion</h4>
<p>Compared to Rails the handling of partials is quite explicit by defining a route for partials. On the other hand it is quite nice to being able to use jade templates for our partials too.</p>
</div>
</body>
</html>
